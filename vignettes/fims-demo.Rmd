---
title: "Introducing the Fisheries Integrated Modeling System (FIMS)"
output: github_document
vignette: >
  %\VignetteIndexEntry{Introducing the Fisheries Integrated Modeling System (FIMS)}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Fisheries Integrated Modeling System
The NOAA Fisheries Integrated Modeling System (FIMS) is a new modeling framework for fisheries modeling. FIMS is a software system designed to support next-generation fisheries stock assessment, ecosystem, and socioeconomic modeling. It's important to note that FIMS itself is not a model, but rather a framework for creating models. The framework is made up of many modules that come together to create a model that best suits the needs of the end-user. What follows is a demo of creating a catch-at-age assessment model using FIMS. 

## Import Libraries and Clear Memory

To begin, we import the FIMS and TMB libraries. Calling `library(FIMS)` automatically loads the Rcpp functions and modules into the R environment. The function call `clear()` ensures C++ memory from any previous FIMS model run is cleared out.
```{r fims1, warning=FALSE, message=FALSE}
# automatically loads fims Rcpp module
library(FIMS)

# clear memory
clear()
```

## Set up Data and Parameters

Data and variable values are taken from the [Li et al.](https://www.doi.org/10.7755/FB.119.2-3.5) Model Comparison project ([github site](https://github.com/Bai-Li-NOAA/Age_Structured_Stock_Assessment_Model_Comparison)). See [R/data1.R](https://github.com/NOAA-FIMS/FIMS/blob/main/R/data1.R) and [tests/testthat/fixtures/simulate-integration-test-data.R](https://github.com/NOAA-FIMS/FIMS/blob/main/tests/testthat/fixtures/simulate-integration-test-data.R) for details on how data and variable values are read into FIMS from the Model Comparison project.

### Prepare Data using FIMSFrame

We will be reading data into the model using the FIMSFrame S4 R class set up in [R/fimsframe.R](https://github.com/NOAA-FIMS/FIMS/blob/main/R/fimsframe.R).

```{r prepare-fimsframe-data}
# use FIMS data frame
data("data1")
fims_frame <- FIMSFrame(data1)
```

The `fims_frame` object contains many slots (named components of the object that can be accessed), one of which stores a long data frame. To access this slot use the accessor function `get_data()` for all data used to fit the model:

```{r view-fimsframe-data}
str(fims_frame, max.level = 1)
get_data(fims_frame) |>
  dplyr::filter(type == "landings") |>
  utils::head()
get_data(fims_frame) |>
  dplyr::filter(type == "index") |>
  utils::head()
```

Using this data frame, we will start setting up the FIMS objects. This example from the Model Comparison project sets up a model that includes:

- A single fishery fleet with age composition and catch data
- A single survey with age composition data and an index

Data are read into FIMS as long vectors, regardless of their original dimension, hence the motivation behind the long data frames created with the fimsframe S4 classes. 

### Prepare Parameters using `create_default_parameters()`

Now that we've prepared the data, let's set up parameters for modules. Each module in the FIMS-R interface is made of reference classes. These reference classes serve as an interface between R and the underlining C++ code that defines FIMS. 

Here, we define specifications for fleets, recruitment, growth, and maturity modules. Using `create_default_parameters()`, we create default values for parameters from fleet, recruitment, growth, and maturity modules.
```{r, max.height='100px', attr.output='.numberLines'}
# Define fleet specifications for fleet1 and survey1
fleet1 <- survey1 <- list(
  selectivity = list(form = "LogisticSelectivity"),
  data_distribution = c(
    Index = "DlnormDistribution",
    AgeComp = "DmultinomDistribution",
    LengthComp = "DmultinomDistribution"
  )
)

# Create default parameters
default_parameters <- fims_frame |>
  create_default_parameters(
    fleets = list(fleet1 = fleet1, survey1 = survey1)
  )
```

create_default_parameters() includes default settings for recruitment, growth, and maturity modules. For example:

 - "BevertonHoltRecruitment" for the recruitment module
 - "DnormDistribution" for recruitment deviations (log_devs)
 - "EWAAgrowth" for the growth module 
 - "LogisticMaturity" for maturity module

The argument names and their corresponding default values of the create_default_parameters() function can be displayed using `args(FIMS::create_default_parameters)`.
```{r display-create-default-parameters-default-values}
args(FIMS::create_default_parameters)
```

We may update the default parameters to experiment with different values. Before modifying the parameter values, we can print the `default_parameters`, then modify a specific element or a list of elements. The dimensions of the updated elements should match the original dimensions from the `default_parameters`.

Here, we adjust fishing mortality, selectivity, maturity, and population parameters using `update_parameters()`. 
```{r modify-default-parameters}
parameters <- default_parameters |>
  update_parameters(
    modified_parameters = list(
      fleet1 = list(
        Fleet.log_Fmort.value = log(c(
          0.009459165, 0.027288858, 0.045063639,
          0.061017825, 0.048600752, 0.087420554,
          0.088447204, 0.186607929, 0.109008958,
          0.132704335, 0.150615473, 0.161242955,
          0.116640187, 0.169346119, 0.180191913,
          0.161240483, 0.314573212, 0.257247574,
          0.254887252, 0.251462108, 0.349101406,
          0.254107720, 0.418478117, 0.345721184,
          0.343685540, 0.314171227, 0.308026829,
          0.431745298, 0.328030899, 0.499675368
        ))
      )
    )
  ) |>
  update_parameters(
    modified_parameters = list(
      survey1 = list(
        LogisticSelectivity.inflection_point.value = 1.5,
        LogisticSelectivity.slope.value = 2,
        Fleet.log_q.value = log(3.315143e-07)
      )
    )
  ) |>
  update_parameters(
    modified_parameters = list(
      recruitment = list(
        BevertonHoltRecruitment.log_rzero.value = log(1e+06),
        BevertonHoltRecruitment.log_devs.value = c(
          0.43787763, -0.13299042, -0.43251973, 0.64861200, 0.50640852,
          -0.06958319, 0.30246260, -0.08257384, 0.20740372, 0.15289604,
          -0.21709207, -0.13320626, 0.11225374, -0.10650836, 0.26877132,
          0.24094126, -0.54480751, -0.23680557, -0.58483386, 0.30122785,
          0.21930545, -0.22281699, -0.51358369, 0.15740234, -0.53988240,
          -0.19556523, 0.20094360, 0.37248740, -0.07163145
        ),
        BevertonHoltRecruitment.log_devs.estimated = FALSE
      )
    )
  ) |>
  update_parameters(
    modified_parameters = list(
      maturity = list(
        LogisticMaturity.inflection_point.value = 2.25,
        LogisticMaturity.inflection_point.estimated = FALSE,
        LogisticMaturity.slope.value = 3,
        LogisticMaturity.slope.estimated = FALSE
      )
    )
  ) |>
  update_parameters(
    modified_parameters = list(
      population = list(
        Population.log_init_naa.value = c(
          13.80944, 13.60690, 13.40217, 13.19525, 12.98692, 12.77791,
          12.56862, 12.35922, 12.14979, 11.94034, 11.73088, 13.18755
        )
      )
    )
  )
```

## Initialize modules and fit the model

With data and parameters in place, we can now initialize modules using `initialize_fims()` and fit the model using `fit_fims()`.
```{r, max.height='100px', attr.output='.numberLines', fit-fims, eval = TRUE}
# Run the model without optimization to help ensure a viable model
test_fit <- parameters |>
  initialize_fims(data = fims_frame) |>
  fit_fims(optimize = FALSE)

# Run the  model with optimization
fit <- parameters |>
  initialize_fims(data = fims_frame) |>
  fit_fims(optimize = TRUE)

# Clear memory post-run
clear()

# Multiple fits with different parameter configurations are performed to explore sensitivity effects.
parameters_high_slope <- parameters |>
  update_parameters(
    modified_parameters = list(
      survey1 = list(
        LogisticSelectivity.slope.value = 3
      )
    )
  )

parameters_low_slope <- parameters |>
  update_parameters(
    modified_parameters = list(
      survey1 = list(
        LogisticSelectivity.slope.value = 1
      )
    )
  )

high_slope_fit <- parameters_high_slope |>
  initialize_fims(data = fims_frame) |>
  fit_fims(optimize = TRUE)

clear()

low_slope_fit <- parameters_low_slope |>
  initialize_fims(data = fims_frame) |>
  fit_fims(optimize = TRUE)

clear()

# Fitting models with only age or only length data
# Fitting With only age data
# Define fleet and survey with age-specific data distribution
fleet1 <- survey1 <- list(
  selectivity = list(form = "LogisticSelectivity"),
  data_distribution = c(
    Index = "DlnormDistribution",
    AgeComp = "DmultinomDistribution"
  )
)

# Create default parameters, update with modified values, initialize FIMS, 
# and fit the model
age_only_fit <- fims_frame |>
  create_default_parameters(
    fleets = list(fleet1 = fleet1, survey1 = survey1)
  ) |>
  update_parameters(modified_parameters = parameters$parameters) |>
  initialize_fims(data = fims_frame) |>
  fit_fims(optimize = TRUE)

clear()

# Fitting with only length data
# Define fleet and survey with length-specific data distribution
fleet1 <- survey1 <- list(
  selectivity = list(form = "LogisticSelectivity"),
  data_distribution = c(
    Index = "DlnormDistribution",
    LengthComp = "DmultinomDistribution"
  )
)

# Create default parameters, update with modified values, initialize FIMS, 
# and fit the model
length_only_fit <- fims_frame |>
  create_default_parameters(
    fleets = list(fleet1 = fleet1, survey1 = survey1)
  ) |>
  update_parameters(modified_parameters = parameters$parameters) |>
  initialize_fims(data = fims_frame) |>
  fit_fims(optimize = TRUE)

clear()
```

## Plotting Results

```{r plots, eval = TRUE}
library(ggplot2)
index_results <- data.frame(
  observed = m_index(fims_frame, "survey1"),
  expected = get_report(fit)[["exp_index"]][[2]]
)
print(index_results)

years <- get_start_year(fims_frame):get_end_year(fims_frame)

ggplot2::ggplot(index_results, ggplot2::aes(x = years, y = observed)) +
  ggplot2::geom_point() +
  ggplot2::xlab("Year") +
  ggplot2::ylab("Index (mt)") +
  ggplot2::geom_line(ggplot2::aes(x = years, y = expected), color = "blue") +
  ggplot2::theme_bw()

catch_results <- data.frame(
  observed = m_landings(fims_frame, fleet = "fleet1"),
  expected = get_report(fit)[["exp_index"]][[1]]
)
print(catch_results)

ggplot2::ggplot(catch_results, ggplot2::aes(x = years, y = observed)) +
  ggplot2::geom_point() +
  ggplot2::xlab("Year") +
  ggplot2::ylab("Index (mt)") +
  ggplot2::geom_line(ggplot2::aes(x = years, y = expected), color = "blue") +
  ggplot2::theme_bw()
```

```{r output}
# TODO: need to import libraries, working in progress?
# finalize(get_obj(fit), get_opt(fit))
# json_output <- get_output()
# writeLines(json_output, "output.json")
# recruitment_log <- get_log_module("information")
# substr(recruitment_log, 1, 100)

```
