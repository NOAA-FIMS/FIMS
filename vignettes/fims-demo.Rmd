---
title: "Introducing the Fisheries Integrated Modeling System (FIMS)"
output: github_document
vignette: >
  %\VignetteIndexEntry{Introducing the Fisheries Integrated Modeling System (FIMS)}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# library(dplyr)
```

## Fisheries Integrated Modeling System
The NOAA Fisheries Integrated Modeling System (FIMS) is a new modeling framework for fisheries modeling. FIMS is a software system designed and architected to support next-generation fisheries stock assessment, ecosystem, and socioeconomic modeling. It's important to note that FIMS itself is not a model, but rather a framework for creating models. The framework is made up of many modules that come together to create a "the best model" that suites the needs of the end-user. What follows is a demo of creating a catch-at-age assessment model using FIMS. 

## Import Libraries and Clear Memory
To begin, we import the FIMS and TMB libraries. Calling `library(FIMS)` automatically loads the Rcpp functions and modules into the R environment. The function call, `clear()`, ensures C++ memory from any previous fims model run is cleared out. 
```{r fims1, warning=FALSE, message=FALSE}
# automatically loads fims Rcpp module
library(FIMS)
library(TMB)

# clear memory
clear()
```

## Set up Data and Parameters
Data and variable values are taken from the [Li et. al.](https://spo.nmfs.noaa.gov/content/fishery-bulletin/comparison-4-primary-age-structured-stock-assessment-models-used-united) Model Comparison project ([github site](https://github.com/Bai-Li-NOAA/Age_Structured_Stock_Assessment_Model_Comparison)). See [R/data_mile1.R](https://github.com/NOAA-FIMS/FIMS/blob/main/R/data_mile1.R) and [tests/testthat/fixtures/simulate-integration-test-data.R](https://github.com/NOAA-FIMS/FIMS/blob/main/tests/testthat/fixtures/simulate-integration-test-data.R) for details on how data and variable values are read into FIMS from the Model Comparison project.

### Prepare Data using FIMSFrame
We will be reading data into the model using the FIMSFrame S4 R class set up in [R/fimsframe.R](https://github.com/NOAA-FIMS/FIMS/blob/main/R/fimsframe.R)

```{r prepare-fimsframe-data}
# use FIMS data frame
# data(package = "FIMS")
data("data_mile1")
fims_frame <- FIMSFrame(data_mile1)
```

The `fims_frame` object contains a `@data` slot that holds a long data frame with catch data for the fishery and index data for the survey:

```{r view-fimsframe-data}
str(fims_frame)
fims_frame@data |>
  dplyr::filter(type == "landings") |>
  utils::head()
fims_frame@data |>
  dplyr::filter(type == "index") |>
  utils::head()
```

Using this data frame, we will start setting up the FIMS objects. This example from the Model Comparison project sets up a single fishery fleet with age composition and catch data and a single survey with age composition data and an index. Data are read into FIMS as long vectors, regardless of their original dimension, hence the motivation behind the long data frames created with the fimsframe S4 classes. 

### Prepare Parameters using `create_default_parameters`
Now that we've prepared the data, let's set up parameters for modules. Each module in the FIMS-R interface is made of reference classes. These reference classes serve as an interface between R and the underlining C++ code that defines FIMS. 

Here, we define specifications for fleets, recruitment, growth, and maturity modules. Using `create_default_parameters`, we create default values for parameters from fleet, recruitment, growth, and maturity modules. 
```{r, max.height='100px', attr.output='.numberLines'}
# Define fleet specifications for fleet1 and survey1
fleet1 <- survey1 <- list(
  selectivity = list(form = "LogisticSelectivity"),
  data_distribution = c(
    Index = "TMBDlnormDistribution",
    AgeComp = "TMBDmultinomDistribution"
  )
)

# Create default parameters
default_parameters <- fims_frame |>
  create_default_parameters(
    fleets = list(fleet1 = fleet1, survey1 = survey1),
    recruitment = list(
      form = "BevertonHoltRecruitment",
      process_distribution = c(log_devs = "TMBDnormDistribution")
    ),
    growth = list(form = "EWAAgrowth"),
    maturity = list(form = "LogisticMaturity")
  )

# Convert default_parameters list to a JSON string for viewing
# default_parameters |>
#   jsonlite::toJSON() |>
#   jsonlite::prettify()
```
We may update default parameters to experiment with different parameter values. Here, we adjust fishing mortality, selectivity, maturity, and population parameters using `update_parameters()`.
```{r modify-default-parameters}
parameters <- default_parameters |>
  update_parameters(
    modified_parameters = list(
      fleet1 = list(
        Fleet.log_Fmort.value = log(c(
          0.009459165, 0.027288858, 0.045063639,
          0.061017825, 0.048600752, 0.087420554,
          0.088447204, 0.186607929, 0.109008958,
          0.132704335, 0.150615473, 0.161242955,
          0.116640187, 0.169346119, 0.180191913,
          0.161240483, 0.314573212, 0.257247574,
          0.254887252, 0.251462108, 0.349101406,
          0.254107720, 0.418478117, 0.345721184,
          0.343685540, 0.314171227, 0.308026829,
          0.431745298, 0.328030899, 0.499675368
        ))
      )
    )
  ) |>
  update_parameters(
    modified_parameters = list(
      survey1 = list(
        LogisticSelectivity.inflection_point.value = 1.5,
        LogisticSelectivity.slope.value = 2,
        Fleet.log_q.value = log(3.315143e-07)
      )
    )
  ) |>
  update_parameters(
    modified_parameters = list(
      recruitment = list(
        BevertonHoltRecruitment.log_rzero.value = log(1e+06),
        BevertonHoltRecruitment.log_devs.value = c(
          0.43787763, -0.13299042, -0.43251973, 0.64861200, 0.50640852,
          -0.06958319, 0.30246260, -0.08257384, 0.20740372, 0.15289604,
          -0.21709207, -0.13320626, 0.11225374, -0.10650836, 0.26877132,
          0.24094126, -0.54480751, -0.23680557, -0.58483386, 0.30122785,
          0.21930545, -0.22281699, -0.51358369, 0.15740234, -0.53988240,
          -0.19556523, 0.20094360, 0.37248740, -0.07163145
        ),
        BevertonHoltRecruitment.log_devs.estimated = FALSE
      )
    )
  ) |>
  update_parameters(
    modified_parameters = list(
      maturity = list(
        LogisticMaturity.inflection_point.value = 2.25,
        LogisticMaturity.inflection_point.estimated = FALSE,
        LogisticMaturity.slope.value = 3,
        LogisticMaturity.slope.estimated = FALSE
      )
    )
  ) |>
  update_parameters(
    modified_parameters = list(
      population = list(
        Population.log_init_naa.value = c(
          13.80944, 13.60690, 13.40217, 13.19525, 12.98692, 12.77791,
          12.56862, 12.35922, 12.14979, 11.94034, 11.73088, 13.18755
        )
      )
    )
  )
```

## Initialize modules and fit the model
With data and parameters in place, we can now initialize modules using `initialize_fims()` and fit the model using `fit_fimt()`.
```{r, max.height='100px', attr.output='.numberLines', fit-fims}
# Run the model without optimization to help ensure a viable model
test_fit <- parameters |>
  initialize_fims(data = fims_frame) |>
  (\(parameter_list) list(parameters = parameter_list, version = "FIMS run without optimization"))() |>
  fit_fims(optimize = FALSE)

# Run the  model with optimization
fit <- parameters |>
  initialize_fims(data = fims_frame) |>
  (\(parameter_list) list(parameters = parameter_list, version = "FIMS run with optimization"))() |>
  fit_fims(optimize = TRUE)

# Clear memory post-run
clear()

parameters2 <- parameters |>
  update_parameters(
    modified_parameters = list(
      survey1 = list(
        LogisticSelectivity.slope.value = 3
      )
    )
  )

parameters3 <- parameters |>
  update_parameters(
    modified_parameters = list(
      survey1 = list(
        LogisticSelectivity.slope.value = 1
      )
    )
  )

fit2 <- parameters2 |>
  initialize_fims(data = fims_frame) |>
  (\(parameter_list) list(parameters = parameter_list, version = "FIMS run with optimization"))() |>
  fit_fims(optimize = TRUE)

clear()

fit3 <- parameters3 |>
  initialize_fims(data = fims_frame) |>
  (\(parameter_list) list(parameters = parameter_list, version = "FIMS run with optimization"))() |>
  fit_fims(optimize = TRUE)

clear()

```

## Plotting Results
```{r plots}
library(ggplot2)
index_results <- data.frame(
  observed = FIMS::m_index(fims_frame, "survey1"),
  expected = fit@report[["exp_index"]][[2]]
)
print(index_results)

years <- fims_frame@start_year:fims_frame@end_year

ggplot(index_results, aes(x = years, y = observed)) +
  geom_point() +
  xlab("Year") +
  ylab("Index (mt)") +
  geom_line(aes(x = years, y = expected), color = "blue") +
  theme_bw()

catch_results <- data.frame(
  observed = FIMS::m_landings(fims_frame),
  expected = fit@report[["exp_index"]][[1]]
)
print(catch_results)

ggplot(catch_results, aes(x = years, y = observed)) +
  geom_point() +
  xlab("Year") +
  ylab("Index (mt)") +
  geom_line(aes(x = years, y = expected), color = "blue") +
  theme_bw()
```

```{r output}
# TODO: need to import libraries, working in progress?
# finalize(fit@obj, fit@opt)
# json_output <- get_output()
# writeLines(json_output, "output.json")
# recruitment_log <- get_log_module("information")
# cat(recruitment_log)
```
