---
title: "FIMS User Setup Guide"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{FIMS User Setup Guide}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, functions, include=FALSE}
# Helper function to extract remote markdown from FIMS .devcontainer/ README to reuse the materials
extract_remote_markdown <- function(url, header_pattern) {
  lines <- try(readLines(url, warn = FALSE), silent = TRUE)
  tmp <- tempfile(fileext = ".md")
  
  if (inherits(lines, "try-error")) {
    writeLines("_Documentation temporarily unreachable._", tmp)
    return(tmp)
  }
  
  # Find the starting line (e.g., the line containing "## WSL2")
  start_idx <- grep(header_pattern, lines, ignore.case = TRUE)
  
  if (length(start_idx) > 0) {
    # Determine the level of the header found (count the # symbols)
    header_line <- lines[start_idx]
    header_level <- nchar(gsub("(^#+).*", "\\1", header_line))
    
    # Find headers that are at the SAME level or HIGHER (fewer or equal #)
    # We want to ignore ### if we are looking for a ## section
    stop_pattern <- paste0("^#{1,", header_level, "} ")
    all_potential_stops <- grep(stop_pattern, lines)
    
    # The end index is the next header that isn't the current one
    end_idx <- all_potential_stops[all_potential_stops > start_idx][1]
    
    if (is.na(end_idx)) end_idx <- length(lines) else end_idx <- end_idx - 1
    
    # Extract and add blank lines for proper RMarkdown list rendering
    content <- c("", lines[(start_idx + 1):end_idx], "") 
    writeLines(content, tmp)
  } else {
    writeLines("_Section not found in remote documentation._", tmp)
  }
  
  return(tmp)
}
```

## Overview

This guide facilitates the configuration of a standardized Fisheries Integrated Modeling System (FIMS) environment. By utilizing cloud-based workstations and containerized development environments, we ensure cross-platform consistency and eliminate the complexities of manual dependency management.

Please follow the section below that matches how you plan to set up FIMS, i.e., ‚òÅÔ∏è[Google Cloud Workstations](#google-cloud-workstations) for managed cloud IDEs (internal NOAA), üåê[GitHub Codespaces](#github-codespaces) for browser-based containerized environments, üêß[Windows Subsystem for Linux 2 (WSL2)](#wsl2) for a containerized Linux environment running on Windows hardware, and üßë‚Äçüíª[Native Local](#native-local) installation for direct deployment on your machine's primary operating system.

```{r common-setup, echo=FALSE}
# The bash script for setting up FIMS
common_script <- "bash <(curl -sL https://raw.githubusercontent.com/NOAA-FIMS/FIMS/main/setup_fims.sh)"

# Fetch the remote R script for the data bucket example
readwrite_databucket_url <- "https://raw.githubusercontent.com/nmfs-opensci/CloudComputingSetup/refs/heads/main/R/readwrite_databucket.R"
readwrite_databucket_script <- tryCatch(
  readLines(readwrite_databucket_url, warn = FALSE),
  error = function(e) "# Could not load remote script."
)

# Fetch the remote terminal script for mounting a data bucket
mount_bucket_url <- "https://raw.githubusercontent.com/nmfs-opensci/CloudComputingSetup/refs/heads/main/R/mount_bucket.R"
mount_bucket_script <- tryCatch(
  readLines(mount_bucket_url, warn = FALSE),
  error = function(e) "# Could not load remote script."
)
```

## ‚òÅÔ∏è Google Cloud Workstations

NOAA Fisheries Google Cloud Workstations provide a managed RStudio, Visual Studio Code (VS Code), or Positron environment. For detailed visual guides (e.g., snapshots) on starting, stopping, or managing workstations, please refer to the [Internal NOAA documentation](https://docs.google.com/document/d/1nziPdPULoRWOYQ9WKzISNUgJvANACvfYpFr1z3Ro2Bc/edit?tab=t.0#heading=h.5509095bxzv7).

- Navigate to the NOAA Fisheries [Google Cloud Workstations Console](https://console.cloud.google.com/workstations/list?project=ggn-nmfs-wsent-prod-1)  and click `+ create workstation`.

- Provide a name for the workstation, select a configuration, and click the `Create` button.

> **Note:** Use `posit-medium` or `posit-large` for workshops and rapid testing. It has faster startup times, though it carries higher cost due the Posit licensing fees. Select `nmfs-rstudio-medium` or `nmfs-rstudio-large` for long-term use as they avoid third-party licensing cost. Configurations (`*-small`) with low core counts will lead to failed compilation of FIMS.
  
- Click the `Start` and `Launch` buttons to initialize the workstation.

- Add a new session from either `Positron Pro`, `RStudio Pro`, or `VS Code` when using `posit-*` configurations, and then `Launch` the session.

- Open a bash terminal within your session and execute the following command to install all necessary system and R dependencies.

```{r, echo=FALSE, results='asis'}
cat("```bash\n")
cat(common_script, sep = "\n")
cat("\n```")
```

> **Note:** The process typically takes 15 to 30 minutes. If using `Positron Pro`, a restart of the R session is required to initialize the new libraries. Please run `library(FIMS)` in the R session to confirm the successful installation of FIMS.

<details>
<summary>ü§ø Deep dive: R code to read/wrote to Google Cloud Storage Buckets (Click to expand)</summary>

To read/write data to a Google Cloud Storage Bucket, use the R example from `nmfs-opensci/CloudComputingSetup`:
```{r, echo=FALSE, results='asis'}
# Wrap the script in markdown backticks manually
cat("```r\n")
cat(readwrite_databucket_script, sep = "\n")
cat("\n```")
```

</details>

<details>
<summary>ü§ø Deep dive: Terminal code for mounting Google Cloud Storage Buckets (Click to expand)</summary>

To mount a Google Cloud Storage Bucket to a Google Cloud Workstation, use the R example from `nmfs-opensci/CloudComputingSetup`:
```{r, echo=FALSE, results='asis'}
# Wrap the script in markdown backticks manually
cat("```bash\n")
cat(mount_bucket_script, sep = "\n")
cat("\n```")
```

</details>

<details>
<summary> üóÇÔ∏è Resources (Click to expand)</summary>

- [NOAA Fisheries Cloud Program](https://docs.google.com/document/d/1nziPdPULoRWOYQ9WKzISNUgJvANACvfYpFr1z3Ro2Bc/edit?usp=sharing) began a Cloud Compute Accelerator Pilot in early 2025: Enhancing NOAA Fisheries' Mission with Google Cloud Workstations. 

- Consult the Pilot Participant [Frequently Asked Questions](https://docs.google.com/document/d/1U1PzGS7G70xsXtD6F6WxkjTSCw7bwNVyZ-YnFyOLOqU/edit?usp=sharing) for support regarding access and billing.

- [NOAA Fisheries Cloud Computing Setup repository](https://github.com/nmfs-opensci/CloudComputingSetup/) details cloud computing resources at NOAA Fisheries, with a focus on Google Cloud Workstations for R users. It includes instructions for linking workstations to GitHub and mounting Google Cloud Storage buckets.

</details>

## üåê GitHub Codespaces

GitHub Codespaces offers a "container-as-a-service" model that provides a pre-configured FIMS environment directly in your browser. 

```{r, fetch-codespaces, include=FALSE}
# Define the target URL
base_url <- "https://raw.githubusercontent.com/NOAA-FIMS/FIMS/refs/heads/add-google-cloud-workstations-bash/.devcontainer/README.md"
tmp_codespaces <- extract_remote_markdown(base_url, "## .*GitHub Codespaces")
```

```{r, render-codespaces, child=tmp_codespaces}
```
## üêß WSL2

For Windows users who prefer local execution of the FIMS user container, we recommend using WSL2 in conjunction with Docker Engine.

```{r, fetch-wsl2, include=FALSE}
tmp_wsl2 <- extract_remote_markdown(base_url, "## .*WSL2")
```

```{r, render-wsl2, child=tmp_wsl2}
```

## üßë‚Äçüíª Native Local

Users wishing to install FIMS directly on their host operating system (macOS, Linux, or Windows) can do so using the `setup_fims.sh` bash script. To install, execute the following command in the bash terminal:

```{r, echo=FALSE, results='asis'}
cat("```bash\n")
cat(common_script, sep = "\n")
cat("\n```")
```

**Note:** For Windows users, Git Bash is required. If you are using RStudio on Windows, make sure the terminal is configured to use Git Bash. You can do this by going to **Tools** -> **Global Options...** -> **Terminal**, and selecting **Git Bash** under **New terminals open with:**.

## üôã Need Help?
- If the instructions above do not work, please visit the FIMS [discussion page](https://github.com/orgs/NOAA-FIMS/discussions/1073) to see known issues and documented solutions. If you encounter a new error, feel free to post it there for technical assistance. 
- To report errors discrepancies in this guide, please [open an issue](https://github.com/NOAA-FIMS/FIMS/issues) on GitHub.
