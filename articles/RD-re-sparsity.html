<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>RE Sparsity • FIMS</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="RE Sparsity">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100..900&amp;display=swap" rel="stylesheet">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">
    <img class="navlogo" src="https://noaa-fims.github.io/images/FIMS_logo3.png" width="60" align="left"><a class="navbar-brand me-2" href="../index.html">FIMS</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.8.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://github.com/NOAA-FIMS/FIMS/releases/latest">Latest release</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-reports" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Reports</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-reports">
<li><a class="dropdown-item" href="../coverage/coverage.html">coverage</a></li>
    <li><a class="dropdown-item" href="../coverage/codecoverage_explanation.html">coverage explained</a></li>
    <li><a class="dropdown-item" href="../testdown/index.html">testdown</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://noaa-fims.github.io/">fims website</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/noaa-fims/fims/" aria-label="GitHub repository for FIMS"><span class="fa fa-brands fa-github fa-lg"></span></a></li>
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>RE Sparsity</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/noaa-fims/fims/blob/main/vignettes/RD-re-sparsity.Rmd" class="external-link"><code>vignettes/RD-re-sparsity.Rmd</code></a></small>
      <div class="d-none name"><code>RD-re-sparsity.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Many stock assessment models in the U.S.A. have historically used a
hierarchical approach when estimating time-varying process variability
in model parameters such as recruitment. In this approach a mean
parameter value
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>P</mi><mo accent="true">̃</mo></mover><annotation encoding="application/x-tex">\tilde{P}</annotation></semantics></math>,
and annual deviation values,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mi>d</mi><mi>e</mi><msub><mi>v</mi><mi>y</mi></msub></mrow><annotation encoding="application/x-tex">Pdev_{y}</annotation></semantics></math>,
are estimated and combined to produce annual parameter estimates
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>P</mi><mi>y</mi></msub><annotation encoding="application/x-tex">P_{y}</annotation></semantics></math>
with deviations often being additive or multiplicative of the mean.
Models utilizing this approach have predominantly implemented deviations
as estimated fixed effects. In several tools, such as Stock Synthesis,
sum to zero constraints have been applied to ensure that Hessian
matrices are positive definite. A fixed-effect vector of deviation
parameters does not require second order partial derivatives to be
estimated until model optimization is complete and variance is
estimated.</p>
<p>Following statistical best practices, FIMS incorporates the use of
random effects to model process variability in time-varying parameters.
Uncertainty in the random effects is integrated out during parameter
optimization in TMB using the Laplace approximation. This integration
requires the calculation of second-order partial derivatives and
inversion of the Hessian at each optimization step. While simple to
interpret and implement, the deviations approach results in a dense
covariance matrix of correlations between the mean
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>P</mi><mo accent="true">̃</mo></mover><annotation encoding="application/x-tex">\tilde{P}</annotation></semantics></math>
and each annual deviation
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mi>d</mi><mi>e</mi><msub><mi>v</mi><mi>y</mi></msub></mrow><annotation encoding="application/x-tex">Pdev_{y}</annotation></semantics></math>
estimate. Due to this difference, using the deviations approach in a
random effects model has a much larger computational penalty than when
only fixed effects were considered in historic modeling platforms.</p>
<p>To quantify the magnitude of this penalty we investigate the
performance and optimization time of a simple random effects model under
equivalent sparse vs dense parameterizations. For this example we
utilize two simple proxy models; an auto regressive AR1 function and a
simple stock assessment model based on <a href="https://github.com/fishfollower/SAM/tree/master/stockassessment" class="external-link">babySAM</a>.
These proxies should reflect the relative performance gains expected in
the real-world correlated time-varying processes modeled in stock
assessments such as recruitment. Each of these time-series models can be
parameterized as a dense matrix, representing the traditional parameter
deviations as a random-effects approach, or as a sparse matrix, as would
be achieved by directly estimating annual parameter values as random
effects.</p>
<p>These two approaches are anticipated to produce mathematically
equivalent results while differing in their computational overhead.
Confirming this equivalency and quantifying the runtime improvement will
provide support for the change in approach relative to previous
assessment models.</p>
</div>
<div class="section level2">
<h2 id="methods">Methods<a class="anchor" aria-label="anchor" href="#methods"></a>
</h2>
<div class="section level3">
<h3 id="time-series-model">Time-series model<a class="anchor" aria-label="anchor" href="#time-series-model"></a>
</h3>
<p>We evaluated a simple time-series model where the latent state,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>λ</mi><mi>t</mi></msub><annotation encoding="application/x-tex">\lambda_{t}</annotation></semantics></math>,
at time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>
follows an AR1 process defined as:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mi>t</mi></msub><mo>=</mo><mi>ϕ</mi><mo>*</mo><msub><mi>λ</mi><mrow><mi>t</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>+</mo><msub><mi>ϵ</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">\lambda_{t} = \phi * \lambda_{t-1} + \epsilon_{t}</annotation></semantics></math>,
using two parameterizations:</p>
<ol style="list-style-type: decimal">
<li>process approach:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mi>t</mi></msub><mo>∼</mo><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>ϕ</mi><mo>*</mo><msub><mi>λ</mi><mrow><mi>t</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>,</mo><msubsup><mi>σ</mi><mi>λ</mi><mn>2</mn></msubsup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\lambda_{t} \sim N(\phi * \lambda_{t-1}, \sigma^{2}_{\lambda})</annotation></semantics></math>
</li>
<li>deviations approach:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mi>t</mi></msub><mo>=</mo><mi>ϕ</mi><mo>*</mo><msub><mi>λ</mi><mrow><mi>t</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>+</mo><mi>σ</mi><mo>*</mo><msub><mi>z</mi><mi>t</mi></msub><mo>,</mo><msub><mi>z</mi><mi>t</mi></msub><mo>∼</mo><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\lambda_{t} = \phi * \lambda_{t-1} + \sigma * z_{t}, z_{t} \sim N(0,1)</annotation></semantics></math>
</li>
</ol>
<ul>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ϕ</mi><annotation encoding="application/x-tex">\phi</annotation></semantics></math>
is the autoregressive coefficient, transformed as:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϕ</mi><mo>=</mo><mn>2</mn><mo>*</mo><mtext mathvariant="normal">plogis</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mtext mathvariant="normal">phiTrans</mtext><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">
\phi=2*\text{plogis}(\text{phiTrans})-1
</annotation></semantics></math> which ensures
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ϕ</mi><annotation encoding="application/x-tex">\phi</annotation></semantics></math>
remains in the range (-1,1).</p></li>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>σ</mi><annotation encoding="application/x-tex">\sigma</annotation></semantics></math>
is the process standard deviation.</p></li>
<li><p>The stationary variance of the process is:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">Var</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mi>γ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mfrac><msup><mi>σ</mi><mn>2</mn></msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><msup><mi>ϕ</mi><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">
\text{Var}(\gamma)=\frac{\sigma^2}{(1-\phi^2)}
</annotation></semantics></math></p></li>
</ul>
<p>Under a random-effects model, the process approach puts the random
effect on
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>λ</mi><mi>t</mi></msub><annotation encoding="application/x-tex">\lambda_{t}</annotation></semantics></math>,
while in the deviations approach, the random effect is applied to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>z</mi><mi>t</mi></msub><annotation encoding="application/x-tex">z_{t}</annotation></semantics></math>.
Though we use the process and deviations terminology to contrast these
approaches, the statistical literature often refers to these as centered
and non-centered parameterizations, respectively (Stan User’s Guide
2025; Reparameterization and Change of Variables). The joint negative
log likelihood for this process is computed in state-space form where
the process of the current time step is dependent on the previous one
and observations,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>y</mi><annotation encoding="application/x-tex">y</annotation></semantics></math>
are <em>iid</em> Normal:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># deviations approach</span></span>
<span><span class="va">nll</span> <span class="op">&lt;-</span> <span class="va">nll</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">z</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">sd</span> <span class="op">*</span> <span class="va">sd</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">phi</span> <span class="op">*</span> <span class="va">phi</span><span class="op">)</span><span class="op">)</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">nll</span> <span class="op">&lt;-</span> <span class="va">nll</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">z</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>, <span class="fl">0</span>, <span class="va">sd</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">lamda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">lamda</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">z</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">timeSteps</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">lamda</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">phi</span> <span class="op">*</span> <span class="va">lamda</span><span class="op">[</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">z</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span><span class="va">nll</span> <span class="op">&lt;-</span> <span class="va">nll</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">lamda</span>, <span class="va">sdo</span>, <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># process approach</span></span>
<span><span class="va">nll</span> <span class="op">&lt;-</span> <span class="va">nll</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">sd</span> <span class="op">*</span> <span class="va">sd</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">phi</span> <span class="op">*</span> <span class="va">phi</span><span class="op">)</span><span class="op">)</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">nll</span> <span class="op">&lt;-</span> <span class="va">nll</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>, <span class="va">phi</span> <span class="op">*</span> <span class="va">lambda</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">)</span><span class="op">]</span>, <span class="va">sd</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">nll</span> <span class="op">&lt;-</span> <span class="va">nll</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">lambda</span>, <span class="va">sdo</span>, <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Under this formulation, the process approach results in a sparse
Hessian which is a function of the inverted covariance matrix, while the
deviations approach results in a dense Hessian (Fig 1). Models were
evaluated with RTMB (Kristensen, 2019) using the TMB package (Kristensen
et al., 2016) in R (R Core Team, 2024). TMB relies on the Laplace
approximation to integrate out random effects during an inner
optimization step, and afterwards, the joint negative log likelihood is
minimized with respect to the fixed effects. The Laplace approximation
requires up to the second-order partial derivatives of the joint
negative log likelihood with respect to the random effects to be
evaluated at each inner optimization step. The computation cost of the
Laplace approximation is primarily determined by the cost of inverting
the Hessian, which is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>N</mi><mn>3</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">O(N^3)</annotation></semantics></math>
for N-dimensional parameter space. As the number of random effects
increases, the computational cost of inverting the dense Hessian from
the deviations approach increases rapidly, while the cost of inverting
the sparse Hessian from the process approach increases much more
slowly.</p>
<p><img src="figures/ar1hess_deviations.jpg"><img src="figures/ar1hess_process.jpg"><strong>Figure 1.</strong> Hessian
matrix for a first-order autoregressive (AR1) process using deviations
approach (top) and process approach (bottom).</p>
</div>
<div class="section level3">
<h3 id="catch-at-age-model">Catch-at-age model<a class="anchor" aria-label="anchor" href="#catch-at-age-model"></a>
</h3>
<p>We compared the deviation and process approaches in a simple
catch-at-age stock assessment model by extending an RTMB version of SAM,
originally written by Anders Nielsen. The SAM model structures
recruitment, numbers at age, and fishing mortality as AR1 processes.</p>
<p>The case study is built off of an existing SAM model and the data
list (<code>dat</code>) can be updated for RTMB as follows</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/kaskr/RTMB" class="external-link">RTMB</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">stockassessment</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jabiru/tictoc" class="external-link">tictoc</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="st">"../fit.RData"</span><span class="op">)</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">logobs</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">logobs</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">aux</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">aux</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">idx1</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">idx1</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">idx2</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">idx2</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">minYear</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span><span class="op">)</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">minAge</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">minAgePerFleet</span><span class="op">)</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">fleetTypes</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">fleetTypes</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">sampleTimes</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">sampleTimes</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">year</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">years</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">age</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">minAgePerFleet</span><span class="op">)</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">maxAgePerFleet</span><span class="op">)</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">M</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">natMor</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">SW</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">stockMeanWeight</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">MO</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">propMat</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">PF</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">propF</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">PM</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">propM</span></span>
<span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">srmode</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">fcormode</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">keyF</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">conf</span><span class="op">$</span><span class="va">keyLogFsta</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">keyQ</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">conf</span><span class="op">$</span><span class="va">keyLogFpar</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">keySd</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">conf</span><span class="op">$</span><span class="va">keyVarObs</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">keySd</span><span class="op">[</span><span class="va">dat</span><span class="op">$</span><span class="va">keySd</span> <span class="op">&lt;</span> <span class="op">(</span><span class="op">-</span><span class="fl">.1</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">covType</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">keyIGAR</span> <span class="op">&lt;-</span> <span class="va">fit</span><span class="op">$</span><span class="va">conf</span><span class="op">$</span><span class="va">keyCorObs</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">keyIGAR</span><span class="op">[</span><span class="va">fit</span><span class="op">$</span><span class="va">conf</span><span class="op">$</span><span class="va">keyCorObs</span> <span class="op">==</span> <span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">keyIGAR</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">conf</span><span class="op">$</span><span class="va">keyCorObs</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">1</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">keyIGAR</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">noParUS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span></span>
<span>  <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">fleetTypes</span><span class="op">)</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">f</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">keySd</span><span class="op">[</span><span class="va">f</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">covType</span><span class="op">[</span><span class="va">f</span><span class="op">]</span> <span class="op">==</span> <span class="fl">2</span>, <span class="op">(</span><span class="va">A</span> <span class="op">*</span> <span class="va">A</span> <span class="op">-</span> <span class="va">A</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="section level4">
<h4 id="parameters">Parameters<a class="anchor" aria-label="anchor" href="#parameters"></a>
</h4>
<p>We modified the model to structure recruitment under both the
deviation and process approaches. The main structure for recruitment for
years 2 and greater was applied to the numbers-at-age parameter,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>N</mi><mrow><mi>y</mi><mo>,</mo><mi>a</mi><mo>=</mo><mn>1</mn></mrow></msub><annotation encoding="application/x-tex">N_{y, a=1}</annotation></semantics></math>
for year
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>y</mi><annotation encoding="application/x-tex">y</annotation></semantics></math>
and for age 1 with mean recruitment
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>r</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\hat{r}</annotation></semantics></math>,
written as the following:</p>
<ol style="list-style-type: decimal">
<li>deviations approach:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>o</mi><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>N</mi><mrow><mi>y</mi><mo>,</mo><mn>1</mn></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mover><mi>r</mi><mo accent="true">̂</mo></mover><mo>+</mo><msub><mi>z</mi><mi>y</mi></msub><mo>,</mo><mspace width="1.0em"></mspace><mi>w</mi><mi>h</mi><mi>e</mi><mi>r</mi><mi>e</mi><mspace width="1.0em"></mspace><msub><mi>z</mi><mi>y</mi></msub><mo>∼</mo><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>z</mi><mrow><mi>y</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>,</mo><msubsup><mi>σ</mi><mi>r</mi><mn>2</mn></msubsup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">log(N_{y,1}) = \hat{r} + z_{y}, \quad where \quad z_{y} \sim N(z_{y-1},\sigma^{2}_{r})</annotation></semantics></math>
</li>
<li>process approach:
log(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mrow><mi>N</mi><mrow><mi>y</mi><mo>,</mo><mn>1</mn></mrow></mrow><mo accent="true">̂</mo></mover><mo stretchy="false" form="postfix">)</mo><mo>=</mo><mi>l</mi><mi>o</mi><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>N</mi><mrow><mi>y</mi><mo>−</mo><mn>1</mn><mo>,</mo><mn>1</mn></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><mspace width="1.0em"></mspace><mi>w</mi><mi>h</mi><mi>e</mi><mi>r</mi><mi>e</mi><mspace width="1.0em"></mspace><mi>l</mi><mi>o</mi><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>N</mi><mrow><mi>y</mi><mo>,</mo><mn>1</mn></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>∼</mo><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mover><mi>r</mi><mo accent="true">̂</mo></mover><mo>+</mo><mi>ϕ</mi><mo>*</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>l</mi><mi>o</mi><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mover><msub><mi>N</mi><mrow><mi>y</mi><mo>−</mo><mn>1</mn><mo>,</mo><mn>1</mn></mrow></msub><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><mover><mi>r</mi><mo accent="true">̂</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\widehat{N{y,1}}) = log(N_{y-1, 1}), \quad where \quad log(N_{y, 1}) \sim N(\hat{r} + \phi*(log(\widehat{N_{y-1,1}}) - \hat{r}))</annotation></semantics></math>
</li>
</ol>
<p>The parameters estimated in the RTMB code appear below; the
parameters that matter most between implementations of the deviations
and process approaches of recruitment deviations are the last two
(<code>z</code> and <code>mean_recruitment</code>).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Parameter section</span></span>
<span><span class="va">par</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">par</span><span class="op">$</span><span class="va">logsdR</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">par</span><span class="op">$</span><span class="va">logsdS</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">par</span><span class="op">$</span><span class="va">logsdF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">keyF</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">par</span><span class="op">$</span><span class="va">rickerpar</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">srmode</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">par</span><span class="op">$</span><span class="va">transRhoF</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">fcormode</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="fl">0.1</span></span>
<span><span class="op">}</span></span>
<span><span class="va">par</span><span class="op">$</span><span class="va">bhpar</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">srmode</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">par</span><span class="op">$</span><span class="va">logQ</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">keyQ</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">par</span><span class="op">$</span><span class="va">logsd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">keySd</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">par</span><span class="op">$</span><span class="va">logIGARdist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">keyIGAR</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">par</span><span class="op">$</span><span class="va">parUS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">noParUS</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">par</span><span class="op">$</span><span class="va">logN</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">year</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">age</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">par</span><span class="op">$</span><span class="va">logF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">year</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">keyF</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">par</span><span class="op">$</span><span class="va">missing</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">logobs</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">par</span><span class="op">$</span><span class="va">tPhi</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="co"># AR phi for recruitment</span></span>
<span><span class="va">par</span><span class="op">$</span><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">year</span><span class="op">)</span><span class="op">)</span> <span class="co"># Standard normal innovations</span></span>
<span><span class="va">par</span><span class="op">$</span><span class="va">mean_recruitment</span> <span class="op">&lt;-</span> <span class="fl">0</span> <span class="co"># mapped off if not estimated</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="code">Code<a class="anchor" aria-label="anchor" href="#code"></a>
</h4>
<p>The joint negative log likelihood for recruitment under each approach
was computed using the state space form as:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># deviations approach</span></span>
<span><span class="co"># AR1 for standard normal innovations at initial condition</span></span>
<span><span class="va">jnll</span> <span class="op">&lt;-</span> <span class="va">jnll</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">z</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">sdR</span> <span class="op">*</span> <span class="va">sdR</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">phi</span> <span class="op">*</span> <span class="va">phi</span><span class="op">)</span><span class="op">)</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># AR1 standard normal innovations for remaining years</span></span>
<span><span class="va">jnll</span> <span class="op">&lt;-</span> <span class="va">jnll</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">z</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>, <span class="fl">0</span>, <span class="va">sdR</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># transform innovations (z) to get recruitment deviations</span></span>
<span><span class="va">rec_dev</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">nrow</span><span class="op">)</span></span>
<span><span class="va">rec_dev</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">z</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="co"># initial condition</span></span>
<span><span class="co"># Set recruitment as random walk + transformed deviations</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">y</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">nrow</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">rec_dev</span><span class="op">[</span><span class="va">y</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">phi</span> <span class="op">*</span> <span class="va">rec_dev</span><span class="op">[</span><span class="va">y</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">z</span><span class="op">[</span><span class="va">y</span><span class="op">]</span></span>
<span>  <span class="co"># Random walk with optional intercept</span></span>
<span>  <span class="va">logN</span><span class="op">[</span><span class="va">y</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">mean_recruitment</span> <span class="op">+</span> <span class="va">rec_dev</span><span class="op">[</span><span class="va">y</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># process approach</span></span>
<span><span class="co"># AR1 initial conditions</span></span>
<span><span class="va">jnll</span> <span class="op">&lt;-</span> <span class="va">jnll</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">logN</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">]</span>, <span class="va">mean_recruitment</span>, <span class="va">sdR</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">phi</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># remaining time series</span></span>
<span><span class="va">jnll</span> <span class="op">&lt;-</span> <span class="va">jnll</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">logN</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">]</span>, <span class="va">mean_recruitment</span> <span class="op">+</span> <span class="va">phi</span> <span class="op">*</span> <span class="op">(</span><span class="va">logN</span><span class="op">[</span><span class="op">-</span><span class="va">nrow</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">mean_recruitment</span><span class="op">)</span>, <span class="va">sdR</span>, <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Catch-at-age models compared recruitment with the mean recruitment
estimated versus fixed at zero to compare model parameterizations common
in Europe (fixed) and the U.S.A. (estimated) to ensure the inclusion of
the mean recruitment parameter did not influence the sparsity of the
Hessian. In the context of European models, mean recruitment is not zero
neither is it estimated. Rather, the initial recruitment is estimated
using a large variance term and subsequent recruitment values are a
function of the previous time step. Mean recruitment can then be derived
as the mean of the recruitment time series.</p>
<p>We ran a speed test by repeating model runs on the catch-at-age model
25 times, each time modifying the observation variance parameter using
random noise from a normal distribution with standard deviation of 0.03.
We compared computational times from the speed test and compared
parameter estimates, including recruitment from the first model run.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="results">Results<a class="anchor" aria-label="anchor" href="#results"></a>
</h2>
<p>For each group of models (AR1 and catch-at-age with and without the
fixed effect recruitment mean), we can compare models with the
deviations and process parameterization. We compared (1) likelihoods,
(2) means of fixed-effect parameters, (3) variances of fixed-effect
parameter, and (4) estimated mean and variances of recruitment
deviations. For all comparisons, we found parameters to be perfectly
correlated between the deviations and process approaches.</p>
<p>The process approach resulted in a sparse Hessian while the
deviations approach resulted in a Hessian that was dense in recruitment
(Fig. 2). Results from the speed test indicated the process approach was
approximately 2x times faster than the deviations approach both with and
without an estimated intercept (Table 1). While speed up for a single
AR1 process is minimal, more complex stock assessments currently include
AR1 random effects in multiple processes (e.g., numbers at age,
maturity, mortality, etc.). The computational cost of fitting the
deviations approach scales significantly, warranting the need to adopt
the more computationally efficient process parameterization when
estimating AR1 processes as random effects.</p>
<p><strong>Table 1.</strong> Results from speed test (in seconds) from
running models 25 times. The standard deviation (SD), minimum (Min), and
maximum (Max) of the run times are also shown. Note that absolute
results are machine dependent but relative results will be consistent
across operating systems and machine specifications.</p>
<table class="table">
<thead><tr class="header">
<th>Intercept</th>
<th>Model</th>
<th>Mean time (sec)</th>
<th>SD</th>
<th>Min</th>
<th>Max</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Y</td>
<td>process</td>
<td>1.381</td>
<td>0.642</td>
<td>0.957</td>
<td>3.635</td>
</tr>
<tr class="even">
<td>N</td>
<td>process</td>
<td>1.561</td>
<td>0.620</td>
<td>1.163</td>
<td>4.473</td>
</tr>
<tr class="odd">
<td>Y</td>
<td>deviations</td>
<td>2.976</td>
<td>1.695</td>
<td>2.070</td>
<td>9.903</td>
</tr>
<tr class="even">
<td>N</td>
<td>deviations</td>
<td>3.372</td>
<td>1.324</td>
<td>2.614</td>
<td>9.613</td>
</tr>
</tbody>
</table>
<p><img src="figures/devs_intercept.png"><img src="figures/process_intercept.png"></p>
<p><strong>Figure 2.</strong> Hessian matrix for random effects model
with a first-order autoregressive (AR1) process on recruitment in a
catch-at-age model using deviations approach (top) and process approach
(bottom).</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Kelli F. Johnson, Jon K. T. Brodziak, Kathryn L. Doering, Andrea M. Havron, Ronald Klasky, Peter T. Kuriyama, Christopher M. Legault, Bai Li, Timothy J. Miller, Cole C. Monnahan, Megumi C. Oshima, Kyle W. Shertzer, Christine C. Stawitz, Jane Y. Sullivan, Matthew Supernaw, Ian G. Taylor, Nathan R. Vaughan.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
