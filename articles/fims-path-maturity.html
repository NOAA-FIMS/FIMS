<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>FIMS Path: Maturity â€¢ FIMS</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="FIMS Path: Maturity">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">FIMS</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.4.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://github.com/NOAA-FIMS/FIMS/releases/tag/v0.1.0">Version 0.1.0</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/noaa-fims/fims/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>FIMS Path: Maturity</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/noaa-fims/fims/blob/main/vignettes/fims-path-maturity.Rmd" class="external-link"><code>vignettes/fims-path-maturity.Rmd</code></a></small>
      <div class="d-none name"><code>fims-path-maturity.Rmd</code></div>
    </div>

    
    
<style type="text/css">
.rchunk {
  border: solid #2e75b6;
}
.rcppchunk {
  border: solid #c55a11;
}
.fimschunk {
  border: solid #548235;
}
.infochunk {
  border: solid #262626;
}
</style>
<style type="text/css">
code span.co{
  color: #8c8c8c; 
}
</style>
<p>This vignette describes the hierarchical structure of FIMS by
describing the linkages, or <em>path</em>, from R to C++ using maturity
as an example. The vignette is tailored to developers or others
interested in understanding the core of FIMS. With each example of R
code that follows there are explanations of how that code is linked to
the C++ code.</p>
<p>The following diagram represents the complete path from R to C++ for
the maturity module. The following sections break this diagram into
simplified parts using a common color coding, where R code is in blue,
code for the Rcpp interface that links R objects to C++ objects is in
orange, the C++ code that acts as the core of FIMS is in green, and the
C++ code that makes up <code>Information</code> is in grey.
<img src="figures%2Ffims-path-maturity-8.png" width="100%"></p>
<div class="section level2">
<h2 id="modules-in-r">Modules in R<a class="anchor" aria-label="anchor" href="#modules-in-r"></a>
</h2>
<p>FIMS is comprised of several modules that can be linked together to
create a model. The maturity module is just one of them but will serve
as the example in this vignette. Modules are written in C++ and linked
to R using Rcpp. To retrieve a module from the C++ code it must be set
up in R and then populated with parameters.</p>
<p>After loading FIMS and the default data set that comes with FIMS, a
maturity module can be created using a list. It is easiest to populate
this list using wrapper functions that are written in R. The list that
specifies how the module will be created can be updated from the
defaults using [update_parameters()]. It is often easier to create the
defaults and update them rather than creating the list by yourself
because the wrapper functions will ensure the proper structure is used.
That way you do not have to memorize what the structure is supposed to
look like. Last, the list is used to create the module, using another
wrapper function.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load the FIMS package</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/noaa-fims/fims" class="external-link">FIMS</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load a built-in data set from the FIMS package</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"data1"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert the data into a FIMSFrame object, which is an S4 class.</span></span>
<span><span class="co"># See ?FIMSFrame for more information.</span></span>
<span><span class="va">fims_frame</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/FIMSFrame.html">FIMSFrame</a></span><span class="op">(</span><span class="va">data1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create default maturity parameters using internal function</span></span>
<span><span class="va">default_parameters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  parameters <span class="op">=</span> <span class="fu">FIMS</span><span class="fu">:::</span><span class="fu">create_default_maturity</span><span class="op">(</span>form <span class="op">=</span> <span class="st">"LogisticMaturity"</span><span class="op">)</span>,</span>
<span>  modules <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>maturity <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>form <span class="op">=</span> <span class="st">"LogisticMaturity"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu">show</span><span class="op">(</span><span class="va">default_parameters</span><span class="op">)</span></span>
<span><span class="co">#&gt; $parameters</span></span>
<span><span class="co">#&gt; $parameters$maturity</span></span>
<span><span class="co">#&gt; $parameters$maturity$LogisticMaturity.inflection_point.value</span></span>
<span><span class="co">#&gt; [1] 2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $parameters$maturity$LogisticMaturity.inflection_point.estimated</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $parameters$maturity$LogisticMaturity.slope.value</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $parameters$maturity$LogisticMaturity.slope.estimated</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $modules</span></span>
<span><span class="co">#&gt; $modules$maturity</span></span>
<span><span class="co">#&gt; $modules$maturity$form</span></span>
<span><span class="co">#&gt; [1] "LogisticMaturity"</span></span>
<span></span>
<span><span class="co"># The default maturity parameters can be updated</span></span>
<span><span class="va">parameters</span> <span class="op">&lt;-</span> <span class="va">default_parameters</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/create_default_parameters.html">update_parameters</a></span><span class="op">(</span></span>
<span>    modified_parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      maturity <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        LogisticMaturity.inflection_point.value <span class="op">=</span> <span class="fl">2.25</span>,</span>
<span>        LogisticMaturity.inflection_point.estimated <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        LogisticMaturity.slope.value <span class="op">=</span> <span class="fl">3</span>,</span>
<span>        LogisticMaturity.slope.estimated <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu">show</span><span class="op">(</span><span class="va">parameters</span><span class="op">)</span></span>
<span><span class="co">#&gt; $parameters</span></span>
<span><span class="co">#&gt; $parameters$maturity</span></span>
<span><span class="co">#&gt; $parameters$maturity$LogisticMaturity.inflection_point.value</span></span>
<span><span class="co">#&gt; [1] 2.25</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $parameters$maturity$LogisticMaturity.inflection_point.estimated</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $parameters$maturity$LogisticMaturity.slope.value</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $parameters$maturity$LogisticMaturity.slope.estimated</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $modules</span></span>
<span><span class="co">#&gt; $modules$maturity</span></span>
<span><span class="co">#&gt; $modules$maturity$form</span></span>
<span><span class="co">#&gt; [1] "LogisticMaturity"</span></span>
<span></span>
<span><span class="co"># Initialize maturity module based on the list of parameters</span></span>
<span><span class="va">maturity</span> <span class="op">&lt;-</span> <span class="fu">FIMS</span><span class="fu">:::</span><span class="fu">initialize_maturity</span><span class="op">(</span></span>
<span>  parameters <span class="op">=</span> <span class="va">parameters</span>,</span>
<span>  data <span class="op">=</span> <span class="va">fims_frame</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>For power users, the methods package can be used to call Rcpp and
create the module without using lists of parameters or any wrapper
functions. The following code also creates the same maturity module.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># load FIMS</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/noaa-fims/fims" class="external-link">FIMS</a></span><span class="op">)</span></span>
<span><span class="co"># Create a new maturity model</span></span>
<span><span class="va">maturity</span> <span class="op">&lt;-</span> <span class="fu">methods</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/methods/new.html" class="external-link">new</a></span><span class="op">(</span><span class="va">LogisticMaturity</span><span class="op">)</span></span>
<span><span class="co"># Populate the maturity module with parameter values.</span></span>
<span><span class="va">maturity</span><span class="op">$</span><span class="va">inflection_point</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">$</span><span class="va">value</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">maturity</span><span class="op">$</span><span class="va">inflection_point</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">$</span><span class="va">is_random_effect</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span><span class="va">maturity</span><span class="op">$</span><span class="va">inflection_point</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">$</span><span class="va">estimated</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span><span class="va">maturity</span><span class="op">$</span><span class="va">slope</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">$</span><span class="va">value</span> <span class="op">&lt;-</span> <span class="fl">0.2</span></span>
<span><span class="va">maturity</span><span class="op">$</span><span class="va">slope</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">$</span><span class="va">is_random_effect</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span><span class="va">maturity</span><span class="op">$</span><span class="va">slope</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">$</span><span class="va">estimated</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span></code></pre></div>
<p>To run a FIMS model, more modules than just a maturity module need to
be linked to a population module. But, this example only includes a
maturity module so the code below is just pseudo code showing how to
link a maturity module to a population module. The code below assumes
that growth and recruitment modules, i.e., modules 2 and 3, have already
been set up.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Initialize the population module and link the maturity module</span></span>
<span><span class="co"># The IDs of the growth and recruitment modules are pseudo code and don't exist</span></span>
<span><span class="va">population</span> <span class="op">&lt;-</span> <span class="fu">FIMS</span><span class="fu">:::</span><span class="fu">initialize_population</span><span class="op">(</span></span>
<span>  parameters <span class="op">=</span> <span class="va">parameters</span>,</span>
<span>  data <span class="op">=</span> <span class="va">fims_frame</span>,</span>
<span>  linked_ids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">maturity</span><span class="op">$</span><span class="fu">get_id</span><span class="op">(</span><span class="op">)</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"maturity"</span>, <span class="st">"growth"</span>, <span class="st">"recruitment"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>For power users, the methods package can be used to call Rcpp and
create the population module without using lists of parameters or any
wrapper functions.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">population</span> <span class="op">&lt;-</span> <span class="fu">methods</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/methods/new.html" class="external-link">new</a></span><span class="op">(</span><span class="va">Population</span><span class="op">)</span></span>
<span><span class="va">population</span><span class="op">$</span><span class="fu">SetMaturity</span><span class="op">(</span><span class="va">maturity</span><span class="op">$</span><span class="fu">get_id</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">population</span><span class="op">$</span><span class="fu">SetGrowth</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">population</span><span class="op">$</span><span class="fu">SetRecruitment</span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p>Because FIMS sets up objects that are stored in memory simply running
<code>rm(population)</code> will not free this memory back up. Instead,
users need to use <code>clear()</code>, which is a function written in
the Rcpp interface but callable from R. Restarting or closing your R
session will also work to free up the memory.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Clear C++ memory</span></span>
<span><span class="fu">clear</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># Clear R memory</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="rcpp-interface">Rcpp Interface<a class="anchor" aria-label="anchor" href="#rcpp-interface"></a>
</h2>
<p>For each module, the Rcpp code in <a href="https://github.com/NOAA-FIMS/FIMS/blob/main/inst/include/interface/rcpp/rcpp_interface.hpp" class="external-link">rcpp_interface.hpp</a>
defines what fields the R user can see and set. Additional code for
methods, e.g., <code>get_id</code>, constructors, and destructors are
defined for each module in .hpp files found in the <a href="https://github.com/NOAA-FIMS/FIMS/tree/main/inst/include/interface/rcpp" class="external-link">inst/include/interface/rcpp</a>
directory. Only the fields and methods that are listed in the module
interface, see below, are exposed to the R user. Additionally, this
directory stores the code for Rcpp functions like
<code>clear()</code>.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode cpp rcppchunk"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>Rcpp<span class="op">::</span><span class="va">class_</span><span class="op">&lt;</span>LogisticMaturityInterface<span class="op">&gt;(</span><span class="st">"LogisticMaturity"</span><span class="op">)</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>  <span class="op">.</span>constructor<span class="op">()</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>  <span class="op">.</span>field<span class="op">(</span><span class="st">"inflection_point"</span><span class="op">,</span> <span class="op">&amp;</span>LogisticMaturityInterface<span class="op">::</span>inflection_point<span class="op">)</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>  <span class="op">.</span>field<span class="op">(</span><span class="st">"slope"</span><span class="op">,</span> <span class="op">&amp;</span>LogisticMaturityInterface<span class="op">::</span>slope<span class="op">)</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>  <span class="op">.</span>method<span class="op">(</span><span class="st">"get_id"</span><span class="op">,</span> <span class="op">&amp;</span>LogisticMaturityInterface<span class="op">::</span>get_id<span class="op">)</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>  <span class="op">.</span>method<span class="op">(</span><span class="st">"evaluate"</span><span class="op">,</span> <span class="op">&amp;</span>LogisticMaturityInterface<span class="op">::</span>evaluate<span class="op">);</span></span></code></pre></div>
<p>The code above shows that there are two fields specific to the
maturity module (i.e., parameters), <code>inflection_point</code> and
<code>slope</code>, and methods (i.e., functions), <code>get_id</code>
and <code>evaluate</code>. <code>get_id</code> method returns a unique
ID for a created module. Where, you can have multiple instances of a
maturity module defined in memory but only one can be used per model.
Methods are functions that can be called from R. You can view all the
fields and methods that are exposed to the R user for any Rcpp class by
passing the quoted name inside the round brackets of any call to
<code>Rcpp::class_&lt;*&gt;("")</code> as an unquoted string to
<code><a href="https://rdrr.io/r/methods/show.html" class="external-link">methods::show()</a></code>, e.g.,
<code>methods::show(LogisticMaturity)</code>.</p>
<p>LogisticMaturity references the maturity rcpp class,
<code>LogisticMaturityInterface</code> defined in <a href="https://github.com/NOAA-FIMS/FIMS/blob/main/inst/include/interface/rcpp/rcpp_objects/rcpp_maturity.hpp" class="external-link">rcpp_maturity.hpp</a>
in the directory <a href="https://github.com/NOAA-FIMS/FIMS/tree/main/inst/include/interface/rcpp/rcpp_objects" class="external-link">inst/include/interface/rcpp/rcpp_objects</a>.
This file consists of a <code>MaturityInterfaceBase</code> class and a
<code>LogisticMaturityInterface</code> class, with the former being the
<strong>parent class</strong> and the latter being the <strong>child
class</strong>. Sometimes there are multiple child classes under a
parent class but as of now, there is only one child class, i.e., option,
for maturity. It is the child classes which are referenced from R, the
parent classes are just used in Rcpp to set the structure.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode cpp rcppchunk"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="kw">class</span> MaturityInterfaceBase <span class="op">:</span> <span class="kw">public</span> FIMSRcppInterfaceBase <span class="op">{</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a> <span class="kw">public</span><span class="op">:</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">uint32_t</span> id_g<span class="op">;</span> <span class="co">/**&lt; static id of the maturity interface base */</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>  <span class="dt">uint32_t</span> id<span class="op">;</span>          <span class="co">/**&lt; id of the maturity interface base */</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a><span class="kw">class</span> LogisticMaturityInterface <span class="op">:</span> <span class="kw">public</span> MaturityInterfaceBase <span class="op">{</span></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a> <span class="kw">public</span><span class="op">:</span></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>  <span class="co">/**</span></span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a><span class="co">   * </span><span class="an">@brief</span><span class="co"> The value of the dependent variable at which the response reaches</span></span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a><span class="co">   * 0.5.</span></span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a><span class="co">   */</span></span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a>  Parameter inflection_point<span class="op">;</span></span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a>  <span class="co">/**</span></span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a><span class="co">   * </span><span class="an">@brief</span><span class="co"> The width of the curve at the inflection_point.</span></span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a><span class="co">   */</span></span>
<span id="cb7-18"><a href="#cb7-18" tabindex="-1"></a>  Parameter slope<span class="op">;</span></span>
<span id="cb7-19"><a href="#cb7-19" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb7-20"><a href="#cb7-20" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><img src="figures%2Ffims-path-maturity-1.png" width="85%"></p>
<p>All Rcpp interface classes from FIMS define parameters (e.g.,
<code>inflection_point</code>, <code>slope</code>) using the
<code>ParameterVector</code> class defined in <a href="https://github.com/NOAA-FIMS/FIMS/blob/main/inst/include/interface/rcpp/rcpp_objects/rcpp_interface_base.hpp" class="external-link">rcpp_interface_base.hpp</a>
in the directory <a href="https://github.com/NOAA-FIMS/FIMS/blob/main/inst/include/interface/rcpp/rcpp_objects" class="external-link">inst/include/interface/rcpp/rcpp_objects</a>.
ParameterVectors allow parameters to vary with time. Whereas, the
Parameter class is only used for time-invariant parameters. The fields
for these classes that are accessible from R are defined in the <a href="https://github.com/NOAA-FIMS/FIMS/blob/main/inst/include/interface/rcpp/rcpp_interface.hpp" class="external-link">rcpp_interface.hpp</a>
file in the directory <a href="https://github.com/NOAA-FIMS/FIMS/tree/main/inst/include/interface/rcpp" class="external-link">inst/include/interface/rcpp</a>.
For example,</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode cpp rcppchunk"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a> Rcpp<span class="op">::</span><span class="va">class_</span><span class="op">&lt;</span>Parameter<span class="op">&gt;(</span><span class="st">"Parameter"</span><span class="op">)</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>  <span class="op">.</span>constructor<span class="op">()</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>  <span class="op">.</span>constructor<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;()</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>  <span class="op">.</span>constructor<span class="op">&lt;</span>Parameter<span class="op">&gt;()</span></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>  <span class="op">.</span>field<span class="op">(</span><span class="st">"value"</span><span class="op">,</span> <span class="op">&amp;</span>Parameter<span class="op">::</span>value<span class="op">)</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>  <span class="op">.</span>field<span class="op">(</span><span class="st">"min"</span><span class="op">,</span> <span class="op">&amp;</span>Parameter<span class="op">::</span>min<span class="op">)</span></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>  <span class="op">.</span>field<span class="op">(</span><span class="st">"max"</span><span class="op">,</span> <span class="op">&amp;</span>Parameter<span class="op">::</span>max<span class="op">)</span></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>  <span class="op">.</span>field<span class="op">(</span><span class="st">"is_random_effect"</span><span class="op">,</span> <span class="op">&amp;</span>Parameter<span class="op">::</span>is_random_effect<span class="op">)</span></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a>  <span class="op">.</span>field<span class="op">(</span><span class="st">"estimated"</span><span class="op">,</span> <span class="op">&amp;</span>Parameter<span class="op">::</span>estimated<span class="op">);</span></span></code></pre></div>
<p>Each field (i.e., parameter) from <code>maturity</code> (i.e., the
maturity module we defined in R) will therefore inherit the five fields
defined in the Parameter class: <code>value</code>, <code>min</code>,
<code>max</code>, <code>is_random_effect</code>, <code>estimated</code>.
That is, two parameter fields and 10 fields within those parameters.</p>
</div>
<div class="section level2">
<h2 id="fims-namespace">
<code>fims</code> namespace<a class="anchor" aria-label="anchor" href="#fims-namespace"></a>
</h2>
<div class="section level3">
<h3 id="what-is-a-namespace">What is a namespace?<a class="anchor" aria-label="anchor" href="#what-is-a-namespace"></a>
</h3>
<p>A namespace in C++ is similar to a library in R. The core of FIMS is
within the <code>fims</code> namespace and the namespace is a convenient
way to differentiate between the part of the C++ code base that is
portable, i.e., independent of statistical platform, and the part of the
codebase that depends on platforms outside of base C++ (e.g.,
<a href="https://www.rcpp.org" class="external-link">Rcpp</a>, R, <a href="https://github.com/kaskr/adcomp/wiki" class="external-link">TMB</a>). Any code written
within:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode cpp fimschunk"><code class="sourceCode cpp"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="kw">namespace</span> fims<span class="op">{</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>  </span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>is considered to be a part of the <code>fims</code> namespace. C++
classes written within the <code>fims</code> namespace can be accessed
within the C++ code base using <code>fims_popdy::</code>.</p>
<p>There are some exceptions where <a href="https://github.com/kaskr/adcomp/wiki" class="external-link">TMB</a> specific code is
referenced within the <code>fims</code> namespace. In these cases, code
is written within an <code>#ifdef TMB_MODEL</code> wrapper, which means
the code is only defined if <a href="https://github.com/kaskr/adcomp/wiki" class="external-link">TMB</a> is being used. Given the
addition of a new platform, e.g., stan, a new wrapper could be added to
define platform specific code for these sections.</p>
<p>For example, the definition of data types in <a href="https://github.com/NOAA-FIMS/FIMS/blob/main/inst/include/interface/interface.hpp" class="external-link">inst/include/interface/interface.hpp</a>
will always be platform dependent because each platform has specific
requirements for how the data types are defined. Whenever a new platform
is added to <a href="https://github.com/noaa-fims/fims" class="external-link">FIMS</a>, we will need to set up the platform
specific data type definitions. Below is an example of a definition.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode cpp fimschunk"><code class="sourceCode cpp"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="kw">namespace</span> fims <span class="op">{</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="pp">#ifdef TMB_MODEL</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> fims::ModelTraits class that contains the DataVector</span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a><span class="co"> * and ParameterVector types.</span></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> Type<span class="op">&gt;</span></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a><span class="kw">struct</span> fims<span class="op">::</span>ModelTraits <span class="op">{</span></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>  <span class="kw">typedef</span> <span class="kw">typename</span> CppAD<span class="op">::</span>vector<span class="op">&lt;</span>Type<span class="op">&gt;</span> DataVector<span class="op">;</span> <span class="co">/**&lt; A vector</span></span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a><span class="co">        of the data that is differentiable */</span></span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>  <span class="kw">typedef</span> <span class="kw">typename</span> CppAD<span class="op">::</span>vector<span class="op">&lt;</span>Type<span class="op">&gt;</span> ParameterVector<span class="op">;</span> <span class="co">/**&lt; A</span></span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a><span class="co">  vector of the parameters that is differentiable */</span></span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>  <span class="kw">typedef</span> <span class="kw">typename</span> tmbutils<span class="op">::</span>vector<span class="op">&lt;</span>Type<span class="op">&gt;</span></span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>      EigenVector<span class="op">;</span> <span class="co">/**&lt; A vector as defined in the Eigen namespace in TMB */</span></span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a><span class="pp">#endif </span><span class="co">/* TMB_MODEL */</span></span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a><span class="op">}</span>  <span class="co">// namespace fims</span></span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a></span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a><span class="co">//not developed yet</span></span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a><span class="pp">#ifdef STAN_MODEL</span></span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a><span class="co">//stan specific definitions go here</span></span>
<span id="cb10-23"><a href="#cb10-23" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="maturity-example">Maturity example<a class="anchor" aria-label="anchor" href="#maturity-example"></a>
</h3>
<p>Each Rcpp interface object includes an <code>add_to_fims_tmb()</code>
function. There are two shared pointers set up within this function, one
to link each Rcpp interface object (e.g.,
<code>LogisticMaturityInterface</code>) to the <code>Information</code>
class in the <code>fims</code> namespace defined in <a href="https://github.com/NOAA-FIMS/FIMS/blob/main/inst/include/common/information.hpp" class="external-link">inst/include/common/information.hpp</a>
and one to link to the matching class in the <code>fims</code>
namespace. In our maturity example, this would be the
<code>LogisticMaturity</code> class in the <code>fims</code> namespace
defined in <a href="https://github.com/NOAA-FIMS/FIMS/blob/main/inst/include/population_dynamics/maturity/functors/logistic.hpp" class="external-link">inst/include/population_dynamics/maturity/functors/logistic.hpp</a>.</p>
<p>Within rcpp_maturity.hpp, there is a link to the
<code>fims_info::Information</code> class to register maturity
parameters and specify whether or not they are random effects. We do
this by setting up two pointers in the interface, info that points to
information, and maturity that points to the logistic maturity
module.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode cpp rcppchunk"><code class="sourceCode cpp"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="co">// file: rcpp_maturity.hpp</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="co">// info is a shared pointer that points to fims_info::Information</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="bu">std::</span>shared_ptr<span class="op">&lt;</span>fims_info<span class="op">::</span>Information<span class="op">&lt;</span>TMB_FIMS_REAL_TYPE<span class="op">&gt;</span> <span class="op">&gt;</span> info <span class="op">=</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>        fims_info<span class="op">::</span>Information<span class="op">&lt;</span>TMB_FIMS_REAL_TYPE<span class="op">&gt;::</span>GetInstance<span class="op">();</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a> <span class="cf">if</span> <span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span>inflection_point<span class="op">.</span>estimated<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span><span class="kw">this</span><span class="op">-&gt;</span>inflection_point<span class="op">.</span>is_random_effect<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>        <span class="co">/*</span></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a><span class="co">         if inflection_point is estimated and a random effect, </span></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a><span class="co">         the inflection_point value from LogisticMaturityInterface (maturity-&gt;inflection_point) </span></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a><span class="co">         is passed to the Information member function RegisterRandomEffect</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a><span class="co">        */</span></span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a>        info<span class="op">-&gt;</span>RegisterRandomEffect<span class="op">(</span>maturity<span class="op">-&gt;</span>inflection_point<span class="op">);</span></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>        <span class="co">/*</span></span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a><span class="co">         if inflection_point is estimated and not a random effect, </span></span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a><span class="co">         the inflection_point value from LogisticMaturityInterface (maturity-&gt;inflection_point)</span></span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a><span class="co">         is passed to the Information member function RegisterParameter</span></span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a><span class="co">         */</span></span>
<span id="cb11-20"><a href="#cb11-20" tabindex="-1"></a>        info<span class="op">-&gt;</span>RegisterParameter<span class="op">(</span>maturity<span class="op">-&gt;</span>inflection_point<span class="op">);</span></span>
<span id="cb11-21"><a href="#cb11-21" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb11-22"><a href="#cb11-22" tabindex="-1"></a>    <span class="op">}</span></span></code></pre></div>
<p>Linking to the <code>fims_popdy::LogisticMaturity</code> class allows
the code to link the values input from R to the values used in the
estimation of parameters when fitting data to a model. Below is an
example of the link for maturity.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode cpp rcppchunk"><code class="sourceCode cpp"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="co">// file: rcpp_maturity.hpp</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="co">// maturity is a shared pointer that points to fims_popdy::LogisticMaturity</span></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a><span class="bu">std::</span>shared_ptr<span class="op">&lt;</span>fims_popdy<span class="op">::</span>LogisticMaturity<span class="op">&lt;</span>TMB_FIMS_REAL_TYPE<span class="op">&gt;</span> <span class="op">&gt;</span> maturity <span class="op">=</span></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>  <span class="bu">std::</span>make_shared<span class="op">&lt;</span>fims_popdy<span class="op">::</span>LogisticMaturity<span class="op">&lt;</span>TMB_FIMS_REAL_TYPE<span class="op">&gt;</span> <span class="op">&gt;();</span></span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a> </span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a><span class="co">// the inflection_point value from LogisticMaturity (maturity-&gt;inflection_point)</span></span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a><span class="co">// equals the inflection_point value from LogisticMaturityInterface</span></span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a><span class="co">// (this-&gt;inflection_point.value)</span></span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a>maturity<span class="op">-&gt;</span>inflection_point <span class="op">=</span> <span class="kw">this</span><span class="op">-&gt;</span>inflection_point<span class="op">.</span>value<span class="op">;</span></span></code></pre></div>
<p>We can also link these two pointers together so that the
<strong>fims_<a href="info::Information" class="uri">info::Information</a></strong> class links up with the
<strong>fims_popdy::LogisticMaturity</strong>, but more details on this
later.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode cpp rcppchunk"><code class="sourceCode cpp"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="co">// file: rcpp_maturity.hpp</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a><span class="co">// the maturity_models pointer from Information that matches the </span></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a><span class="co">// id of the fims_popdy::LogisticMaturity class is equal to the pointer </span></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a><span class="co">// to fims_popdy::LogisticMaturity </span></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>info<span class="op">-&gt;</span>maturity_models<span class="op">[</span>maturity<span class="op">-&gt;</span>id<span class="op">]</span> <span class="op">=</span> maturity<span class="op">;</span></span></code></pre></div>
<p>The <code>add_to_fims_tmb</code> function repeats
<code>add_to_fims_tmb_internal</code> four times to track the estimated
value of each parameter along with their first, second, and third
derivatives.</p>
<p><img src="figures%2Ffims-path-maturity-2.png" width="100%"></p>
</div>
</div>
<div class="section level2">
<h2 id="fims_popdylogisticmaturity-class">
<code>fims_popdy::LogisticMaturity</code> class<a class="anchor" aria-label="anchor" href="#fims_popdylogisticmaturity-class"></a>
</h2>
<p>The <code>LogisticMaturity</code> class in the <code>fims</code>
namespace defined in <a href="https://github.com/NOAA-FIMS/FIMS/blob/main/inst/include/population_dynamics/maturity/functors/logistic.hpp" class="external-link">inst/include/population_dynamics/maturity/functors/logistic.hpp</a>
has an <code>evaluate</code> method (i.e., function) that takes an
input, <em>x</em> and returns the output from a logistic function
(defined in <a href="https://github.com/NOAA-FIMS/FIMS/blob/main/inst/include/common/fims_math.hpp" class="external-link">inst/include/common/fims_math.hpp</a>)
using the class members <code>inflection_point</code> and
<code>slope</code> values. Other modules that use the logistic function
use the same function in fims_math.hpp, e.g., logistic selectivity, and
thus, the logistic equation is only defined once within the source code
but used for multiple modules.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode cpp fimschunk"><code class="sourceCode cpp"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="kw">namespace</span> fims_popdy <span class="op">{</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> LogisticMaturity class that returns the logistic function value</span></span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a><span class="co"> * from fims_math.</span></span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> Type<span class="op">&gt;</span></span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a><span class="kw">struct</span> LogisticMaturity <span class="op">:</span> <span class="kw">public</span> MaturityBase<span class="op">&lt;</span>Type<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a>  Type inflection_point<span class="op">;</span> <span class="co">/**&lt; 50 percent quantile of the value of the quantity of interest (x); e.g.,</span></span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a><span class="co">               age at which 50 percent of the fish are mature */</span></span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a>  Type slope<span class="op">;</span>  <span class="co">/**&lt;scalar multiplier of difference between quantity of interest</span></span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a><span class="co">               value (x) and inflection_point */</span></span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a>  LogisticMaturity<span class="op">()</span> <span class="op">:</span> MaturityBase<span class="op">&lt;</span>Type<span class="op">&gt;()</span> <span class="op">{}</span></span>
<span id="cb14-15"><a href="#cb14-15" tabindex="-1"></a></span>
<span id="cb14-16"><a href="#cb14-16" tabindex="-1"></a>  <span class="co">/**</span></span>
<span id="cb14-17"><a href="#cb14-17" tabindex="-1"></a><span class="co">   * </span><span class="an">@brief</span><span class="co"> Method of the logistic maturity class that implements the</span></span>
<span id="cb14-18"><a href="#cb14-18" tabindex="-1"></a><span class="co">   * logistic function from FIMS math.</span></span>
<span id="cb14-19"><a href="#cb14-19" tabindex="-1"></a><span class="co">   *</span></span>
<span id="cb14-20"><a href="#cb14-20" tabindex="-1"></a><span class="co">   * </span><span class="an">@param</span><span class="co"> </span><span class="cv">x</span><span class="co"> The independent variable in the logistic function (e.g., age or</span></span>
<span id="cb14-21"><a href="#cb14-21" tabindex="-1"></a><span class="co">   * size at maturity).</span></span>
<span id="cb14-22"><a href="#cb14-22" tabindex="-1"></a><span class="co">   */</span></span>
<span id="cb14-23"><a href="#cb14-23" tabindex="-1"></a>  <span class="kw">virtual</span> <span class="at">const</span> Type evaluate<span class="op">(</span><span class="at">const</span> Type<span class="op">&amp;</span> x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-24"><a href="#cb14-24" tabindex="-1"></a>    <span class="cf">return</span> fims_math<span class="op">::</span>logistic<span class="op">&lt;</span>Type<span class="op">&gt;(</span>inflection_point<span class="op">,</span> slope<span class="op">,</span> x<span class="op">);</span></span>
<span id="cb14-25"><a href="#cb14-25" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb14-26"><a href="#cb14-26" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb14-27"><a href="#cb14-27" tabindex="-1"></a></span>
<span id="cb14-28"><a href="#cb14-28" tabindex="-1"></a><span class="op">}</span>  <span class="co">// namespace fims</span></span></code></pre></div>
<p><img src="figures%2Ffims-path-maturity-3.png" width="100%"></p>
</div>
<div class="section level2">
<h2 id="population-class">Population class<a class="anchor" aria-label="anchor" href="#population-class"></a>
</h2>
<p>The <code>Population</code> class defined in <a href="https://github.com/NOAA-FIMS/FIMS/blob/main/inst/include/population_dynamics/population/population.hpp" class="external-link">inst/include/population_dynamics/population/population.hpp</a>
is where all the biological calculations happen, producing expected
values used in likelihood equations and derived quantities that are
important for management (e.g., spawning biomass). A shared pointer that
links the maturity module to population must be set up before the model
can evaluate maturity within the <code>Population</code> class.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode cpp fimschunk"><code class="sourceCode cpp"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="co">// file: inst/include/population_dynamics/population/population.hpp</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a><span class="co">// maturity is a shared pointer to MaturityBase</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a><span class="co">// id of the maturity model object</span></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a><span class="dt">int</span> maturity_id <span class="op">=</span> <span class="op">-</span><span class="dv">999</span><span class="op">;</span></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a><span class="co">// shared pointer to the maturity module</span></span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a><span class="bu">std::</span>shared_ptr<span class="op">&lt;</span>fims_popdy<span class="op">::</span>MaturityBase<span class="op">&lt;</span>Type<span class="op">&gt;&gt;</span> maturity<span class="op">;</span></span></code></pre></div>
<p>The <code>maturity_id</code> was set from R using the
<code>SetMaturity()</code> method from the
<code>PopulationInterface</code> class, which as a reminder is done
internally within <code>FIMS::initialize_population</code> but can also
be done by hand with <code>SetMaturity</code>. Where both options are
shown, again, below.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Helper function</span></span>
<span><span class="va">population</span> <span class="op">&lt;-</span> <span class="fu">FIMS</span><span class="fu">:::</span><span class="fu">initialize_population</span><span class="op">(</span></span>
<span>  parameters <span class="op">=</span> <span class="va">parameters</span>,</span>
<span>  data <span class="op">=</span> <span class="va">fims_frame</span>,</span>
<span>  linked_ids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">maturity</span><span class="op">$</span><span class="fu">get_id</span><span class="op">(</span><span class="op">)</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"maturity"</span>, <span class="st">"growth"</span>, <span class="st">"recruitment"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Manual</span></span>
<span><span class="va">population</span><span class="op">$</span><span class="fu">SetMaturity</span><span class="op">(</span><span class="va">maturity</span><span class="op">$</span><span class="fu">get_id</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Notice above that population by default declares a pointer of type
<code>MaturityBase</code> (parent class), not the specific maturity
class we are using in this example, i.e., <code>LogisticMaturity</code>
(child class). <code>MaturityBase</code> has an <code>evaluate</code>
method with input arguments that match the inputs of each child
class:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode cpp fimschunk"><code class="sourceCode cpp"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="co">// file: inst/include/population_dynamics/maturity/functors/maturity_base.hpp</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="kw">namespace</span> fims_popdy <span class="op">{</span></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a><span class="co"> * </span><span class="an">@brief</span><span class="co"> Base class for all maturity functors.</span></span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a><span class="co"> * </span><span class="an">@tparam</span><span class="co"> </span><span class="cv">TypeThe</span><span class="co"> type of the maturity functor.</span></span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> Type<span class="op">&gt;</span></span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a><span class="kw">struct</span> MaturityBase <span class="op">:</span> <span class="kw">public</span> fims_model_object<span class="op">::</span>FIMSObject<span class="op">&lt;</span>Type<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a>  <span class="co">// id_g is the ID of the instance of the MaturityBase class.</span></span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a>  <span class="co">// this is like a memory tracker.</span></span>
<span id="cb17-13"><a href="#cb17-13" tabindex="-1"></a>  <span class="co">// Assigning each one its own ID is a way to keep track of</span></span>
<span id="cb17-14"><a href="#cb17-14" tabindex="-1"></a>  <span class="co">// all the instances of the MaturityBase class.</span></span>
<span id="cb17-15"><a href="#cb17-15" tabindex="-1"></a>  <span class="at">static</span> <span class="dt">uint32_t</span> id_g<span class="op">;</span> <span class="co">/**&lt; The ID of the instance of the MaturityBase class */</span></span>
<span id="cb17-16"><a href="#cb17-16" tabindex="-1"></a></span>
<span id="cb17-17"><a href="#cb17-17" tabindex="-1"></a>  <span class="co">/**</span></span>
<span id="cb17-18"><a href="#cb17-18" tabindex="-1"></a><span class="co">   * </span><span class="an">@brief</span><span class="co"> Constructor</span></span>
<span id="cb17-19"><a href="#cb17-19" tabindex="-1"></a><span class="co">   */</span></span>
<span id="cb17-20"><a href="#cb17-20" tabindex="-1"></a>  MaturityBase<span class="op">()</span> <span class="op">{</span></span>
<span id="cb17-21"><a href="#cb17-21" tabindex="-1"></a>    <span class="co">// increment id of the singleton maturity class</span></span>
<span id="cb17-22"><a href="#cb17-22" tabindex="-1"></a>    <span class="kw">this</span><span class="op">-&gt;</span>id <span class="op">=</span> MaturityBase<span class="op">::</span>id_g<span class="op">++;</span></span>
<span id="cb17-23"><a href="#cb17-23" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb17-24"><a href="#cb17-24" tabindex="-1"></a></span>
<span id="cb17-25"><a href="#cb17-25" tabindex="-1"></a>  <span class="co">/**</span></span>
<span id="cb17-26"><a href="#cb17-26" tabindex="-1"></a><span class="co">   * </span><span class="an">@brief</span><span class="co"> Calculates the maturity.</span></span>
<span id="cb17-27"><a href="#cb17-27" tabindex="-1"></a><span class="co">   * </span><span class="an">@param</span><span class="co"> </span><span class="cv">x</span><span class="co"> The independent variable in the maturity function (e.g., logistic</span></span>
<span id="cb17-28"><a href="#cb17-28" tabindex="-1"></a><span class="co">   * maturity at age or size).</span></span>
<span id="cb17-29"><a href="#cb17-29" tabindex="-1"></a><span class="co">   */</span></span>
<span id="cb17-30"><a href="#cb17-30" tabindex="-1"></a>  <span class="kw">virtual</span> <span class="at">const</span> Type evaluate<span class="op">(</span><span class="at">const</span> Type<span class="op">&amp;</span> x<span class="op">)</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-31"><a href="#cb17-31" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb17-32"><a href="#cb17-32" tabindex="-1"></a></span>
<span id="cb17-33"><a href="#cb17-33" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The evaluate function is a <a href="https://www.geeksforgeeks.org/virtual-function-cpp/" class="external-link">virtual C++
function</a>, which means the function can be overwritten by functions
of the same name from a child class. This structure keeps the maturity
module in population generic. We donâ€™t need any conditional statements
to loop over all possible maturity formulations within population. We
only need to add a new child maturity class with an Rcpp interface and
we can automatically call it from population. There is a trade-off here.
We are creating a nested hierarchical structure that makes the code base
harder to read. In exchange, weâ€™re creating code with a lower <a href="https://en.wikipedia.org/wiki/Cyclomatic_complexity" class="external-link">cyclomatic
complexity</a>, that is, there will only ever be one independent path
from the user to the <code>maturity-&gt;evaluate()</code> call in
population, regardless of how many maturity functions are added to FIMS.
Code with lower cyclomatic complexity is easier to test, maintain, and
extend.</p>
<p>Once we have set up the shared pointer, we can access maturity from
within population.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode cpp fimschunk"><code class="sourceCode cpp"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="co">// file: inst/include/population_dynamics/population/population.hpp</span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a> <span class="co">/**</span></span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a><span class="co">  * </span><span class="an">@brief</span><span class="co"> Calculates expected proportion of individuals mature at a selected</span></span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a><span class="co">  * age.</span></span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a><span class="co">  *</span></span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a><span class="co">  * </span><span class="an">@param</span><span class="co"> </span><span class="cv">i_age_year</span><span class="co"> dimension folded index for age and year</span></span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a><span class="co">  * </span><span class="an">@param</span><span class="co"> </span><span class="cv">age</span><span class="co"> the age of maturity</span></span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a><span class="co">  */</span></span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a>  <span class="dt">void</span> CalculateMaturityAA<span class="op">(</span><span class="dt">size_t</span> i_age_year<span class="op">,</span> <span class="dt">size_t</span> age<span class="op">)</span> <span class="op">{</span></span>
<span id="cb18-10"><a href="#cb18-10" tabindex="-1"></a>    <span class="co">// this-&gt;maturity is pointing to the maturity module, which has</span></span>
<span id="cb18-11"><a href="#cb18-11" tabindex="-1"></a>    <span class="co">// an evaluate function. -&gt; can be nested.</span></span>
<span id="cb18-12"><a href="#cb18-12" tabindex="-1"></a>    <span class="kw">this</span><span class="op">-&gt;</span>proportion_mature_at_age<span class="op">[</span>i_age_year<span class="op">]</span> <span class="op">=</span></span>
<span id="cb18-13"><a href="#cb18-13" tabindex="-1"></a>      <span class="kw">this</span><span class="op">-&gt;</span>maturity<span class="op">-&gt;</span>evaluate<span class="op">(</span>ages<span class="op">[</span>age<span class="op">]);</span></span>
<span id="cb18-14"><a href="#cb18-14" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p><img src="figures%2Ffims-path-maturity-4.png" width="100%"></p>
</div>
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>The above material demonstrates how values passed in from R are
propagated into population.hpp, where they are used in biologically
relevant calculations. This, however, relies on population referencing
the correct child class (e.g., <code>LogisticMaturity</code>) even
though it only calls the parent class (<code>MaturityBase</code>). We
defined the <code>maturity_id</code> in population for the specific
logistic maturity module we wanted to use,
<code>population$SetMaturity(maturity$get_id())</code>, but we still
need to connect this ID with the actual module in memory.</p>
<p>This <em>information</em> is managed in FIMS through the
<code>Information</code> class in <a href="https://github.com/NOAA-FIMS/FIMS/blob/main/inst/include/common/information.hpp" class="external-link">inst/include/common/information.hpp</a>.
The Information class sets up a number of <a href="https://cplusplus.com/reference/map/map/" class="external-link">C++ maps</a> (a
container with a key value and mapped value - think of named lists in R)
where the key is the unique ID to the module and the mapped value is a
shared pointer to the module. C++ <code>std::maps</code> have an
iterator member for stepping through the elements of the map. This
iterator is also declared in the Information class so that we can loop
through all the unique maturity modules being called in FIMS. We
currently only have one but if FIMS is ever extended to include multiple
populations, we could have a unique maturity module for each population
or subset of populations.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode cpp infochunk"><code class="sourceCode cpp"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="co">// file: inst/include/common/information.hpp</span></span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a><span class="co">// uint32_t is an unsigned integer (always positive)</span></span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a><span class="co">// The first component of the map is a uint32_t which will be used to hold the</span></span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a><span class="co">// ID. The second component of the map is the shared pointer, maturity_models,</span></span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a><span class="co">// that points to fims_popdy::MaturityBase</span></span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a><span class="co">// hash map to link each object to its shared location in memory</span></span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a><span class="bu">std::</span>map<span class="op">&lt;</span><span class="dt">uint32_t</span><span class="op">,</span> <span class="bu">std::</span>shared_ptr<span class="op">&lt;</span>fims_popdy<span class="op">::</span>MaturityBase<span class="op">&lt;</span>Type<span class="op">&gt;</span> <span class="op">&gt;</span> <span class="op">&gt;</span></span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a>  maturity_models<span class="op">;</span></span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" tabindex="-1"></a><span class="co">// Next we set up the iterator, which will be used to loop over all</span></span>
<span id="cb19-12"><a href="#cb19-12" tabindex="-1"></a><span class="co">// defined maturity modules</span></span>
<span id="cb19-13"><a href="#cb19-13" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">typename</span> <span class="bu">std::</span>map<span class="op">&lt;</span><span class="dt">uint32_t</span><span class="op">,</span> </span>
<span id="cb19-14"><a href="#cb19-14" tabindex="-1"></a>                          <span class="bu">std::</span>shared_ptr<span class="op">&lt;</span>fims_popdy<span class="op">::</span>MaturityBase<span class="op">&lt;</span>Type<span class="op">&gt;</span> <span class="op">&gt;</span> <span class="op">&gt;::</span>iterator</span>
<span id="cb19-15"><a href="#cb19-15" tabindex="-1"></a>  maturity_models_iterator<span class="op">;</span></span></code></pre></div>
<p><img src="figures%2Ffims-path-maturity-5.png" width="100%"></p>
<p>Next, letâ€™s revisit the line of code that was written in the Rcpp
<code>LogisticMaturityInterface</code> class in <a href="https://github.com/NOAA-FIMS/FIMS/blob/main/inst/include/interface/rcpp/rcpp_objects/rcpp_maturity.hpp" class="external-link">inst/include/interface/rcpp/rcpp_objects/rcpp_maturity.hpp</a>.
Here, we are setting the maturity_models pointer in
<code>Information</code> to equal the <code>maturity</code> pointer to
the <code>LogisticMaturity</code> module.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode cpp rcppchunk"><code class="sourceCode cpp"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="co">// file: rcpp_maturity.hpp</span></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a><span class="co">// the maturity_models pointer from Information that matches the id of the</span></span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a><span class="co">// fims_popdy::LogisticMaturity class is equal to the pointer to</span></span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a><span class="co">// fims_popdy::LogisticMaturity</span></span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a>info<span class="op">-&gt;</span>maturity_models<span class="op">[</span>maturity<span class="op">-&gt;</span>id<span class="op">]</span> <span class="op">=</span> maturity<span class="op">;</span></span></code></pre></div>
<p><img src="figures%2Ffims-path-maturity-6.png" width="100%"></p>
<p>Now we need to pass this pointer to the maturity pointer in
population so that <code>population-&gt;maturity</code> points to the
<code>LogisticMaturity</code> module instead of
<code>MaturityBase</code>. First we set up a map in
<code>Information</code> that points to <code>Population</code>.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode cpp infochunk"><code class="sourceCode cpp"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="co">// file: inst/include/common/information.hpp</span></span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a><span class="co">// hash map to link each object to its shared location in</span></span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a>                      memory</span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a><span class="bu">std::</span>map<span class="op">&lt;</span><span class="dt">uint32_t</span><span class="op">,</span> <span class="bu">std::</span>shared_ptr<span class="op">&lt;</span>fims_popdy<span class="op">::</span>Population<span class="op">&lt;</span>Type<span class="op">&gt;</span> <span class="op">&gt;</span> <span class="op">&gt;</span> populations<span class="op">;</span></span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a>  <span class="kw">typedef</span> <span class="kw">typename</span> <span class="bu">std::</span>map<span class="op">&lt;</span><span class="dt">uint32_t</span><span class="op">,</span></span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a>                            <span class="bu">std::</span>shared_ptr<span class="op">&lt;</span>fims_popdy<span class="op">::</span>Population<span class="op">&lt;</span>Type<span class="op">&gt;</span> <span class="op">&gt;</span> <span class="op">&gt;::</span>iterator</span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a>    population_iterator<span class="op">;</span></span>
<span id="cb21-9"><a href="#cb21-9" tabindex="-1"></a><span class="co">// iterator for population objects</span></span></code></pre></div>
<p><img src="figures%2Ffims-path-maturity-7.png" width="100%"></p>
<p>Populations are looped through with a new shared pointer,
<code>p</code>, to reference the individual population of interest.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode cpp infochunk"><code class="sourceCode cpp"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="co">// file: inst/include/common/information.hpp</span></span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span>population_iterator it <span class="op">=</span> <span class="kw">this</span><span class="op">-&gt;</span>populations<span class="op">.</span>begin<span class="op">();</span></span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a>     it <span class="op">!=</span> <span class="kw">this</span><span class="op">-&gt;</span>populations<span class="op">.</span>end<span class="op">();</span> <span class="op">++</span>it<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a>  <span class="bu">std::</span>shared_ptr<span class="op">&lt;</span>fims_popdy<span class="op">::</span>Population<span class="op">&lt;</span>Type<span class="op">&gt;</span> <span class="op">&gt;</span> p <span class="op">=</span> <span class="op">(*</span>it<span class="op">).</span>second<span class="op">;</span></span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>In this code chunk, <code>(*it)</code> refers to a single population
in the <code>populations</code> map. The second element of the map is
the pointer, so <code>p = (*it).second</code> means the pointer is being
set to a single population to equal the pointer to
<code>populations</code> in the map.</p>
<p>Within this population loop, the <code>maturity</code> pointer in
<code>population</code> is linked to the <code>maturity</code> pointer
in information, passing on the information that we want to use the
<code>LogisticMaturity</code> class.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode cpp infochunk"><code class="sourceCode cpp"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="co">// file: inst/include/common/information.hpp</span></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>  <span class="co">// set maturity</span></span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>p<span class="op">-&gt;</span>maturity_id <span class="op">!=</span> <span class="op">-</span><span class="dv">999</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a>    <span class="dt">uint32_t</span> maturity_uint <span class="op">=</span> <span class="kw">static_cast</span><span class="op">&lt;</span><span class="dt">uint32_t</span><span class="op">&gt;(</span>p<span class="op">-&gt;</span>maturity_id<span class="op">);</span></span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a>    maturity_models_iterator it <span class="op">=</span> <span class="kw">this</span><span class="op">-&gt;</span>maturity_models<span class="op">.</span>find<span class="op">(</span>maturity_uint<span class="op">);</span></span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a>    <span class="co">// &gt;maturity_models is specified in</span></span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a>    <span class="co">// information.hpp and used in rcpp</span></span>
<span id="cb23-8"><a href="#cb23-8" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>it <span class="op">!=</span> <span class="kw">this</span><span class="op">-&gt;</span>maturity_models<span class="op">.</span>end<span class="op">())</span> <span class="op">{</span></span>
<span id="cb23-10"><a href="#cb23-10" tabindex="-1"></a>      <span class="co">// p-&gt;maturity is the maturity pointer in population</span></span>
<span id="cb23-11"><a href="#cb23-11" tabindex="-1"></a>      <span class="co">// (*it).second is the maturity pointer in information</span></span>
<span id="cb23-12"><a href="#cb23-12" tabindex="-1"></a>      p<span class="op">-&gt;</span>maturity <span class="op">=</span> <span class="op">(*</span>it<span class="op">).</span>second<span class="op">;</span>  <span class="co">// &gt;maturity defined in population.hpp</span></span>
<span id="cb23-13"><a href="#cb23-13" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb23-14"><a href="#cb23-14" tabindex="-1"></a></span>
<span id="cb23-15"><a href="#cb23-15" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p>Here, (*it) is referring to the <code>maturity_models</code> map in
information and (*it).second refers to the second element of the map,
which is the pointer to the maturity module.</p>
<p><img src="figures%2Ffims-path-maturity-8.png" width="100%"></p>
</div>
<div class="section level2">
<h2 id="thinking-in-r">Thinking in R<a class="anchor" aria-label="anchor" href="#thinking-in-r"></a>
</h2>
<p>This is an optional exercise for those who would benefit from
reviewing what is happening when the Rcpp code is being accessed from
within R and how to translate some of the C++ code into similar R code.
Below, the first section of code will be how to think about a concept in
R and the second section will be how to use Rcpp in R or how to think
about the C++ code in R terms. These latter sections, will be commented
out to help distinguish between the two code sets. The idea is to link
what is happening in the C++ code of FIMS to a language that some are
more familiar with, i.e., R.</p>
<p>Of the three populations included in the example, the first two have
a mirrored logistic maturity function and the third has a different
maturity function. This third function could be a different function all
together or a logistic function with a different parameter set. For this
example, there the third maturity function is a logistic function with a
different parameter set. Note that additional modules should be included
in population, e.g., growth, but that will be ignored for this
example.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">population_modules</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"Pop 1"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    id <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    maturity <span class="op">=</span> <span class="st">"MaturityBase"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="st">"Pop 2"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    id <span class="op">=</span> <span class="fl">2</span>,</span>
<span>    maturity <span class="op">=</span> <span class="st">"MaturityBase"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="st">"Pop 3"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    id <span class="op">=</span> <span class="fl">3</span>,</span>
<span>    maturity <span class="op">=</span> <span class="st">"MaturityBase"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">maturity_modules</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">"Logistic Maturity"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span>, inflection_point <span class="op">=</span> <span class="fl">10</span>, slope <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span>,</span>
<span>  <span class="st">"Some Other Maturity"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">2</span>, inflection_point <span class="op">=</span> <span class="fl">8</span>, slope <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><code>population_modules</code> and <code>maturity_modules</code> are
the equivalent of instantiated C++ classes stored in memory. This R code
chunk above is comparable to using Rcpp in R to set up the modules and
store them in memory.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># maturity1 &lt;- methods::new(LogisticMaturity)</span></span>
<span><span class="co"># maturity1$inflection_point$value &lt;- 10</span></span>
<span><span class="co"># maturity1$slope$value &lt;- 0.2</span></span>
<span><span class="co"># maturity2 &lt;- methods::new(LogisticMaturity)</span></span>
<span><span class="co"># maturity2$inflection_point$value &lt;- 8</span></span>
<span><span class="co"># maturity2$slope$value &lt;- 0.3</span></span>
<span><span class="co"># population1 &lt;- methods::new(Population)</span></span>
<span><span class="co"># population2 &lt;- methods::new(Population)</span></span>
<span><span class="co"># population3 &lt;- methods::new(Population)</span></span></code></pre></div>
<p>Next, the maturity IDS are assigned to each <code>maturity_id</code>
in one of the three populations. Which is actually done using
<code>SetMaturity</code> in R (i.e., the commented out code).</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">population_modules</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">maturity_id</span> <span class="op">&lt;-</span> <span class="va">maturity_modules</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">id</span></span>
<span><span class="va">population_modules</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">maturity_id</span> <span class="op">&lt;-</span> <span class="va">maturity_modules</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">id</span></span>
<span><span class="va">population_modules</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">maturity_id</span> <span class="op">&lt;-</span> <span class="va">maturity_modules</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">id</span></span>
<span></span>
<span><span class="co"># population1$SetMaturity(maturity1$get_id())</span></span>
<span><span class="co"># population2$SetMaturity(maturity1$get_id())</span></span>
<span><span class="co"># population3$SetMaturity(maturity2$get_id())</span></span></code></pre></div>
<p>In FIMS, the Information class has the objects, population and
maturity, which are C++ maps. The first element of the map is the ID,
the second element of the map is the pointer to the Population or
Maturity class. This can be thought about in R using a list but in C++
maps are used.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">information</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  populations <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>id <span class="op">=</span> <span class="cn">NULL</span>, pointer <span class="op">=</span> <span class="st">"Population"</span><span class="op">)</span>,</span>
<span>  maturity <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>id <span class="op">=</span> <span class="cn">NULL</span>, pointer <span class="op">=</span> <span class="st">"MaturityBase"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># std::map&lt;uint32_t, std::shared_ptr&lt;fims_popdy::MaturityBase&lt;Type&gt; &gt; &gt; maturity_models;</span></span>
<span><span class="co"># std::map&lt;uint32_t, std::shared_ptr&lt;fims_popdy::Population&lt;Type&gt; &gt; &gt; populations;</span></span></code></pre></div>
<p>Pointers are used to link Information to each respective module.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">information</span><span class="op">$</span><span class="va">populations</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span>, pointer <span class="op">=</span> <span class="va">population_modules</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">information</span><span class="op">$</span><span class="va">populations</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">2</span>, pointer <span class="op">=</span> <span class="va">population_modules</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">information</span><span class="op">$</span><span class="va">populations</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">3</span>, pointer <span class="op">=</span> <span class="va">population_modules</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">information</span><span class="op">$</span><span class="va">maturity</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span>, pointer <span class="op">=</span> <span class="va">maturity_modules</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">information</span><span class="op">$</span><span class="va">maturity</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">2</span>, pointer <span class="op">=</span> <span class="va">maturity_modules</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>In FIMS, these definitions happen by passing information from the
rcpp interface into FIMS Information in rcpp_maturity.hpp, where
<code>info</code> in the pointer to information and
<code>maturity</code> is the pointer to a specific maturity module.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## // (e.g., maturity = maturity_modules[[1]])</span></span>
<span><span class="co"># info-&gt;maturity_models[maturity-&gt;id] = maturity;</span></span></code></pre></div>
<p>Each population module that is defined in <code>information</code>
must be looped through to set the maturity defined in the user-specified
Rcpp interface back out to the Population class used to run all the
calculations in the model.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">it</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">population_modules</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># for (population_iterator it = this-&gt;populations.begin();</span></span>
<span>  <span class="co">#      it != this-&gt;populations.end(); ++it) {</span></span>
<span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">information</span><span class="op">$</span><span class="va">populations</span><span class="op">[[</span><span class="va">it</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="co"># std::shared_ptr&lt;fims_popdy::Population&lt;Type&gt; &gt; p = (*it).second;</span></span>
<span></span>
<span>  <span class="va">maturity_uint</span> <span class="op">&lt;-</span> <span class="va">p</span><span class="op">$</span><span class="va">pointer</span><span class="op">$</span><span class="va">maturity_id</span></span>
<span>  <span class="co"># uint32_t maturity_uint = static_cast&lt;uint32_t&gt;(p-&gt;maturity_id);</span></span>
<span></span>
<span>  <span class="va">newit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">information</span><span class="op">$</span><span class="va">maturity</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">id</span><span class="op">)</span> <span class="op">==</span> <span class="va">maturity_uint</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="co"># maturity_models_iterator it = this-&gt;maturity_models.find(maturity_uint)</span></span>
<span></span>
<span>  <span class="va">p</span><span class="op">$</span><span class="va">pointer</span><span class="op">$</span><span class="va">maturity</span> <span class="co"># MaturityBase</span></span>
<span>  <span class="va">p</span><span class="op">$</span><span class="va">pointer</span><span class="op">$</span><span class="va">maturity</span> <span class="op">&lt;-</span> <span class="va">information</span><span class="op">$</span><span class="va">maturity</span><span class="op">[[</span><span class="va">newit</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">p</span><span class="op">$</span><span class="va">pointer</span><span class="op">$</span><span class="va">maturity</span> <span class="co"># LogisticMaturity1</span></span>
<span>  <span class="co"># p-&gt;maturity = (*it).second;</span></span>
<span></span>
<span>  <span class="va">population_modules</span><span class="op">[[</span><span class="va">it</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">$</span><span class="va">maturity</span> <span class="op">&lt;-</span> <span class="va">p</span><span class="op">$</span><span class="va">pointer</span><span class="op">$</span><span class="va">maturity</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">population_modules</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">$</span><span class="va">maturity</span><span class="op">)</span></span>
<span><span class="co">#&gt;                  Pop 1 Pop 2 Pop 3</span></span>
<span><span class="co">#&gt; id               1     1     2    </span></span>
<span><span class="co">#&gt; inflection_point 10    10    8    </span></span>
<span><span class="co">#&gt; slope            0.2   0.2   0.3</span></span></code></pre></div>
<p>In R, the above code sets up an intermediate value, <code>p</code>.
Once maturity from p is updated to equal the correct maturity module,
<code>p$pointer$maturity &lt;- information$maturity[[newit]][[2]]</code>,
the above code passes this back to population_modules,
<code>population_modules[[it]][2]$maturity &lt;- p$pointer$maturity</code>.
In this context, <code>population_modules</code> is the population class
held in memory that is being used to run calculations.</p>
<p>The deeper level of abstraction happening in C++ is that in FIMS,
<em>p is the population module</em> stored in memory. An equivalent line
of code to
<code>population_modules[[it]][2]$maturity &lt;- p$pointer$maturity</code>
isnâ€™t needed in FIMS because when we update p, we are also updating the
population class held in memory that is being used to run
calculations.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Kelli F. Johnson, Jon K. T. Brodziak, Kathryn L. Doering, Andrea M. Havron, Ronald Klasky, Peter T. Kuriyama, Christopher M. Legault, Bai Li, Timothy J. Miller, Cole C. Monnahan, Megumi C. Oshima, Kyle W. Shertzer, Christine C. Stawitz, Jane Y. Sullivan, Matthew Supernaw, Ian G. Taylor, Nathan R. Vaughan.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
