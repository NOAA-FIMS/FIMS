set -x
set -e

which cmake



rm -rf builds

cmake -H. -B src/builds \
    -DCMAKE_VERBOSE_MAKEFILE=ON \
    -DCMAKE_INSTALL_PREFIX=_install \
    -DCMAKE_SHARED_LIBRARY_PREFIX_CXX=""
 

: ${R_HOME=`R RHOME`}
if test -z "${R_HOME}"; then
  echo "could not determine R_HOME"
  exit 1
fi
CC=`"${R_HOME}/bin/R" CMD config CC`
CFLAGS=`"${R_HOME}/bin/R" CMD config CFLAGS`
CPPFLAGS=`"${R_HOME}/bin/R" CMD config CPPFLAGS`
LDFLAGS=`"${R_HOME}/bin/R" CMD config LDFLAGS`

cd src
mkdir builds && cd builds
cmake ..



cd ..

cmake --build src/builds --target install --config Release

# Linux
cp src/builds/FIMS.so libs/FIMS.so || echo "Failed: FIMS.so -> src"

# Mac
cp src/builds/FIMS.dylib libs/FIMS.so || echo "Failed: FIMS.dylib -> src"

cp -r src/tests tests


echo "Cleaning build files..."

#clean up src directory
rm -r src/_deps
rm -r src/builds
rm -r src/bin
rm -r src/CMakeFiles
rm -r src/lib

rm src/CMakeCache.txt
rm src/CTestTestfile.cmake
rm src/cmake_install.cmake
rm src/Makefile

echo "Done."