# Instructions ----
#' This file follows the format generated by FIMS:::use_testthat_template().
#' Necessary tests include input and output (IO) correctness [IO
#' correctness], edge-case handling [Edge handling], and built-in errors and
#' warnings [Error handling]. See `?FIMS:::use_testthat_template` for more
#' information. Every test should have a @description tag that takes up just
#' one line, which will be used in the bookdown report of {testthat} results.

# rcpp selectivity ----
## Setup ----
# Load or prepare any necessary data for testing

## IO correctness ----
test_that("rcpp logistic selectivity works with correct inputs", {
  #' @description Test that logistic selectivity works with correct inputs.
  # Create selectivity1
  selectivity1 <- methods::new(LogisticSelectivity)

  selectivity1$inflection_point[1]$value <- 10.0
  selectivity1$inflection_point[1]$min <- 8.0
  selectivity1$inflection_point[1]$max <- 12.0
  selectivity1$inflection_point[1]$estimation_type <- "random_effects"
  selectivity1$slope[1]$value <- 0.2

  expect_equal(selectivity1$get_id(), 1)
  expect_equal(selectivity1$inflection_point[1]$value, 10.0)
  expect_equal(selectivity1$inflection_point[1]$min, 8.0)
  expect_equal(selectivity1$inflection_point[1]$max, 12.0)
  expect_equal(selectivity1$inflection_point[1]$estimation_type, "random_effects")
  expect_equal(selectivity1$slope[1]$value, 0.2)
  expect_equal(selectivity1$evaluate(10.0), 0.5)

  # Create selectivity2
  selectivity2 <- methods::new(LogisticSelectivity)
  expect_equal((selectivity2$get_id()), 2)

  clear()
})

test_that("rcpp double logistic selectivity works with correct inputs", {
  #' @description Test that selectivity works with correct inputs.
  # Create selectivity1
  selectivity1 <- methods::new(DoubleLogisticSelectivity)

  selectivity1$inflection_point_asc[1]$value <- 10.5
  selectivity1$slope_asc[1]$value <- 0.2
  selectivity1$slope_asc[1]$estimation_type <- "fixed_effects"
  selectivity1$inflection_point_desc[1]$value <- 15.0
  selectivity1$slope_desc[1]$value <- 0.05

  expect_equal(selectivity1$get_id(), 1)
  expect_equal(selectivity1$inflection_point_asc[1]$value, 10.5)
  expect_equal(selectivity1$slope_asc[1]$value, 0.2)
  expect_equal(
    selectivity1$evaluate(34.5),
    # Line below equals 0.2716494
    1.0 / (1.0 + exp(-(34.5 - 10.5) * 0.2)) * (1.0 - 1.0 / (1.0 + exp(-(34.5 - 15) * 0.05))),
    tolerance = 0.0000001
  )

  # Create selectivity2
  selectivity2 <- methods::new(DoubleLogisticSelectivity)

  selectivity2$inflection_point_asc[1]$value <- 10.5
  selectivity2$slope_asc[1]$value <- 0.2
  selectivity2$inflection_point_desc[1]$value <- 15.0
  selectivity2$slope_desc[1]$value <- 0.05

  selectivity2$inflection_point_asc[1]$estimation_type <- "random_effects"
  selectivity2$inflection_point_desc[1]$estimation_type <- "random_effects"
  selectivity2$slope_asc[1]$estimation_type <- "random_effects"
  selectivity2$slope_desc[1]$estimation_type <- "random_effects"

  expect_equal(selectivity2$get_id(), 2)
  expect_equal(selectivity2$inflection_point_asc[1]$value, 10.5)
  expect_equal(selectivity2$slope_asc[1]$value, 0.2)
  expect_equal(selectivity2$inflection_point_asc[1]$estimation_type, "random_effects")
  expect_equal(selectivity2$inflection_point_desc[1]$estimation_type, "random_effects")
  expect_equal(selectivity2$slope_asc[1]$estimation_type, "random_effects")
  expect_equal(selectivity2$slope_desc[1]$estimation_type, "random_effects")
  expect_equal(
    selectivity2$evaluate(34.5),
    # Line below equals 0.2716494
    1.0 / (1.0 + exp(-(34.5 - 10.5) * 0.2)) * (1.0 - 1.0 / (1.0 + exp(-(34.5 - 15) * 0.05))),
    tolerance = 0.0000001
  )
  clear()
})

## Edge handling ----
test_that("rcpp selectivity returns correct outputs for edge cases", {
  #' @description Test that rcpp selectivity returns default values when no
  #' parameters are set for input values of 20.

  # emptyLogistic
  emptyLogistic <- methods::new(LogisticSelectivity)
  expect_equal(
    object = emptyLogistic$evaluate(20),
    expected = 0.5
  )

  # emptyDoubleLogistic
  emptyDoubleLogistic <- methods::new(DoubleLogisticSelectivity)
  expect_equal(
    object = emptyDoubleLogistic$evaluate(20),
    expected = 0.25
  )
})

## Error handling ----
# No built-in errors to test.
