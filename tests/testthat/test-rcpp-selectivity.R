# Instructions ----
#' This file follows the format generated by FIMS:::use_testthat_template().
#' Necessary tests include input and output (IO) correctness [IO
#' correctness], edge-case handling [Edge handling], and built-in errors and
#' warnings [Error handling]. See `?FIMS:::use_testthat_template` for more
#' information. Every test should have a @description tag, which can span
#' multiple lines, that will be used in the bookdown report of the results from
#' {testthat}.

# rcpp selectivity ----
## Setup ----
# Load or prepare any necessary data for testing

## IO correctness ----
test_that("rcpp logistic selectivity works with correct inputs", {
  # Create selectivity1
  selectivity1 <- methods::new(LogisticSelectivity)

  selectivity1$inflection_point[1]$value <- 10.0
  selectivity1$inflection_point[1]$min <- 8.0
  selectivity1$inflection_point[1]$max <- 12.0
  selectivity1$inflection_point[1]$estimation_type$set("random_effects")
  selectivity1$slope[1]$value <- 0.2
  #' @description Test that `get_id()` for `LogisticSelectivity` works.
  expect_equal(selectivity1$get_id(), 1)
  #' @description Test that the `inflection_point` value is set to 10.0.
  expect_equal(selectivity1$inflection_point[1]$value, 10.0)
  #' @description Test that the `inflection_point` min is set to 8.0.
  expect_equal(selectivity1$inflection_point[1]$min, 8.0)
  #' @description Test that the `inflection_point` max is set to 12.0.
  expect_equal(selectivity1$inflection_point[1]$max, 12.0)
  #' @description Test that the `inflection_point` estimation type is set to "random_effects".
  expect_equal(selectivity1$inflection_point[1]$estimation_type$get(), "random_effects")
  #' @description Test that the `slope` value is set to 0.2.
  expect_equal(selectivity1$slope[1]$value, 0.2)
  #' @description Test that the `evaluate()` works for `LogisticSelectivity`.
  expect_equal(selectivity1$evaluate(10.0), 0.5)

  # Create selectivity2
  selectivity2 <- methods::new(LogisticSelectivity)
  #' @description Test that `get_id()` for `LogisticSelectivity` works when a second object is created.
  expect_equal((selectivity2$get_id()), 2)

  clear()
})

test_that("rcpp double logistic selectivity works with correct inputs", {
  # Create selectivity1
  selectivity1 <- methods::new(DoubleLogisticSelectivity)

  selectivity1$inflection_point_asc[1]$value <- 10.5
  selectivity1$slope_asc[1]$value <- 0.2
  selectivity1$slope_asc[1]$estimation_type$set("fixed_effects")
  selectivity1$inflection_point_desc[1]$value <- 15.0
  selectivity1$slope_desc[1]$value <- 0.05

  #' @description Test that `get_id()` for `DoubleLogisticSelectivity` works.
  expect_equal(selectivity1$get_id(), 1)
  #' @description Test that the `inflection_point_asc` value is set to 10.5.
  expect_equal(selectivity1$inflection_point_asc[1]$value, 10.5)
  #' @description Test that the `slope_asc` value is set to 0.2.
  expect_equal(selectivity1$slope_asc[1]$value, 0.2)
  #' @description Test that `evaluate()` works for `DoubleLogisticSelectivity`.
  expect_equal(
    selectivity1$evaluate(34.5),
    # Line below equals 0.2716494
    1.0 / (1.0 + exp(-(34.5 - 10.5) * 0.2)) * (1.0 - 1.0 / (1.0 + exp(-(34.5 - 15) * 0.05))),
    tolerance = 0.0000001
  )

  # Create selectivity2
  selectivity2 <- methods::new(DoubleLogisticSelectivity)

  selectivity2$inflection_point_asc[1]$value <- 10.5
  selectivity2$slope_asc[1]$value <- 0.2
  selectivity2$inflection_point_desc[1]$value <- 15.0
  selectivity2$slope_desc[1]$value <- 0.05

  selectivity2$inflection_point_asc[1]$estimation_type$set("random_effects")
  selectivity2$inflection_point_desc[1]$estimation_type$set("random_effects")
  selectivity2$slope_asc[1]$estimation_type$set("random_effects")
  selectivity2$slope_desc[1]$estimation_type$set("random_effects")

  #' @description Test that `get_id()` for `DoubleLogisticSelectivity` works when a second object is created.
  expect_equal(selectivity2$get_id(), 2)
  #' @description Test that the `inflection_point_asc` value is set to 10.5.
  expect_equal(selectivity2$inflection_point_asc[1]$value, 10.5)
  #' @description Test that the `slope_asc` value is set to 0.2.
  expect_equal(selectivity2$slope_asc[1]$value, 0.2)
  #' @description Test that the `inflection_point_asc` estimation type is set to "random_effects".
  expect_equal(selectivity2$inflection_point_asc[1]$estimation_type$get(), "random_effects")
  #' @description Test that the `inflection_point_desc` estimation type is set to "random_effects".
  expect_equal(selectivity2$inflection_point_desc[1]$estimation_type$get(), "random_effects")
  #' @description Test that the `slope_asc` estimation type is set to "random_effects".
  expect_equal(selectivity2$slope_asc[1]$estimation_type$get(), "random_effects")
  #' @description Test that the `slope_desc` estimation type is set to "random_effects".
  expect_equal(selectivity2$slope_desc[1]$estimation_type$get(), "random_effects")
  #' @description Test that `evaluate()` works for `DoubleLogisticSelectivity` when all parameters are set to "random_effects".
  expect_equal(
    selectivity2$evaluate(34.5),
    # Line below equals 0.2716494
    1.0 / (1.0 + exp(-(34.5 - 10.5) * 0.2)) * (1.0 - 1.0 / (1.0 + exp(-(34.5 - 15) * 0.05))),
    tolerance = 0.0000001
  )
  clear()
})


test_that("rcpp descending logistic selectivity works with correct inputs", {
  # Create selectivity1
  selectivity1 <- methods::new(DescendingLogisticSelectivity)
  selectivity1$inflection_point_desc[1]$value <- 15.0
  selectivity1$inflection_point_desc[1]$estimation_type$set("fixed_effects")
  selectivity1$slope_desc[1]$value <- 0.05
  selectivity1$slope_desc[1]$estimation_type$set("fixed_effects")

  #' @description Test that `get_id()` for `DescendingLogisticSelectivity` works.
  expect_equal(selectivity1$get_id(), 1)
  #' @description Test that the `inflection_point_desc` value is set to 15.
  expect_equal(selectivity1$inflection_point_desc[1]$value, 15.0)
  #' @description Test that the `slope_desc` value is set to 0.05.
  expect_equal(selectivity1$slope_desc[1]$value, 0.05)
  #' @description Test that `evaluate()` works for `DescendingLogisticSelectivity`.
  expect_equal(
    selectivity1$evaluate(34.5),
    # Line below equals 0.2716494
    (1.0 - 1.0 / (1.0 + exp(-(34.5 - 15) * 0.05))),
    tolerance = 0.0000001
  )

  # Create selectivity2
  selectivity2 <- methods::new(DescendingLogisticSelectivity)
  selectivity2$inflection_point_desc[1]$value <- 12.0
  selectivity2$slope_desc[1]$value <- 0.1

  selectivity2$inflection_point_desc[1]$estimation_type$set("random_effects")
  selectivity2$slope_desc[1]$estimation_type$set("random_effects")

  #' @description Test that `get_id()` for `DescendingLogisticSelectivity` works when a second object is created.
  expect_equal(selectivity2$get_id(), 2)
  #' @description Test that the `inflection_point_desc` value is set to 10.5.
  expect_equal(selectivity2$inflection_point_desc[1]$value, 12)
  #' @description Test that the `slope_desc` value is set to 0.2.
  expect_equal(selectivity2$slope_desc[1]$value, 0.1)
  #' @description Test that the `inflection_point_desc` estimation type is set to "random_effects".
  expect_equal(selectivity2$inflection_point_desc[1]$estimation_type$get(), "random_effects")
  #' @description Test that the `slope_desc` estimation type is set to "random_effects".
  expect_equal(selectivity2$slope_desc[1]$estimation_type$get(), "random_effects")
  #' @description Test that `evaluate()` works for `DoubleLogisticSelectivity` when all parameters are set to "random_effects".
  expect_equal(
    selectivity2$evaluate(34.5),
    # Line below equals 0.2716494
    (1.0 - 1.0 / (1.0 + exp(-(34.5 - 12) * 0.1))),
    tolerance = 0.0000001
  )
  clear()
})

## Edge handling ----
test_that("rcpp selectivity returns correct outputs for edge cases", {
  # emptyLogistic
  emptyLogistic <- methods::new(LogisticSelectivity)
  #' @description Test that rcpp selectivity returns default values when no parameters are set for input values of 20.
  expect_equal(
    object = emptyLogistic$evaluate(20),
    expected = 0.5
  )

  # emptyDoubleLogistic
  emptyDoubleLogistic <- methods::new(DoubleLogisticSelectivity)
  #' @description Test that rcpp double selectivity returns default values when no parameters are set for input values of 20.
  expect_equal(
    object = emptyDoubleLogistic$evaluate(20),
    expected = 0.25
  )
})

## Error handling ----
# No built-in errors to test.
