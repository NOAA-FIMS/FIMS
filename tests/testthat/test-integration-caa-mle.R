# Instructions ----
#' This file follows the format generated by FIMS:::use_testthat_template().
#' Necessary tests include input and output (IO) correctness [IO
#' correctness], edge-case handling [Edge handling], and built-in errors and
#' warnings [Error handling]. See `?FIMS:::use_testthat_template` for more
#' information. Every test should have a @description tag, which can span
#' multiple lines, that will be used in the bookdown report of the results from
#' {testthat}.

# Deterministic test ----
## Setup ----
# Load necessary data for the integration test
if (!file.exists(test_path("fixtures", "fit_age_length_comp.RDS"))) {
  prepare_test_data()
}

load(test_path("fixtures", "integration_test_data.RData"))

# Set the iteration ID to 1 for accessing specific input/output list
iter_id <- 1

# Run FIMS without wrappers
result <- setup_and_run_FIMS_without_wrappers(
  iter_id = iter_id,
  om_input_list = om_input_list,
  om_output_list = om_output_list,
  em_input_list = em_input_list,
  estimation_mode = FALSE
)

## IO correctness ----
test_that("catch-at-age model (deterministic MLE without wrappers) works with correct inputs", {
  #' @description Test that the output from FIMS run matches the model comparison project OM values.
  verify_fims_deterministic(
    report = result[["report"]],
    estimates = result[["sdr_fixed"]],
    om_input = om_input_list[[iter_id]],
    om_output = om_output_list[[iter_id]],
    em_input = em_input_list[[iter_id]],
    use_fimsfit = FALSE
  )

  #' @description Test that the NLLs from FIMS match the "true" NLLs from the model comparison project.
  verify_fims_nll(
    report = result[["report"]],
    om_input = om_input_list[[iter_id]],
    om_output = om_output_list[[iter_id]],
    em_input = em_input_list[[iter_id]]
  )

  # TODO: change parameter number to 77 after fixing log_devs estimation error
  #' @description Test that the number of parameters is correct for deterministic run.
  expect_equal(length(result[["obj"]][["par"]]), 48)
})

## Edge handling ----
# No edge cases to test.

## Error handling ----
# No built-in errors to test.

# Estimation test ----
## Setup ----
result <- setup_and_run_FIMS_without_wrappers(
  iter_id = iter_id,
  om_input_list = om_input_list,
  om_output_list = om_output_list,
  em_input_list = em_input_list,
  estimation_mode = TRUE
)
## IO correctness ----
# Compare FIMS results with model comparison project OM values
## IO correctness ----
test_that("catch-at-age model (estimation MLE without wrappers) works with correct inputs", {
  #' @description Test that the output from FIMS matches the model comparison project OM values.
  validate_fims(
    report = result[["report"]],
    estimates = result[["sdr_report"]],
    om_input = om_input_list[[iter_id]],
    om_output = om_output_list[[iter_id]],
    em_input = em_input_list[[iter_id]]
  )

  out_of_tolerance_parameters <- cbind(
    result[["parameters"]][["p"]],
    result[["sdr_fixed"]]
  ) |>
    as.data.frame() |>
    setNames(c("input", "estimate", "uncertainty")) |>
    dplyr::mutate(
      within_2SE = abs(estimate - input) <= qnorm(.975) * uncertainty
    ) |>
    dplyr::filter(!within_2SE) |>
    nrow()
  #' @description Test that the 95% of the parameter estimates fall within 2*SE.
  expect_equal(out_of_tolerance_parameters, 0)
})

## Edge handling ----
test_that("catch-at-age model (estimation MLE without wrappers) returns correct outputs for edge cases", {
  # Introduce a missing value in survey observations for the EM input
  na_value <- -999
  na_index <- 2
  em_input_list[[iter_id]][["surveyB.obs"]][["survey1"]][na_index] <- na_value

  # Run the FIMS setup and execution function
  result <- setup_and_run_FIMS_without_wrappers(
    iter_id = iter_id,
    om_input_list = om_input_list,
    om_output_list = om_output_list,
    em_input_list = em_input_list,
    estimation_mode = TRUE
  )

  #' @description Test that FIMS runs with missing values in survey index observations using NA (missing value) placeholder in the second value and the report is not NULL.
  expect_false(is.null(result[["report"]]))

  # Obtain the gradient and Hessian matrix
  g <- as.numeric(result[["obj"]][["gr"]](result[["opt"]][["par"]]))
  h <- optimHess(
    result[["opt"]][["par"]],
    fn = result[["obj"]][["fn"]],
    gr = result[["obj"]][["gr"]]
  )
  result[["opt"]][["par"]] <- result[["opt"]][["par"]] - solve(h, g)
  # Obtain the maximum absolute gradient to check convergence
  max_gradient <- max(abs(result[["obj"]][["gr"]](result[["opt"]][["par"]])))

  #' @description Test that the maximum gradient is less than or equal to 0.0001 after running FIMS with missing values in survey index observations.
  expect_lte(max_gradient, 0.0001)

  # Store the original values of the number of landings observations and
  # survey observations
  n.L_original <- om_input_list[[iter_id]][["n.L"]][["fleet1"]]
  n.survey_original <- om_input_list[[iter_id]][["n.survey"]][["survey1"]]

  # Set the number of landings observations and survey observations to 1
  om_input_list[[iter_id]][["n.L"]][["fleet1"]] <- 1
  om_input_list[[iter_id]][["n.survey"]][["survey1"]] <- 1
  on.exit(
    om_input_list[[iter_id]][["n.L"]][["fleet1"]] <- n.L_original,
    add = TRUE
  )
  on.exit(
    om_input_list[[iter_id]][["n.survey"]][["survey1"]] <- n.survey_original,
    add = TRUE
  )

  # Run the FIMS setup and execution function
  result <- setup_and_run_FIMS_without_wrappers(
    iter_id = iter_id,
    om_input_list = om_input_list,
    om_output_list = om_output_list,
    em_input_list = em_input_list,
    estimation_mode = TRUE
  )

  #' @description Test that FIMS runs with only one observation in landings and survey data and the report is not NULL.
  validate_fims(
    report = result[["report"]],
    estimates = result[["sdr_report"]],
    om_input = om_input_list[[iter_id]],
    om_output = om_output_list[[iter_id]],
    em_input = em_input_list[[iter_id]]
  )
})

## Error handling ----
# No built-in errors to test.
