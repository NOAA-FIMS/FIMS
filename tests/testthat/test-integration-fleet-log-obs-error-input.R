# Instructions ----
#' This file follows the format generated by FIMS:::use_testthat_template().
#' Necessary tests include input and output (IO) correctness [IO
#' correctness], edge-case handling [Edge handling], and built-in errors and
#' warnings [Error handling]. See `?FIMS:::use_gtest_template` for more
#' information. Every test should have a @description tag, which can span
#' multiple lines, that will be used in the bookdown report of the results from
#' {testthat}.

# use_*_template ----
## setup ----
# Set up for all of the use_*_template functions in the following section.

# This is a meta-test that creates a temporary package structure to test the use
# of the `use_gtest_template()` and `use_testthat_template()` functions. It works
# inside the temporary environment created by the test file. However, it does not
# work when using the reporting tool {testdown} because it cannot
# find the path back to the original test file in the GitHub Actions runner. This
# leads to errors like: In normalizePath(attr(result$srcref, "srcfile")$filename) :
# path[1]="test-use-test-template.R": No such file or directory. To fix the issue,
# we need to skip the test file when generating {testdown} reports.
if (Sys.getenv("INPUT_TESTDOWN") == "true") {
  #' @description Skip the test in {testdown} reports generation.
  skip("Skipping test in {testdown} reports generation.")
}

load(test_path("fixtures", "integration_test_data.RData"))


## IO correctness ----
test_that("`log_obs_error scalar` works with correct inputs", {
  
      #' @description Test that `log_obs_error` works when it is a scalar.
      
      # Load sample data
      data("data1")
      # Prepare data for FIMS model
      data_4_model <- FIMSFrame(data1)

      # Create parameters
      default_parameters <- data_4_model |>
        create_default_configurations() |>
        create_default_parameters(data = data_4_model)
      
      parameters_4_model <- default_parameters |>
        tidyr::unnest(cols = data) |>
        # remove all but one log_obs_sd initial values for Fleet1
        dplyr::filter(
          !(fleet_name == "fleet1" & label == "log_sd" & time > 1) | 
          is.na(fleet_name == "fleet1" & label == "log_sd" & time > 1)
        ) 

      
      test_fit <- parameters_4_model |>
        initialize_fims(data = data_4_model) |>
        fit_fims(optimize = FALSE)
      
      json_estimates <- reshape_json_estimates(test_fit@model_output)

      json_estimates |> dplyr::filter(module_name == "Fleet")
        
    

 
      expect_true(object)

})

## Edge handling ----
test_that("`use_gtest_template()` handles edge cases correctly", {
  withr::with_dir(
    new = temp_path,
    code = {
      error <- tryCatch(
        FIMS:::use_gtest_template(name = "ClassName_FunctionName"),
        error = function(e) {
          # Return a custom error message if an error occurs
          "Invalid `name` format"
        }
      )
      #' @description Test that `use_gtest_template()` throws an error when the file already exists.
      expect_equal(error, "Invalid `name` format")
    }
  )
})

## Error handling ----
test_that("`use_gtest_template()` returns correct error messages", {
  withr::with_dir(
    new = temp_path,
    code = {
      error <- tryCatch(
        FIMS:::use_gtest_template(
          name = "FIMSMath_ClassName_Logistic"
        ),
        error = function(e) {
          # Return a custom error message if an error occurs
          "An error occurred."
        }
      )
      #' @description Test that `use_gtest_template()` throws an error when the file already exists.
      expect_equal(error, "An error occurred.")

      file.rename(
        from = file.path(temp_path, cmakelist_path),
        to = file.path(temp_path, "tests", "gtest", "renamed.txt")
      )

      error <- tryCatch(
        suppressMessages(
          FIMS:::use_gtest_template(name = "FIMSMath_ClassName_FunctionName")
        ),
        error = function(e) {
          # Return a custom error message if an error occurs
          "An error occurred."
        }
      )
      #' @description Test that `use_gtest_template()` throws an error when the file already exists.
      expect_equal(error, "An error occurred.")

      file.rename(
        from = file.path(temp_path, "tests", "gtest", "renamed.txt"),
        to = file.path(temp_path, cmakelist_path)
      )
    }
  )
})

# use_testthat_template ----
## setup ----
# No additional setup is needed.

## IO correctness ----
test_that("`use_testthat_template()` works with correct inputs", {
  withr::with_dir(
    new = temp_path,
    code = {
      suppressMessages(FIMS:::use_testthat_template("individual_function"))
      object_individual_function <- file.exists(
        file.path(
          temp_path, "tests", "testthat", "test-individual_function.R"
        )
      )
      #' @description Test that `use_testthat_template("individual_function")` creates the correct file.
      expect_true(object_individual_function)

      suppressMessages(FIMS:::use_testthat_template("function-group"))
      object_function_group <- file.exists(
        file.path(temp_path, "tests", "testthat", "test-function-group.R")
      )
      #' @description Test that `use_testthat_template("function-group")` creates the correct file.
      expect_true(object_function_group)
    }
  )
})

## Edge handling ----
test_that("`use_testthat_template()` handles edge cases correctly", {
  withr::with_dir(
    new = temp_path,
    code = {
      #' @description Test that `use_testthat_template()` throws an error when no input is provided.
      expect_error(object = FIMS:::use_testthat_template())
    }
  )
})

## Error handling ----
test_that("`use_testthat_template()` returns correct error messages", {
  withr::with_dir(
    new = temp_path,
    code = {
      # Attempt to use the test template again inside a tryCatch to capture any
      # potential errors
      error <- tryCatch(FIMS:::use_testthat_template("individual_function"),
        error = function(e) {
          # Return a custom error message if an error occurs
          "An error occurred."
        }
      )
      #' @description Test that `use_testthat_template("individual_function")` throws an error when the file already exists.
      expect_equal(error, "An error occurred.")
    }
  )
})
