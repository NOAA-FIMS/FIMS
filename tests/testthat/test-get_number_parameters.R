# Instructions ----
#' This file follows the format generated by FIMS:::use_testthat_template().
#' Necessary tests include input and output (IO) correctness [IO
#' correctness], edge-case handling [Edge handling], and built-in errors and
#' warnings [Error handling]. See `?FIMS:::use_testthat_template` for more
#' information. Every test should have a @description tag that takes up just
#' one line, which will be used in the bookdown report of {testthat} results.

# get_number_of_parameters ----
## Setup ----
# Load or prepare any necessary data for testing
if (!file.exists(test_path("fixtures", "fit_age_length_comp.RDS"))) {
  prepare_test_data()
}
## IO correctness ----
test_that("get_number_of_parameters() works with correct inputs", {
  # Load the test data from an RDS file containing model fits.
  # List all RDS files in the fixtures directory that match the pattern "fit*_.RDS"
  fit_files <- list.files(
    path = test_path("fixtures"),
    pattern = "^fit.*\\.RDS$",
    full.names = TRUE
  )

  # Function to read the RDS file and get input
  check_number_of_parameters <- function(fit_file) {
    fit_data <- readRDS(fit_file)
    expected_n_total <- length(fit_data@obj[["env"]][["last.par.best"]])
    expected_n_fixed_effects <- length(fit_data@obj[["par"]])
    expected_n_random_effects <- length(fit_data@obj[["env"]][["parList()"]][["re"]])
    number_of_parameters <- get_number_of_parameters(fit_data)
    expected_vector <- c(
      total = expected_n_total,
      fixed_effects = expected_n_fixed_effects,
      random_effects = expected_n_random_effects
    )
    #' @description Test that [get_number_of_parameters()] returns correct
    #' output for the number_of_parameters slot.
    expect_equal(
      object = number_of_parameters,
      expected = fit_data@number_of_parameters
    )
    #' @description Test that [get_number_of_parameters()] returns correct
    #' names for the number_of_parameters slot.
    expect_equal(
      object = number_of_parameters,
      expected = expected_vector
    )
  }

  # Use purrr::map to apply the function to each file
  result <- purrr::map(fit_files, check_number_of_parameters)
})

## Edge handling ----
test_that("get_number_of_parameters() returns correct outputs for edge cases", {
  #' @description Test that [get_number_of_parameters()] returns an error when
  #' given invalid input.
  expect_error(
    object = get_number_of_parameters("invalid_input")
  )
})

## Error handling ----
# No built-in errors to test.
