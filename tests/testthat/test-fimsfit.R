# Instructions ----
#' This file follows the format generated by FIMS:::use_testthat_template().
#' Necessary tests include input and output (IO) correctness [IO
#' correctness], edge-case handling [Edge handling], and built-in errors and
#' warnings [Error handling]. See `?FIMS:::use_testthat_template` for more
#' information. Every test should have a @description tag, which can span
#' multiple lines, that will be used in the bookdown report of the results from
#' {testthat}.

# FIMSFit ----
## Setup ----
# Load the test data from an RDS file containing the fitted model estimates
if (!file.exists(testthat::test_path("fixtures", "fit_age_length_comp.RDS"))) {
  prepare_test_data()
}

fit_age_length_comp <- readRDS(testthat::test_path("fixtures", "fit_age_length_comp.RDS"))
fit_agecomp <- readRDS(testthat::test_path("fixtures", "fit_agecomp.RDS"))
fit_list <- list(fit_age_length_comp, fit_agecomp)
on.exit(rm(fit_list), add = TRUE)

## IO correctness ----
test_that("`is.FIMSFit()` works with correct inputs", {
  #' @description Test that `is.FIMSFit(fit_age_length_comp)` returns TRUE.
  expect_true(
    object = is.FIMSFit(fit_age_length_comp)
  )

  #' @description Test that `as.list(fit_age_length_comp)` returns a nested list.
  expect_equal(
    object = typeof(as.list(fit_age_length_comp)),
    expected = "list"
  )

  expected_names <- c(
    "input", "obj", "opt", "max_gradient", "report", "sdreport",
    "number_of_parameters", "timing", "version", "model_output"
  )
  #' @description Test that `as.list(fit_age_length_comp)` contains correct components.
  expect_equal(
    object = names(as.list(fit_age_length_comp)),
    expected = expected_names
  )
})

## Edge handling ----
test_that("`is.FIMSFit()` returns correct outputs for edge cases", {
  #' @description Test that `is.FIMSFit("not_a_FIMSFit")` returns FALSE.
  expect_false(is.FIMSFit("not_a_FIMSFit"))

  # Modify the total time to be more than a day
  fit_age_length_comp@timing[["time_total"]] <- 86401 # 60*60*24+1
  #' @description Test that `print(FIMSFit)` returns no error when the total time is more than a day.
  expect_no_error(print(fit_age_length_comp))

  # Modify the total time to be more than a hour
  fit_age_length_comp@timing[["time_total"]] <- 3601 # 60*60+1
  #' @description Test that `print(FIMSFit)` returns no error when the total time is more than an hour.
  expect_no_error(print(fit_age_length_comp))

  # Modify the total time to be more than a minute
  fit_age_length_comp@timing[["time_total"]] <- 61 # 60+1
  #' @description Test that `print(FIMSFit)` returns no error when the total time is more than a minute.
  expect_no_error(print(fit_age_length_comp))
})

## Error handling ----
test_that("fit_fims() errors when optimization fails to converge", {
  # Create a simple test case that will fail to converge by setting
  # extremely restrictive iteration limits
  
  # Skip if test fixtures don't exist
  skip_if_not(file.exists(testthat::test_path("fixtures", "integration_test_data.RData")))
  
  load(testthat::test_path("fixtures", "integration_test_data.RData"))
  
  # Set up the model with data
  data_age_comp <- FIMSFrame(data1)
  parameters <- readRDS(
    testthat::test_path("fixtures", "parameters_model_comparison_project.RDS")
  )
  
  initialized_model <- parameters |>
    initialize_fims(data = data_age_comp)
  
  # Set control parameters that will cause convergence failure
  # by making iteration limits extremely low
  bad_control <- list(
    eval.max = 1,
    iter.max = 1,
    trace = 0
  )
  
  #' @description Test that fit_fims() aborts with an informative error when convergence fails.
  expect_error(
    object = initialized_model |>
      fit_fims(optimize = TRUE, control = bad_control),
    regexp = "Optimization failed convergence checks"
  )
  
  clear()
})
