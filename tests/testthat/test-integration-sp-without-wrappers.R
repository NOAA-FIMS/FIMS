# Instructions ----
#' This file follows the format generated by FIMS:::use_testthat_template().
#' Necessary tests include input and output (IO) correctness [IO
#' correctness], edge-case handling [Edge handling], and built-in errors and
#' warnings [Error handling]. See `?FIMS:::use_testthat_template` for more
#' information. Every test should have a @description tag, which can span
#' multiple lines, that will be used in the bookdown report of the results from
#' {testthat}.

# Deterministic test ----
## Setup ----
#load JABBA results
jabba_output <- readRDS("tests/testthat/fixtures/jabba_output.RDS")
jabba_biomass <- jabba_output$biomass
jabba_pars <- jabba_output$pars
jabba_biomass <- jabba_output$flqs |> 
    dplyr::filter(qname == "biomass") |> dplyr::select(data) |> as.vector()
jabba_expect_depletion <- (jabba_biomass |> unlist() |> unname()) / 
    (jabba_pars |>
      dplyr::filter(rownames(jabba_pars) == "K") |> 
      dplyr::select(Median) |> unlist() |> unname())


## IO correctness ----
test_that("deterministic run works with correct inputs", {
  # Run FIMS surplus production without wrappers
  result <- setup_and_run_sp(bayesian_mode = FALSE, estimation_mode = FALSE)

  #' @description Compare FIMS parameters with JABBA outputs.
  jabba_correct_pars <- c(
    jabba_pars |> 
      dplyr::filter(rownames(jabba_pars) == "q") |> 
      dplyr::select(Median) |> as.vector() |> unlist() |> unname(),
    jabba_pars |> 
      dplyr::filter(rownames(jabba_pars) == "r") |> 
      dplyr::select(Median) |> as.vector() |> unlist() |> unname(),
    jabba_pars |> 
      dplyr::filter(rownames(jabba_pars) == "K") |> 
      dplyr::select(Median) |> as.vector() |> unlist() |> unname()
  )
  expect_equal(result$obj$par |> exp() |> unname(), jabba_correct_pars)

  #' @description Compare FIMS biomass with JABBA biomass.
  for(i in 1: (length(result$report$biomass))) {
    expect_equal(
      (result$report$biomass |> unlist())[i], 
      (jabba_biomass |> unlist() |> unname())[i],
      tolerance = 1e-8
    )
  }

  #' @description Compare FIMS depletion with JABBA depletion.
  for(i in seq_along(result$report$pop_depletion)) {
    expect_equal(
        (result$report$pop_depletion |> unlist() |> unname())[i],
        jabba_expect_depletion[i])
  }

  #' @description Compare FIMS reference points with JABBA reference points.
  #' TODO: uncomment after fixing tests; differences are due to rounding in JABBA output
#   expect_equal(
#     result$report$fmsy |> unlist() |> unname(),
#     jabba_output$estimates |> 
#       dplyr::filter(rownames(jabba_output$estimates) == "Hmsy") |> 
#       dplyr::select(mu) |> as.vector() |> unlist() |> unname()
#   )
#   expect_equal(
#       result$report$bmsy |> unlist() |> unname(),
#       jabba_output$estimates |> 
#         dplyr::filter(rownames(jabba_output$estimates) == "SBmsy") |> 
#         dplyr::select(mu) |> as.vector() |> unlist() |> unname()
#   )
#   expect_equal(
#       result$report$msy |> unlist() |> unname(),
#       jabba_output$estimates |> 
#         dplyr::filter(rownames(jabba_output$estimates) == "MSY") |> 
#         dplyr::select(mu) |> as.vector() |> unlist() |> unname()
#   )


    #' @description Check that FIMS nll matches expected nlls
    # depletion nll
    nll_depletion <- 0
    for(i in seq_along(result$report$pop_depletion |> unlist())) {
    nll_depletion <- nll_depletion + 
        -dnorm(log((result$report$pop_depletion |> unlist())[i]),
        (result$report$log_depletion_expected |> unlist())[i],
        jabba_pars |> 
            dplyr::filter(rownames(jabba_pars) == "tau2") |> 
            dplyr::select(Median) |> sqrt() |> unname() |> as.vector() |> unlist(), 
        TRUE
        )
    }
   
    survey_index_data <- data_sp |> dplyr::filter(type == "index")
    idx <- which(survey_index_data$value != -999)
    survey_index <- survey_index_data[idx,] |> dplyr::select(value) |> 
        as.vector() |> unlist() |> unname()
    nll_index <- rep(0, length(survey_index))
    survey_index_expected <- (result$report$log_index_expected)[[2]][idx] 
    for(i in seq_along(survey_index)){
    nll_index[i] = -dlnorm(
        survey_index[i],
        survey_index_expected[i],
        jabba_pars |> 
            dplyr::filter(rownames(jabba_pars) == "sigma2") |> 
            dplyr::select(Median) |> sqrt() |> unname() |> as.vector() |> unlist(),
        TRUE
    )
    }
    expect_equal(c(nll_depletion, sum(nll_index)), result$report$nll_components,
      tolerance = 1e-6)

})

test_that("MLE run works", {
  # Run FIMS surplus production without wrappers
  result <- setup_and_run_sp(bayesian_mode = FALSE, estimation_mode = TRUE)
  
})
