# Instructions ----
#' This file follows the format generated by FIMS:::use_testthat_template().
#' Necessary tests include input and output (IO) correctness [IO
#' correctness], edge-case handling [Edge handling], and built-in errors and
#' warnings [Error handling]. See `?FIMS:::use_testthat_template` for more
#' information. Every test should have a @description tag, which can span
#' multiple lines, that will be used in the bookdown report of the results from
#' {testthat}.

# test_initialize_modules ----
## Setup ----

data <- FIMS::FIMSFrame(data1)

default_parameters <- create_default_configurations(data = data) |>
  create_default_parameters(data = data) |>
  tidyr::unnest(cols = data)

## IO correctness ----
test_that("`initialize_fims()` works with correct inputs", {
  result <- initialize_fims(parameters = default_parameters, data = data)
  #' @description Test that `initialize_fims()` returns a list.
  expect_type(result, "list")
  #' @description Test that `initialize_fims()` returns an output with correct names.
  expect_named(result, c("parameters", "model"))
  #' @description Test that `initialize_fims()` returns a list with two elements.
  expect_equal(length(result), 2)
  clear()

  result <- initialize_comp(
    data = data,
    fleet_name = "fleet1",
    type = "AgeComp"
  )

  #' @description Test that `initialize_comp()` works with `AgeComp` type and returns an S4 object.
  expect_type(result, "S4")
  #' @description Test that `initialize_comp()` works with `AgeComp` type and does not produce an error.
  expect_no_error(result[["age_comp_data"]])
  #' @description Test that `initialize_comp()` works with `AgeComp` type and sets `length_comp_data` to NULL.
  expect_null(result[["length_comp_data"]])
  #' @description Test that `initialize_comp()` output contains the correct structure.
  expect_true(
    all(c("age_comp_data", "initialize", "finalize", ".pointer") %in%
      names(result))
  )
  #' @description Test that the age-composition data in the returned object from `initialize_comp()` has the correct values.
  expect_equal(
    result$age_comp_data$toRVector(),
    data |>
      get_data() |>
      dplyr::filter(type == "age_comp", name == "fleet1") |>
      dplyr::mutate(out = value * uncertainty) |>
      dplyr::pull(out)
  )
  clear()

  result <- initialize_comp(
    data = data,
    fleet_name = "fleet1",
    type = "LengthComp"
  )
  #' @description Test that `initialize_fims()` works with `LengthComp` type and returns an S4 object.
  expect_type(result, "S4")
  #' @description Test that `initialize_fims()` works with `LengthComp` type and does not produce an error.
  expect_no_error(result[["length_comp_data"]])
  #' @description Test that `initialize_fims()` works with `LengthComp` type and sets `age_comp_data` to NULL.
  expect_null(result[["age_comp_data"]])
  #' @description Test that `initialize_fims()` output contains the correct structure.
  expect_true(
    all(c("length_comp_data", "initialize", "finalize", ".pointer") %in%
      names(result))
  )
  #' @description Test that the length-composition data in the returned object from `initialize_comp()` has the correct values.
  expect_equal(
    result$length_comp_data$toRVector(),
    data |>
      get_data() |>
      dplyr::filter(type == "length_comp", name == "fleet1") |>
      dplyr::mutate(out = value * uncertainty) |>
      dplyr::pull(out)
  )
  clear()
})

## Edge handling ----
test_that("`initialize_fims()` works with edge cases", {
  modified_log_devs <- default_parameters |>
    dplyr::filter(label == "log_devs") |>
    # change first 10 estimation_type for label of log_devs from fixed_effects
    # to constant
    dplyr::mutate(
      estimation_type = dplyr::if_else(
        time <= 11,
        "constant",
        estimation_type
      )
    )

  parameters_multiple_types <- default_parameters |>
    # Remove rows where label is "log_devs" but keep the rows where label is NA
    dplyr::filter(label != "log_devs" | is.na(label)) |>
    dplyr::bind_rows(modified_log_devs)
  init_parm_default <- initialize_fims(parameters = default_parameters, data = data)
  init_parm_multiple_types <- initialize_fims(parameters = parameters_multiple_types, data = data)
  #' @description Test that `initialize_fims()` works with multiple estimation types.
  expect_equal(length(init_parm_multiple_types$parameters$p), length(init_parm_default$parameters$p) - 10)
})

## Error handling ----

test_that("`initialize_fims()` returns correct error messages", {
  #' @description Test that `initialize_fims()` handles missing parameters input correctly.
  expect_error(
    initialize_fims(data = data),
    "The `parameters` argument must be a tibble."
  )
  clear()

  #' @description Test that `initialize_fims()` handles non-list parameters input correctly.
  expect_error(
    initialize_fims(parameters = "not_a_list", data = data),
    "The `parameters` argument must be a tibble."
  )
  clear()

  parameters_no_fleets <- default_parameters |>
    dplyr::filter(!(fleet_name %in% c("fleet1", "survey1")))
  #' @description Test that `initialize_fims()` fails when no fleets are provided.
  expect_error(
    initialize_fims(parameters = parameters_no_fleets, data = data),
    "No fleets found in the provided `parameters`."
  )
  clear()

  #' @description Test that `initialize_comp()` correctly returns error on unknown `fleet_name`.
  expect_error(
    initialize_comp(
      data = data,
      fleet_name = "unknown_fleet",
      type = "AgeComp"
    ),
    "Fleet `unknown_fleet` not found in the data object."
  )
  clear()

  #' @description Test that `initialize_comp()` correctly returns error on unknown `type`.
  expect_error(
    initialize_comp(
      data = data,
      fleet_name = "fleet1",
      type = "unknown"
    ),
    "should be one of"
  )

  clear()

  parameters_wrong_type <- default_parameters |>
    dplyr::mutate(
      estimation_type = dplyr::if_else(
        estimation_type == "fixed_effects",
        "fixed.effects",
        estimation_type
      )
    )
  parameters_wrong_type[["parameters"]][["recruitment"]][["BevertonHoltRecruitment.log_devs.estimation_type"]] <- "fixed.effects"
  #' @description Test that `initialize_fims()` correctly returns an error on an unknown estimation_type.
  expect_error(
    initialize_fims(parameters = parameters_wrong_type, data = data),
    "The `estimation_type` must be one of: constant, fixed_effects, and random_effects."
  )
  clear()
})

# test_initialize_distribution ----
## IO correctness ----
test_that("`initialize_distribution()` works with correct inputs", {
  # Setup for testing initialize_distribution
  module_input <- default_parameters |>
    dplyr::filter(fleet_name == "fleet1" & distribution_type == "Data")
  
  distribution_name <- "dlnorm"
  linked_ids <- c(data_link = 1, fleet_link = 2)
  
  #' @description Test that `initialize_distribution()` returns an S4 object with data distribution.
  result <- initialize_distribution(
    module_input = module_input,
    distribution_name = distribution_name,
    distribution_type = "data",
    linked_ids = linked_ids
  )
  expect_type(result, "S4")
  clear()
})

## Error handling ----
test_that("`initialize_distribution()` returns correct error messages", {
  module_input <- default_parameters |>
    dplyr::filter(fleet_name == "fleet1" & distribution_type == "Data")
  
  #' @description Test that `initialize_distribution()` handles NULL distribution_name correctly.
  result <- initialize_distribution(
    module_input = module_input,
    distribution_name = NULL,
    distribution_type = "data",
    linked_ids = c(data_link = 1, fleet_link = 2)
  )
  expect_null(result)
  clear()
  
  #' @description Test that `initialize_distribution()` handles non-list module_input correctly.
  expect_error(
    initialize_distribution(
      module_input = "not_a_list",
      distribution_name = "dlnorm",
      distribution_type = "data",
      linked_ids = c(data_link = 1, fleet_link = 2)
    ),
    "`module_input` must be a list."
  )
  clear()
  
  #' @description Test that `initialize_distribution()` handles missing linked_ids correctly.
  expect_error(
    initialize_distribution(
      module_input = module_input,
      distribution_name = "dlnorm",
      distribution_type = "data",
      linked_ids = c(data_link = 1)
    ),
    "`linked_ids` must be a named vector containing 'data_link' and"
  )
  clear()
})

# test_initialize_recruitment ----
## IO correctness ----
test_that("`initialize_recruitment()` works with correct inputs", {
  #' @description Test that `initialize_recruitment()` returns an S4 object.
  result <- initialize_recruitment(
    parameters = default_parameters,
    data = data
  )
  expect_type(result, "S4")
  #' @description Test that `initialize_recruitment()` creates a module with expected fields.
  expect_true("get_id" %in% names(result))
  clear()
})

# test_initialize_growth ----
## IO correctness ----
test_that("`initialize_growth()` works with correct inputs", {
  #' @description Test that `initialize_growth()` returns an S4 object.
  result <- initialize_growth(
    parameters = default_parameters,
    data = data
  )
  expect_type(result, "S4")
  #' @description Test that `initialize_growth()` creates a module with expected fields.
  expect_true("get_id" %in% names(result))
  clear()
})

# test_initialize_maturity ----
## IO correctness ----
test_that("`initialize_maturity()` works with correct inputs", {
  #' @description Test that `initialize_maturity()` returns an S4 object.
  result <- initialize_maturity(
    parameters = default_parameters,
    data = data
  )
  expect_type(result, "S4")
  #' @description Test that `initialize_maturity()` creates a module with expected fields.
  expect_true("get_id" %in% names(result))
  clear()
})

# test_initialize_population ----
## IO correctness ----
test_that("`initialize_population()` works with correct inputs", {
  # Setup modules needed for population
  recruitment <- initialize_recruitment(
    parameters = default_parameters,
    data = data
  )
  growth <- initialize_growth(
    parameters = default_parameters,
    data = data
  )
  maturity <- initialize_maturity(
    parameters = default_parameters,
    data = data
  )
  
  linked_ids <- c(
    recruitment = recruitment$get_id(),
    growth = growth$get_id(),
    maturity = maturity$get_id()
  )
  
  #' @description Test that `initialize_population()` returns an S4 object.
  result <- initialize_population(
    parameters = default_parameters,
    data = data,
    linked_ids = linked_ids
  )
  expect_type(result, "S4")
  #' @description Test that `initialize_population()` creates a module with expected fields.
  expect_true("get_id" %in% names(result))
  clear()
})

## Error handling ----
test_that("`initialize_population()` returns correct error messages", {
  #' @description Test that `initialize_population()` handles missing linked_ids correctly.
  expect_error(
    initialize_population(
      parameters = default_parameters,
      data = data,
      linked_ids = c(growth = 1)
    ),
    "`linked_ids` for population must include `growth`, `maturity`, and"
  )
  clear()
})

# test_initialize_selectivity ----
## IO correctness ----
test_that("`initialize_selectivity()` works with correct inputs", {
  #' @description Test that `initialize_selectivity()` returns an S4 object.
  result <- initialize_selectivity(
    parameters = default_parameters,
    data = data,
    fleet_name = "fleet1"
  )
  expect_type(result, "S4")
  #' @description Test that `initialize_selectivity()` creates a module with expected fields.
  expect_true("get_id" %in% names(result))
  clear()
})

# test_initialize_fleet ----
## IO correctness ----
test_that("`initialize_fleet()` works with correct inputs", {
  # Setup selectivity module
  selectivity <- initialize_selectivity(
    parameters = default_parameters,
    data = data,
    fleet_name = "fleet1"
  )
  
  linked_ids <- c(
    selectivity = selectivity$get_id()
  )
  
  #' @description Test that `initialize_fleet()` returns an S4 object.
  result <- initialize_fleet(
    parameters = default_parameters,
    data = data,
    fleet_name = "fleet1",
    linked_ids = linked_ids
  )
  expect_type(result, "S4")
  #' @description Test that `initialize_fleet()` creates a module with expected fields.
  expect_true("get_id" %in% names(result))
  clear()
})

# test_initialize_landings ----
## IO correctness ----
test_that("`initialize_landings()` works with correct inputs", {
  #' @description Test that `initialize_landings()` returns an S4 object for fleet with landings.
  result <- initialize_landings(
    data = data,
    fleet_name = "fleet1"
  )
  expect_type(result, "S4")
  #' @description Test that `initialize_landings()` creates a module with expected fields.
  expect_true("get_id" %in% names(result))
  #' @description Test that `initialize_landings()` module contains landings_data field.
  expect_true("landings_data" %in% names(result))
  clear()
})

## Error handling ----
test_that("`initialize_landings()` returns correct error messages", {
  #' @description Test that `initialize_landings()` handles unknown fleet_name correctly.
  expect_error(
    initialize_landings(
      data = data,
      fleet_name = "unknown_fleet"
    ),
    "Fleet unknown_fleet not found in the data object."
  )
  clear()
})

# test_initialize_index ----
## IO correctness ----
test_that("`initialize_index()` works with correct inputs", {
  #' @description Test that `initialize_index()` returns an S4 object for survey with index.
  result <- initialize_index(
    data = data,
    fleet_name = "survey1"
  )
  expect_type(result, "S4")
  #' @description Test that `initialize_index()` creates a module with expected fields.
  expect_true("get_id" %in% names(result))
  #' @description Test that `initialize_index()` module contains index_data field.
  expect_true("index_data" %in% names(result))
  clear()
})

## Error handling ----
test_that("`initialize_index()` returns correct error messages", {
  #' @description Test that `initialize_index()` handles unknown fleet_name correctly.
  expect_error(
    initialize_index(
      data = data,
      fleet_name = "unknown_fleet"
    ),
    "Fleet unknown_fleet not found in the data object."
  )
  clear()
})

# TODO: most lines with no coverage are error checks that are not verified to
# work via the tests.
