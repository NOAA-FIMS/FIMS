# Instructions ----
#' This file follows the format generated by FIMS:::use_testthat_template().
#' Necessary tests include input and output (IO) correctness [IO
#' correctness], edge-case handling [Edge handling], and built-in errors and
#' warnings [Error handling]. See `?FIMS:::use_testthat_template` for more
#' information. Every test should have a @description tag, which can span
#' multiple lines, that will be used in the bookdown report of the results from
#' {testthat}.

# Setup ----
# Load or prepare any necessary data for testing

# get_fixed ----
## IO correctness ----
test_that("get_fixed() works with correct inputs", {
  #' @description Test that [get_fixed()] works with a logistic selectivity
  #' curve returns the correct number of parameters with their specified
  #' inputs.
  clear()
  # Create selectivity
  selectivity <- methods::new(LogisticSelectivity)
  selectivity$inflection_point[1]$value <- 10.0
  selectivity$inflection_point[1]$estimation_type$set("fixed_effects")
  selectivity$slope[1]$value <- 0.2
  selectivity$slope[1]$estimation_type$set("fixed_effects")

  CreateTMBModel()
  expect_equal(
    c(selectivity$inflection_point[1]$value, selectivity$slope[1]$value),
    get_fixed()
  )
  clear()

  #' @description Test that setting a selectivity parameter to FALSE in a
  #' previously defined module changes the number of parameters.
  selectivity <- methods::new(LogisticSelectivity)
  selectivity$inflection_point[1]$value <- 10.0
  selectivity$slope[1]$value <- 0.2
  selectivity$slope[1]$estimation_type$set("fixed_effects")
  CreateTMBModel()
  expect_equal(
    selectivity$slope[1]$value,
    get_fixed()
  )
  clear()

  #' @description Test that the correct number of parameters are returned for a
  #' double logistic selectivity curve.
  fish_selex <- methods::new(DoubleLogisticSelectivity)
  fish_selex$inflection_point_asc[1]$value <- 2
  fish_selex$inflection_point_asc[1]$estimation_type$set("fixed_effects")
  fish_selex$inflection_point_desc[1]$value <- 3
  fish_selex$inflection_point_desc[1]$estimation_type$set("fixed_effects")
  fish_selex$slope_asc[1]$value <- 1
  fish_selex$slope_asc[1]$estimation_type$set("constant")
  fish_selex$slope_desc[1]$value <- 1.5
  fish_selex$slope_desc[1]$estimation_type$set("fixed_effects")

  CreateTMBModel()
  sel_parm <- c(
    fish_selex$inflection_point_asc[1]$value,
    fish_selex$inflection_point_desc[1]$value,
    fish_selex$slope_desc[1]$value
  )
  expect_equal(get_fixed(), sel_parm)
  clear()

  #' @description Test the counting of parameters when multiple modules are
  #' involved, e.g., selectivity and recruitment.
  selectivity <- methods::new(LogisticSelectivity)
  selectivity$inflection_point[1]$value <- 11.0
  selectivity$inflection_point[1]$min <- 8.0
  selectivity$inflection_point[1]$max <- 12.0
  selectivity$inflection_point[1]$estimation_type$set("fixed_effects")
  selectivity$slope[1]$value <- 0.5
  selectivity$slope[1]$estimation_type$set("fixed_effects")
  sel_parm <- c(selectivity$inflection_point[1]$value, selectivity$slope[1]$value)
  recruitment <- methods::new(BevertonHoltRecruitment)
  h <- 0.75
  r0 <- 1000000.0
  spawns <- 9.55784 * 10^6
  ssb0 <- 0.0102562
  recruitment$logit_steep[1]$value <- -log(1.0 - h) + log(h - 0.2)
  recruitment$logit_steep[1]$min <- 0.21
  recruitment$logit_steep[1]$max <- 1.0
  recruitment$logit_steep[1]$estimation_type$set("fixed_effects")
  recruitment$log_rzero[1]$value <- log(r0)
  recruitment$log_rzero[1]$estimation_type$set("fixed_effects")
  rec_parm <- c(-log(1.0 - h) + log(h - 0.2), log(r0))

  CreateTMBModel()
  expect_equal(c(sel_parm, rec_parm), get_fixed())
  clear()
})


## Edge handling ----
# No edge cases to test for this interface.
test_that("get_fixed() returns correct outputs for edge cases", {
  #' @description Test that zero parameters are registered after using clear
  #' even if [CreateTMBModel()] is called.
  clear()
  expect_equal(numeric(0), get_fixed())
  CreateTMBModel()
  expect_equal(numeric(0), get_fixed())
  clear()
})

## Error handling ----
# No error handling to test for this interface.
