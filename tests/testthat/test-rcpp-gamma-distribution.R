# Instructions ----
#' This file follows the format generated by FIMS:::use_testthat_template().
#' Necessary tests include input and output (IO) correctness [IO
#' correctness], edge-case handling [Edge handling], and built-in errors and
#' warnings [Error handling]. See `?FIMS:::use_testthat_template` for more
#' information. Every test should have a @description tag, which can span
#' multiple lines, that will be used in the bookdown report of the results from
#' {testthat}.

# rcpp gamma distribution ----
## Setup ----

# Load or prepare any necessary data for testing
## IO correctness ----
test_that("rcpp_gamma_distribution works with correct inputs", {
  #' @description Test that dgamma works with a single value input,
  #' e.g. a prior on a parameter

  # generate data using R stats::rgamma
  set.seed(123)

  # simulate gamma data with scalar input
  # Using shape=4, scale=2 which gives mean=8, sd=4
  mean_val <- 8
  sd_val <- 4
  shape_val <- (mean_val / sd_val)^2
  scale_val <- (sd_val^2) / mean_val
  
  y <- stats::rgamma(1, shape = shape_val, scale = scale_val)
  
  # create a fims Rcpp object
  # initialize the Dgamma module
  dgamma_ <- methods::new(DgammaDistribution)
  # populate class members
  dgamma_$x[1]$value <- y
  dgamma_$expected_values[1]$value <- mean_val
  dgamma_$log_sd[1]$value <- log(sd_val)
  # evaluate the density and compare with R
  expect_equal(dgamma_$evaluate(), stats::dgamma(y, shape = shape_val, scale = scale_val, log = TRUE))
  clear()

  #' @description Test that dgamma works with a vector of state variables,
  #' but scalar arguments, e.g., a random effect vector

  # simulate gamma data
  y <- stats::rgamma(10, shape = shape_val, scale = scale_val)
  # create a fims Rcpp object
  # initialize the Dgamma module
  dgamma_ <- methods::new(DgammaDistribution)
  # populate class members
  dgamma_$x$resize(length(y))
  purrr::walk(
    seq_along(y),
    \(x) dgamma_$x[x]$value <- y[x]
  )
  dgamma_$expected_values$resize(length(y))
  purrr::walk(
    seq_along(y),
    \(x) dgamma_$expected_values[x]$value <- mean_val
  )
  dgamma_$log_sd[1]$value <- log(sd_val)
  # evaluate the density and compare with R
  expect_equal(dgamma_$evaluate(), sum(stats::dgamma(y, shape = shape_val, scale = scale_val, log = TRUE)))
  clear()

  #' @description Test that dgamma works with vectors of state variables (x)
  #' and arguments, e.g., an index likelihood vector

  # simulate gamma data
  y <- stats::rgamma(10, shape = shape_val, scale = scale_val)
  # create a fims Rcpp object
  # initialize the Dgamma module
  dgamma_ <- methods::new(DgammaDistribution)
  # populate class members
  dgamma_$x$resize(length(y))
  purrr::walk(
    seq_along(y),
    \(x) dgamma_$x[x]$value <- y[x]
  )
  dgamma_$expected_values$resize(length(y))
  purrr::walk(
    seq_along(y),
    \(x) dgamma_$expected_values[x]$value <- mean_val
  )
  dgamma_$log_sd$resize(length(y))
  purrr::walk(
    seq_along(y),
    \(x) dgamma_$log_sd[x]$value <- log(sd_val)
  )
  # evaluate the density and compare with R
  expect_equal(dgamma_$evaluate(), sum(stats::dgamma(y, shape = shape_val, scale = scale_val, log = TRUE)))
  clear()
})

## Edge handling ----

test_that("rcpp_gamma_distribution returns correct outputs for edge cases", {
  set.seed(123)
  
  mean_val <- 8
  sd_val <- 4
  shape_val <- (mean_val / sd_val)^2
  scale_val <- (sd_val^2) / mean_val
  
  #' @description Test extreme observed values for dgamma (0.001, 1000) return expected output.
  y <- 0.001
  # create a fims Rcpp object
  # initialize the Dgamma module
  dgamma_ <- methods::new(DgammaDistribution)
  # populate class members
  dgamma_$x[1]$value <- y
  dgamma_$expected_values[1]$value <- mean_val
  dgamma_$log_sd[1]$value <- log(sd_val)
  # evaluate the density and compare with R
  expect_equal(dgamma_$evaluate(), stats::dgamma(y, shape = shape_val, scale = scale_val, log = TRUE))
  clear()
  
  y <- 1000
  # create a fims Rcpp object
  # initialize the Dgamma module
  dgamma_ <- methods::new(DgammaDistribution)
  # populate class members
  dgamma_$x[1]$value <- y
  dgamma_$expected_values[1]$value <- mean_val
  dgamma_$log_sd[1]$value <- log(sd_val)
  # evaluate the density and compare with R
  expect_equal(dgamma_$evaluate(), stats::dgamma(y, shape = shape_val, scale = scale_val, log = TRUE))
  clear()

  #' @description Test extreme expected values for dgamma (0.1, 1000) return expected output.
  y <- 5
  mean_val <- 0.1
  sd_val <- 0.05
  shape_val <- (mean_val / sd_val)^2
  scale_val <- (sd_val^2) / mean_val
  # create a fims Rcpp object
  # initialize the Dgamma module
  dgamma_ <- methods::new(DgammaDistribution)
  # populate class members
  dgamma_$x[1]$value <- y
  dgamma_$expected_values[1]$value <- mean_val
  dgamma_$log_sd[1]$value <- log(sd_val)
  # evaluate the density and compare with R
  expect_equal(dgamma_$evaluate(), stats::dgamma(y, shape = shape_val, scale = scale_val, log = TRUE))
  clear()
  
  y <- 5
  mean_val <- 1000
  sd_val <- 500
  shape_val <- (mean_val / sd_val)^2
  scale_val <- (sd_val^2) / mean_val
  # create a fims Rcpp object
  # initialize the Dgamma module
  dgamma_ <- methods::new(DgammaDistribution)
  # populate class members
  dgamma_$x[1]$value <- y
  dgamma_$expected_values[1]$value <- mean_val
  dgamma_$log_sd[1]$value <- log(sd_val)
  # evaluate the density and compare with R
  expect_equal(dgamma_$evaluate(), stats::dgamma(y, shape = shape_val, scale = scale_val, log = TRUE))
  clear()

  #' @description Test extreme log_sd values for dgamma (-3, 3) return expected output.
  y <- 5
  mean_val <- 8
  sd_val <- exp(3)
  shape_val <- (mean_val / sd_val)^2
  scale_val <- (sd_val^2) / mean_val
  # create a fims Rcpp object
  # initialize the Dgamma module
  dgamma_ <- methods::new(DgammaDistribution)
  # populate class members
  dgamma_$x[1]$value <- y
  dgamma_$expected_values[1]$value <- mean_val
  dgamma_$log_sd[1]$value <- 3
  # evaluate the density and compare with R
  expect_equal(dgamma_$evaluate(), stats::dgamma(y, shape = shape_val, scale = scale_val, log = TRUE))
  clear()
  
  y <- 5
  mean_val <- 8
  sd_val <- exp(-3)
  shape_val <- (mean_val / sd_val)^2
  scale_val <- (sd_val^2) / mean_val
  # create a fims Rcpp object
  # initialize the Dgamma module
  dgamma_ <- methods::new(DgammaDistribution)
  # populate class members
  dgamma_$x[1]$value <- y
  dgamma_$expected_values[1]$value <- mean_val
  dgamma_$log_sd[1]$value <- -3
  # evaluate the density and compare with R
  expect_equal(dgamma_$evaluate(), stats::dgamma(y, shape = shape_val, scale = scale_val, log = TRUE))
  clear()
  
  #' @description Test that dgamma returns -Inf for negative observed values
  y <- -1
  mean_val <- 8
  sd_val <- 4
  shape_val <- (mean_val / sd_val)^2
  scale_val <- (sd_val^2) / mean_val
  dgamma_ <- methods::new(DgammaDistribution)
  # populate class members
  dgamma_$x[1]$value <- y
  dgamma_$expected_values[1]$value <- mean_val
  dgamma_$log_sd[1]$value <- log(sd_val)
  expect_equal(dgamma_$evaluate(), -Inf)
  clear()
  
  #' @description Test that dgamma returns -Inf for zero observed values
  y <- 0
  dgamma_ <- methods::new(DgammaDistribution)
  # populate class members
  dgamma_$x[1]$value <- y
  dgamma_$expected_values[1]$value <- mean_val
  dgamma_$log_sd[1]$value <- log(sd_val)
  expect_equal(dgamma_$evaluate(), -Inf)
  clear()
})

## Error handling ----
test_that("rcpp gamma distribution returns correct error messages", {
  #' @description dgamma should error out when there is a dimension mismatch
  #' where it is expecting log_sd to have a size 10
  #' but is provided a size 3 vector.
  y <- stats::rgamma(10, shape = 4, scale = 2)
  # create a fims Rcpp object
  # initialize the Dgamma module
  dgamma_ <- methods::new(DgammaDistribution)
  # populate class members
  dgamma_$x$resize(length(y))
  purrr::walk(
    seq_along(y),
    \(x) dgamma_$x[x]$value <- y[x]
  )
  dgamma_$expected_values$resize(length(y))
  purrr::walk(
    seq_along(y),
    \(x) dgamma_$expected_values[x]$value <- 8
  )
  dgamma_$log_sd$resize(3)
  purrr::walk(
    1:3,
    \(x) dgamma_$log_sd[x]$value <- log(4)
  )
  expect_error(
    object = dgamma_$evaluate(),
    regexp = "GammaLPDF::Vector .* out of bounds. .* 10 .* 3"
  )
  clear()
})
