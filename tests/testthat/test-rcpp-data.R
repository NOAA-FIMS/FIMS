# Instructions ----
#' This file follows the format generated by FIMS:::use_testthat_template().
#' Necessary tests include input and output (IO) correctness [IO
#' correctness], edge-case handling [Edge handling], and built-in errors and
#' warnings [Error handling]. See `?FIMS:::use_testthat_template` for more
#' information. Every test should have a @description tag that takes up just
#' one line, which will be used in the bookdown report of {testthat} results.

# rcpp data ----
## Setup ----
fims_frame <- FIMS::FIMSFrame(data1)
n_years <- get_n_years(fims_frame)
n_ages <- get_n_ages(fims_frame)

fleet_names_age_comp <- dplyr::filter(
  .data = as.data.frame(get_data(fims_frame)),
  type == "age"
) |>
  dplyr::distinct(name) |>
  dplyr::pull(name)
n_age_comp <- length(fleet_names_age_comp)

fleet_names_index <- dplyr::filter(
  .data = as.data.frame(get_data(fims_frame)),
  type == "index"
) |>
  dplyr::distinct(name) |>
  dplyr::pull(name)
n_index <- length(fleet_names_index)

## IO correctness ----
test_that("rcpp data() works with correct inputs", {
  #' @description Test that adding index data to a model is possible.
  index_dat <- vector(mode = "list", length = n_index)
  names(index_dat) <- fleet_names_index

  for (index_i in 1:n_index) {
    index <- Index
    index_dat[[fleet_names_index[index_i]]] <- methods::new(index, n_years)
    expect_silent(index_dat[[fleet_names_index[index_i]]] <-
      m_index(fims_frame, fleet_names_index[index_i]))
  }

  clear()

  #' @description Test that adding age-composition data to a model is
  #' possible.
  age_comp_dat <- vector(mode = "list", length = n_age_comp)
  names(age_comp_dat) <- fleet_names_age_comp

  for (fleet_f in 1:n_age_comp) {
    age_comp_dat[[fleet_names_age_comp[fleet_f]]] <- methods::new(AgeComp, n_years, n_ages)
    expect_silent(
      purrr::walk(
        1:(n_years * n_ages),
        \(x) age_comp_dat[[fleet_names_age_comp[fleet_f]]]$age_comp_data$set(x - 1, m_agecomp(fims_frame, fleet_names_age_comp[fleet_f])[x])
      )
    )
  }

  clear()
})

## Edge handling ----
# No edge cases to test.

## Error handling ----
# No built-in errors to test.
