# Instructions ----
#' This file follows the format generated by FIMS:::use_testthat_template().
#' Necessary tests include input and output (IO) correctness [IO
#' correctness], edge-case handling [Edge handling], and built-in errors and
#' warnings [Error handling]. See `?FIMS:::use_testthat_template` for more
#' information. Every test should have a @description tag that takes up just
#' one line, which will be used in the bookdown report of {testthat} results.

# rcpp recruitment interface ----
## Setup ----
# Load or prepare any necessary data for testing
## IO correctness ----
test_that("test_rcpp_recruitment_interface() works with correct inputs", {
  # Create recruitment
  recruitment <- methods::new(BevertonHoltRecruitment)
  h <- 0.75
  r0 <- 1000000.0
  spawns <- 9.55784 * 10^6
  ssb0 <- 0.0102562

  recruitment$logit_steep[1]$value <- -log(1.0 - h) + log(h - 0.2)
  recruitment$logit_steep[1]$min <- 0.21
  recruitment$logit_steep[1]$max <- 1.0
  recruitment$logit_steep[1]$is_random_effect <- TRUE
  recruitment$logit_steep[1]$estimated <- TRUE
  recruitment$log_rzero[1]$value <- log(r0)

  #' @description Test that the recruitment id is 1.
  expect_equal(
    object = recruitment$get_id(),
    expected = 1
  )
  #' @description Test that the logit_steep value is 0.78845736.
  expect_equal(
    object = recruitment$logit_steep[1]$value,
    expected = 0.78845736
  )
  #' @description Test that the logit_steep min is 0.21.
  expect_equal(
    object = recruitment$logit_steep[1]$min,
    expected = 0.21
  )
  #' @description Test that the logit_steep max is 1.0.
  expect_equal(
    object = recruitment$logit_steep[1]$max,
    expected = 1.0
  )
  #' @description Test that the logit_steep is a random effect.
  expect_true(
    object = recruitment$logit_steep[1]$is_random_effect
  )
  #' @description Test that the logit_steep is estimated.
  expect_true(
    object = recruitment$logit_steep[1]$estimated
  )
  #' @description Test that the log_rzero value is log(1000000.0).
  expect_equal(
    object = recruitment$log_rzero[1]$value,
    expected = log(1000000.0)
  )
  #' @description Test that recruitment$evaluate(spawns, ssb0) returns 1090802.68.
  expect_equal(
    object = recruitment$evaluate(spawns, ssb0),
    expected = 1090802.68
  )
  log_devs <- c(-1.0, 2.0, 3.0)
  recruitment$log_devs$resize(length(log_devs))
  purrr::walk(
    seq_along(log_devs),
    \(x) recruitment$log_devs[x]$value <- log_devs[x]
  )
  #' @description Test that the log_devs are set correctly.
  for (i in 1:length(log_devs)) {
    expect_equal(
      object = recruitment$log_devs[i]$value,
      expected = log_devs[i]
    )
  }

  #expected_lpdf <- sum(log(stats::dnorm(log_devs, 0, 0.7)))
  clear()
})

# No edge cases for now.

## Error handling ----
test_that("test_rcpp_recruitment_interface() returns correct error messages", {
  # Create recruitment
  recruitment <- methods::new(BevertonHoltRecruitment)
  h <- 0.75
  r0 <- 1000000.0
  spawns <- 9.55784 * 10^6
  ssb0 <- 0.0102562

  recruitment$logit_steep[1]$value <- 1
  recruitment$logit_steep[1]$min <- 0.21
  recruitment$logit_steep[1]$max <- 1.0
  recruitment$logit_steep[1]$is_random_effect <- TRUE
  recruitment$logit_steep[1]$estimated <- TRUE
  recruitment$log_rzero[1]$value <- log(r0)


  #' @description Test that recruitment errors if logit_steep==1.
  expect_warning(
    object = recruitment$evaluate(spawns, ssb0),
    regexp = "Steepness is subject to a logit transformation. Fixing it at 1.0 is not currently possible."
  )
  clear()
})