# Instructions ----
#' This file follows the format generated by FIMS:::use_testthat_template().
#' Necessary tests include input and output (IO) correctness [IO
#' correctness], edge-case handling [Edge handling], and built-in errors and
#' warnings [Error handling]. See `?FIMS:::use_testthat_template` for more
#' information. Every test should have a @description tag that takes up just
#' one line, which will be used in the bookdown report of {testthat} results.

# Deterministic test ----
## Setup ----
# Load necessary data for the integration test
if (!file.exists(test_path("fixtures", "fit_age_length_comp.RDS"))) {
  prepare_test_data()
}

load(test_path("fixtures", "integration_test_data.RData"))

# Set the iteration ID to 1 for accessing specific input/output list
iter_id <- 1

## IO correctness ----
test_that("deterministic run works with correct inputs", {
  # Load the test data from an RDS file containing the model fit
  deterministic_age_length_comp <- readRDS(test_path("fixtures", "deterministic_age_length_comp.RDS"))

  # Compare FIMS results with model comparison project OM values
  verify_fims_deterministic(
    report = get_report(deterministic_age_length_comp),
    estimates = get_estimates(deterministic_age_length_comp),
    om_input = om_input_list[[iter_id]],
    om_output = om_output_list[[iter_id]],
    em_input = em_input_list[[iter_id]],
    use_fimsfit = TRUE
  )
})

test_that("deterministic run returns correct nlls", {
  # Load the test data from an RDS file containing the model fit
  deterministic_age_length_comp <- readRDS(test_path("fixtures", "deterministic_age_length_comp.RDS"))

  #' Compare FIMS NLLs with model comparison project "true" NLLs
  verify_fims_nll(
    report = get_report(deterministic_age_length_comp),
    om_input = om_input_list[[iter_id]],
    om_output = om_output_list[[iter_id]],
    em_input = em_input_list[[iter_id]]
  )

  test_that("deterministic run results correct number of parameters and random effects", {
    #' @description Veryify the number of parameters are correct
    expect_equal(get_number_of_parameters(deterministic_age_length_comp)["fixed_effects"] |> unname(), 77)
    #' @description Veryify the number of random effects are correct
    expect_equal(get_number_of_parameters(deterministic_age_length_comp)["random_effects"] |> unname(), 0)
  })
})

## Edge handling ----
# No edge cases to test

## Error handling ----
# No built-in errors to test

# Estimation test ----
## Setup ----

## IO correctness ----
test_that("estimation test with age and length comp using wrappers", {
  # Load the test data from an RDS file containing the model fit
  fit_age_length_comp <- readRDS(test_path("fixtures", "fit_age_length_comp.RDS"))

  # Compare FIMS results with model comparison project OM values
  validate_fims(
    report = get_report(fit_age_length_comp),
    estimates = get_estimates(fit_age_length_comp),
    om_input = om_input_list[[iter_id]],
    om_output = om_output_list[[iter_id]],
    em_input = em_input_list[[iter_id]],
    use_fimsfit = TRUE
  )
})

## Edge handling ----
test_that("estimation test with age comp only using wrappers", {
  # Load the test data from an RDS file containing the model fit
  fit_agecomp <- readRDS(test_path("fixtures", "fit_agecomp.RDS"))

  # Compare FIMS results with model comparison project OM values
  validate_fims(
    report = get_report(fit_agecomp),
    estimates = get_estimates(fit_agecomp),
    om_input = om_input_list[[iter_id]],
    om_output = om_output_list[[iter_id]],
    em_input = em_input_list[[iter_id]],
    use_fimsfit = TRUE
  )

  # Load the test data from an RDS file containing the model fit
  fit_agecomp_na <- readRDS(test_path("fixtures", "fit_agecomp_na.RDS"))

  # Compare FIMS results with model comparison project OM values
  validate_fims(
    report = get_report(fit_agecomp_na),
    estimates = get_estimates(fit_agecomp_na),
    om_input = om_input_list[[iter_id]],
    om_output = om_output_list[[iter_id]],
    em_input = em_input_list[[iter_id]],
    use_fimsfit = TRUE
  )
})

test_that("estimation test with length comp only using wrappers", {
  # Load the test data from an RDS file containing the model fit
  fit_lengthcomp <- readRDS(test_path("fixtures", "fit_lengthcomp.RDS"))

  # Compare FIMS results with model comparison project OM values
  validate_fims(
    report = get_report(fit_lengthcomp),
    estimates = get_estimates(fit_lengthcomp),
    om_input = om_input_list[[iter_id]],
    om_output = om_output_list[[iter_id]],
    em_input = em_input_list[[iter_id]],
    use_fimsfit = TRUE
  )

  # Load the test data from an RDS file containing the model fit
  fit_lengthcomp_na <- readRDS(test_path("fixtures", "fit_lengthcomp_na.RDS"))

  # Compare FIMS results with model comparison project OM values
  validate_fims(
    report = get_report(fit_lengthcomp_na),
    estimates = get_estimates(fit_lengthcomp_na),
    om_input = om_input_list[[iter_id]],
    om_output = om_output_list[[iter_id]],
    em_input = em_input_list[[iter_id]],
    use_fimsfit = TRUE
  )
})

test_that("estimation test with age and length comp with NAs", {
  # Load the test data from an RDS file containing the model fit
  fit_age_length_comp_na <- readRDS(test_path("fixtures", "fit_age_length_comp_na.RDS"))

  # Compare FIMS results with model comparison project OM values
  validate_fims(
    report = get_report(fit_age_length_comp_na),
    estimates = get_estimates(fit_age_length_comp_na),
    om_input = om_input_list[[iter_id]],
    om_output = om_output_list[[iter_id]],
    em_input = em_input_list[[iter_id]],
    use_fimsfit = TRUE
  )
})

## Error handling ----
# No built-in errors to test.
