# Instructions ----
#' This file follows the format generated by FIMS:::use_testthat_template().
#' Necessary tests include input and output (IO) correctness [IO
#' correctness], edge-case handling [Edge handling], and built-in errors and
#' warnings [Error handling]. See `?FIMS:::use_testthat_template` for more
#' information. Every test should have a @description tag, which can span
#' multiple lines, that will be used in the bookdown report of the results from
#' {testthat}.

# VonBertalanffyGrowth ----
## Setup ----
fims_frame <- FIMS::FIMSFrame(data1)
on.exit(rm(fims_frame), add = TRUE)

ages <- get_ages(fims_frame)
if (length(ages) == 0 || all(is.na(ages))) {
  reference_age_for_length_1 <- 0
  reference_age_for_length_2 <- get_n_ages(fims_frame) - 1
} else {
  reference_age_for_length_1 <- min(ages, na.rm = TRUE)
  reference_age_for_length_2 <- max(ages, na.rm = TRUE)
}

length_at_ref_age_1 <- 8
length_at_ref_age_2 <- 60
growth_coefficient_K <- 0.2
length_weight_a <- 1e-5
length_weight_b <- 3

vb <- methods::new(VonBertalanffyGrowth)
vb$length_at_ref_age_1$resize(1)
vb$length_at_ref_age_1[1]$value <- length_at_ref_age_1
vb$length_at_ref_age_2$resize(1)
vb$length_at_ref_age_2[1]$value <- length_at_ref_age_2
vb$growth_coefficient_K$resize(1)
vb$growth_coefficient_K[1]$value <- growth_coefficient_K
vb$reference_age_for_length_1$resize(1)
vb$reference_age_for_length_1[1]$value <- reference_age_for_length_1
vb$reference_age_for_length_2$resize(1)
vb$reference_age_for_length_2[1]$value <- reference_age_for_length_2
vb$length_weight_a$resize(1)
vb$length_weight_a[1]$value <- length_weight_a
vb$length_weight_b$resize(1)
vb$length_weight_b[1]$value <- length_weight_b
vb$length_at_age_sd_at_ref_ages$resize(2)
vb$length_at_age_sd_at_ref_ages[1]$value <- 3
vb$length_at_age_sd_at_ref_ages[2]$value <- 7
vb$n_ages$set(get_n_ages(fims_frame))
on.exit(vb, add = TRUE)

## IO correctness ----
test_that("VonBertalanffyGrowth evaluate() works at max age when min age > 0", {
  #' @description Test that VonBertalanffyGrowth evaluate() accepts the
  #' maximum age when ages do not start at zero.
  age <- reference_age_for_length_2
  denom <- 1 - exp(-growth_coefficient_K *
                   (reference_age_for_length_2 -
                      reference_age_for_length_1))
  L <- length_at_ref_age_1 +
    (length_at_ref_age_2 - length_at_ref_age_1) *
    (1 - exp(-growth_coefficient_K *
               (age - reference_age_for_length_1))) / denom
  expected_W <- length_weight_a * L^length_weight_b
  expect_equal(vb$evaluate(age), expected_W)
})

## Edge handling ----
test_that("VonBertalanffyGrowth evaluate() rejects fractional age", {
  #' @description Test that VonBertalanffyGrowth evaluate() rejects
  #' non-integer ages.
  expect_error(vb$evaluate(reference_age_for_length_1 + 0.5),
               "Non-integer age")
})

test_that("VonBertalanffyGrowth evaluate() handles ages below reference range", {
  #' @description Test that VonBertalanffyGrowth evaluate() errors for
  #' negative ages and warns for extrapolation below the reference range.
  if (reference_age_for_length_1 <= 0) {
    expect_error(vb$evaluate(reference_age_for_length_1 - 1),
                 "Negative age")
  } else {
    expect_warning(vb$evaluate(reference_age_for_length_1 - 1),
                   "extrapolating growth curve")
  }
})

test_that("VonBertalanffyGrowth evaluate() warns for ages above reference range", {
  #' @description Test that VonBertalanffyGrowth evaluate() warns for
  #' extrapolation above the reference age range.
  expect_warning(vb$evaluate(reference_age_for_length_2 + 1),
                 "extrapolating growth curve")
})

## Error handling ----
test_that("VonBertalanffyGrowth evaluate() rejects reversed reference ages", {
  #' @description Test that VonBertalanffyGrowth evaluate() rejects
  #' reversed reference ages when more than one age is modeled.
  vb_bad <- methods::new(VonBertalanffyGrowth)
  vb_bad$length_at_ref_age_1$resize(1)
  vb_bad$length_at_ref_age_1[1]$value <- length_at_ref_age_1
  vb_bad$length_at_ref_age_2$resize(1)
  vb_bad$length_at_ref_age_2[1]$value <- length_at_ref_age_2
  vb_bad$growth_coefficient_K$resize(1)
  vb_bad$growth_coefficient_K[1]$value <- growth_coefficient_K
  vb_bad$reference_age_for_length_1$resize(1)
  vb_bad$reference_age_for_length_1[1]$value <-
    reference_age_for_length_2
  vb_bad$reference_age_for_length_2$resize(1)
  vb_bad$reference_age_for_length_2[1]$value <-
    reference_age_for_length_1
  vb_bad$length_weight_a$resize(1)
  vb_bad$length_weight_a[1]$value <- length_weight_a
  vb_bad$length_weight_b$resize(1)
  vb_bad$length_weight_b[1]$value <- length_weight_b
  vb_bad$n_ages$set(get_n_ages(fims_frame))
  expect_error(vb_bad$evaluate(reference_age_for_length_1),
               "reference_age_for_length_2 must be > reference_age_for_length_1")
  clear()
})

test_that("VonBertalanffyGrowth evaluate() errors when parameters are missing", {
  #' @description Test that VonBertalanffyGrowth evaluate() errors when
  #' required parameters are missing.
  vb2 <- methods::new(VonBertalanffyGrowth)
  vb2$n_ages$set(get_n_ages(fims_frame))
  expect_error(vb2$evaluate(reference_age_for_length_1),
               "parameters not set")
  clear()
})
