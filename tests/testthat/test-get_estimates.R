# Instructions ----
#' This file follows the format generated by FIMS:::use_testthat_template().
#' Necessary tests include input and output (IO) correctness [IO
#' correctness], edge-case handling [Edge handling], and built-in errors and
#' warnings [Error handling]. See `?FIMS:::use_testthat_template` for more
#' information. Every test should have a @description tag, which can span
#' multiple lines, that will be used in the bookdown report of the results from
#' {testthat}.

# get_estimates ----
## Setup ----
# Load or prepare any necessary data for testing
if (!file.exists(testthat::test_path("fixtures", "fit_age_length_comp.RDS"))) {
  prepare_test_data()
}

## IO correctness ----
# Define the expected column names for the estimates tibble
expected_colnames <- c(
  "module_name", "module_id", "module_type", "label", "type", "type_id",
  "parameter_id", "fleet", "year_i", "age_i", "length_i",
  "input", "estimated", "expected", "observed",
  "estimation_type", "uncertainty",
  "distribution", "input_type",
  "lpdf", "likelihood", "log_like_cv", "gradient"
)

test_that("`get_estimates()` works with deterministic run", {
  # Read the RDS file containing the deterministic run results
  deterministic_results <- readRDS(testthat::test_path("fixtures", "deterministic_age_length_comp.RDS"))
  deterministic_colnames <- get_estimates(deterministic_results) |> colnames()
  #' @description Test that `get_estimates()` returns correct colnames from a deterministic run.
  expect_equal(
    object = deterministic_colnames,
    expected = expected_colnames
  )

  #' @description Test that the result values from the model fit have not changed from the accepted version.
  expect_snapshot(
    get_estimates(deterministic_results) |>
      # Remove the estimate, uncertainty, and gradient columns, as they
      # may change between runs
      dplyr::select(
        -estimated, -expected, -uncertainty, -gradient,
        -likelihood, -log_like_cv, -gradient
      ) |>
      print(n = 320, width = Inf)
  )
})

test_that("`get_estimates()` works with estimation run", {
  # Load the test data from an RDS file containing model fits.
  # List all RDS files in the fixtures directory that match the pattern "fit*_.RDS"
  fit_files <- list.files(
    path = testthat::test_path("fixtures"),
    pattern = "^fit.*\\.RDS$",
    full.names = TRUE
  )

  # Function to read the RDS file, get estimates, and check column names
  check_estimates_colnames <- function(fit_file) {
    fit_data <- readRDS(fit_file)
    estimates <- get_estimates(fit_data)
    estimates_colnames <- colnames(estimates)

    #' @description Test that `get_estimates()` returns correct colnames from a estimation run.
    expect_equal(
      object = estimates_colnames,
      expected = expected_colnames
    )
  }

  # Use purrr::map to apply the function to each file
  result <- purrr::map(fit_files, check_estimates_colnames)

  #' @description Test that the result values from the model fit have not changed from the accepted version.
  expect_snapshot(
    # Read the first RDS file, get estimates, and print a snapshot
    readRDS(fit_files[[1]]) |>
      get_estimates() |>
      # Remove the estimated, uncertainty, and gradient columns, as they
      # may change between runs
      dplyr::select(
        -estimated, -expected, -uncertainty, -gradient,
        -likelihood, -log_like_cv, -gradient
      ) |>
      print(n = 320, width = Inf)
  )
})

## Edge handling ----
test_that("`get_estimates()` returns correct outputs for edge cases", {
  #' @description Test that an error occurs if the input is not a valid model fit object.
  expect_error(
    object = get_estimates("invalid_fit")
  )
})

## Error handling ----
# No built-in errors to test.
