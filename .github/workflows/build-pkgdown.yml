# Workflow derived from https://github.com/r-lib/actions/tree/master/examples
# Need help debugging build failures? Start at https://github.com/r-lib/actions#where-to-find-help
on:
  workflow_call:
    inputs:
      build_testdown:
        description: 'Generate testdown report?'
        required: false
        type: boolean
        default: false
      build_code_coverage:
        description: 'Generate code coverage report?'
        required: false
        type: boolean
        default: false
      is_main_push:
        type: boolean
        default: false

name: build-pkgdown

# no permissions are needed by the default github token for this workflow to 
# run, so don't pass any.
# https://docs.github.com/en/actions/writing-workflows/choosing-what-your-workflow-does/controlling-permissions-for-github_token
permissions:
  contents: write

# Cancel runs happening simultaneously on the same branch.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  pkgdown:
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v6
      
      - uses: r-lib/actions/setup-pandoc@v2

      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: any::pkgdown, local::.
          needs: website

      - name: build pkgdown
        env:
          # Pass GHA inputs to the R script as environment variables
          INPUT_TESTDOWN: ${{ inputs.build_testdown }}
          INPUT_CODE_COVERAGE: ${{ inputs.build_code_coverage }}
        run: |
          reports_to_build <- c()
          # Check the environment variables passed from the 'env' block above
          # Note: GHA boolean inputs are passed as strings 'true' or 'false'
          if (Sys.getenv("INPUT_TESTDOWN") == 'true') {
            reports_to_build <- c(reports_to_build, "testdown")
          }

          if (Sys.getenv("INPUT_CODE_COVERAGE") == 'true') {
            reports_to_build <- c(reports_to_build, "coverage")
          }
          
          # Only run the function if there's at least one report to build
          if (length(reports_to_build) > 0) {
            lozen::build_pkgdown_with_reports(
              pkg = ".",
              pkgdown_path = "docs",
              assets_path = "pkgdown/assets",
              reports = reports_to_build
            )
          } else {
            # Fallback to building a standard site if no reports are selected
            pkgdown::build_site(
              override = list(destination = "docs")
            )
          }
        shell: Rscript {0}
     
      - name: save pkgdown output
        uses: actions/upload-artifact@v6
        with:
          name: pkgdown-site-with-reports
          path: docs/
  
      - name: Deploy package
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # This is the folder we built in the "build pkgdown" step
          publish_dir: ./docs
     