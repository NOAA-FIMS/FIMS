# Run doxygen to generate documentation from C++ code, which is the equivalent
# of roxygen documentation in the R code. After building the html files, if the
# action is being ran on main, the files are moved to the appropriate location
# and pushed to NOAA-FIMS/FIMS-docs@main.
name: run-doxygen

on:
  pull_request:
  push:
    branches: 
      - dev
      - main
  # schedule: 
  #   - cron: '0 16 * * *' 
  workflow_dispatch:
  # below is a trigger for when there are changes to the fims website, it pulls
  # the bootstrap file name from there which occasionally changes
  # file in that repo, which change whenever a significant change is made to
  # the website for some reason 
  repository_dispatch:
    types: [file-updated]

jobs:
  build-doxygen:
    name: Build HTML documentation from C++ code
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

    steps:
    - name: Get repository
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Checkout External Docs Repository (Source of bootstrap CSS)
      uses: actions/checkout@v6
      with:
        repository: NOAA-FIMS/noaa-fims.github.io
        path: external-docs

    - name: Installing build dependencies
      run: |
        sudo apt update
        sudo apt install cmake doxygen gcc git ninja-build

    - name: Update Bootstrap CSS Link in header.html
      run: |
        DOCS_PATH="external-docs/docs/site_libs/bootstrap"

        # 1. Find the name of the new bootstrap CSS file (not the dark one).
        # We use a negative lookahead regex (.*) to explicitly exclude filenames
        # containing '-dark-'.
        BOOTSTRAP_FILE=$(ls $DOCS_PATH | grep '^bootstrap-[0-9a-f]\+\.min\.css$' | grep -v 'dark' | head -n 1)
        
        # Check if the file name was found
        if [ -z "$BOOTSTRAP_FILE" ]; then
          echo "ERROR: Could not find bootstrap CSS file in external repository: $DOCS_PATH"
          exit 1
        fi
        
        echo "Found new bootstrap CSS file: $BOOTSTRAP_FILE"

        # Copy header.html from assets to root so it can be modified before Doxygen runs
        cp assets/header.html ./

        # 2. Use sed to replace the old hard-coded path with the dynamic file name
        HEADER_PATH="header.html" 
        
        # Get the old filename from the existing header.html content to use in sed
        # We need to find the filename currently embedded in the header.html
        OLD_FILENAME=$(grep -oE 'bootstrap-[0-9a-f]+\.min\.css' $HEADER_PATH | head -n 1)

        # Safety check: if we can't find the old filename, something is wrong
        if [ -z "$OLD_FILENAME" ]; then
          echo "ERROR: Could not find old hard-coded bootstrap filename in $HEADER_PATH."
          exit 1
        fi

        # Perform the substitution in-place on header.html
        # We need to escape the '/' characters in the URL for sed.
        sed -i "s/${OLD_FILENAME}/${BOOTSTRAP_FILE}/g" $HEADER_PATH
        
        echo "$HEADER_PATH updated successfully from $OLD_FILENAME to $BOOTSTRAP_FILE."

        if [ "$OLD_FILENAME" != "$BOOTSTRAP_FILE" ]; then
          echo "Detected change in bootstrap file hash. Updating assets/header.html."
          cp "$HEADER_PATH" assets/header.html
        else
          echo "Bootstrap file hash did not change. assets/header.html remains current."
        fi

    - name: Building HTML documentation with Doxygen
    # Do not run -DDOXYGEN_WARN_AS_ERROR=YES locally
    # FIX? run cmake --build build --parallel 16
      run: |
        cp -r assets/* ./
        cmake -S . -B build -G Ninja -DDOXYGEN_WARN_AS_ERROR=FAIL_ON_WARNINGS
        cmake --build build
    
    - name: Deploy html documentation with Doxygen
    # Do not run mkdir doxygen and mv build/html doxygen locally
      if: ${{ github.ref == 'refs/heads/main' }}
      run: |
        mv build/html ./
        mkdir -p ./doxygen
        rm -rf ./doxygen/*
        mv ./html/* ./doxygen/
        mv FIMS_hexlogo.png ./doxygen/
        rm custom.css
        rm doxygen-awesome.css
        rm FIMS_logo3.png
        rm header.html
        rm DoxygenLayout.xml

    - name: Push doxygen html files to FIMS website repo
      if: ${{ github.ref == 'refs/heads/main' }}
      uses: dmnemec/copy_file_to_another_repo_action@main
      env:
        API_TOKEN_GITHUB: ${{ secrets.API_TOKEN_GITHUB }}
      with:
        source_file: 'doxygen/*'
        destination_repo: 'NOAA-FIMS/noaa-fims.github.io'
        destination_folder: 'doxygen'
        destination_branch: 'main'
        user_email: 'kelli.johnson@noaa.gov' # your email
        user_name: 'Kelli Johnson'           # your login
        commit_message: 'Docs: run Doxygen'    
