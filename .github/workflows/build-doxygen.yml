# Run doxygen to generate documentation from C++ code, which is the equivalent
# of roxygen documentation in the R code. After building the html files, if the
# action is being ran on main, the files are moved to the appropriate location
# and pushed to NOAA-FIMS/FIMS-docs@main.
name: run-doxygen

on:
  pull_request:
  push:
    branches:
      - dev
      - main
  workflow_dispatch:
  # below is a trigger for when there are changes to the fims website, it pulls
  # the bootstrap file name from there which occasionally changes
  # file in that repo, which change whenever a significant change is made to
  # the website for some reason
  repository_dispatch:
    types: [file-updated]

jobs:
  build-doxygen:
    name: Build HTML documentation from C++ code
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

    steps:
    - name: Get repository
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Checkout External Docs Repository (Source of bootstrap CSS)
      uses: actions/checkout@v6
      with:
        repository: noaa-fims/noaa-fims.github.io
        ref: gh-pages
        path: external-docs

    - name: Installing build dependencies
      run: |
        sudo apt-get update && sudo apt-get install -y coreutils grep findutils
        sudo apt install cmake doxygen gcc git ninja-build

    - name: Update Bootstrap CSS Links in header.html
      run: |
        DOCS_PATH="external-docs/site_libs/bootstrap"

        # 1) Find latest light + dark bootstrap css filenames in the external repo
        BOOTSTRAP_LIGHT=$(ls "$DOCS_PATH" | grep -E '^bootstrap-[0-9a-f]+\.min\.css$' | grep -v 'dark' | head -n 1)
        BOOTSTRAP_DARK=$(ls "$DOCS_PATH" | grep -E '^bootstrap-dark-[0-9a-f]+\.min\.css$' | head -n 1)

        if [ -z "$BOOTSTRAP_LIGHT" ] || [ -z "$BOOTSTRAP_DARK" ]; then
          echo "ERROR: Could not find both light and dark bootstrap CSS files in: $DOCS_PATH"
          echo "Found light: '$BOOTSTRAP_LIGHT'"
          echo "Found dark:  '$BOOTSTRAP_DARK'"
          exit 1
        fi

        # Copy header.html from assets to root so it can be modified before Doxygen runs
        cp assets/header.html ./
        HEADER_PATH="header.html"

        # 2) Extract OLD filenames currently present in header.html
        OLD_LIGHT=$(grep -oE 'bootstrap-[0-9a-f]+\.min\.css' "$HEADER_PATH" | grep -v 'dark' | head -n 1)
        OLD_DARK=$(grep -oE 'bootstrap-dark-[0-9a-f]+\.min\.css' "$HEADER_PATH" | head -n 1)

        if [ -z "$OLD_LIGHT" ] || [ -z "$OLD_DARK" ]; then
          echo "ERROR: Could not find old hard-coded bootstrap filenames in $HEADER_PATH"
          echo "Old light: '$OLD_LIGHT'"
          echo "Old dark:  '$OLD_DARK'"
          exit 1
        fi

        # 3) Replace both (do them separately to avoid accidental cross-matching)
        sed -i "s/${OLD_LIGHT}/${BOOTSTRAP_LIGHT}/g" "$HEADER_PATH"
        sed -i "s/${OLD_DARK}/${BOOTSTRAP_DARK}/g" "$HEADER_PATH"

        echo "$HEADER_PATH updated successfully:"

        # 4) Copy back only if something changed (optional, but keeps commits clean)
        if [ "$OLD_LIGHT" != "$BOOTSTRAP_LIGHT" ] || [ "$OLD_DARK" != "$BOOTSTRAP_DARK" ]; then
          echo "Detected change in bootstrap file hash(es). Updating assets/header.html."
          cp "$HEADER_PATH" assets/header.html
        else
          echo "Bootstrap file hashes did not change. assets/header.html remains current."
        fi

    - name: Building HTML documentation with Doxygen
      # Do not run -DDOXYGEN_WARN_AS_ERROR=YES locally
      # FIX? run cmake --build build --parallel 16
      run: |
        cp -r assets/* ./
        cmake -S . -B build -G Ninja -DDOXYGEN_WARN_AS_ERROR=FAIL_ON_WARNINGS
        cmake --build build

    - name: Deploy html documentation with Doxygen
      # Do not run mkdir doxygen and mv build/html doxygen locally
      if: ${{ github.ref == 'refs/heads/main' }}
      run: |
        mv build/html ./
        mkdir -p ./doxygen
        rm -rf ./doxygen/*
        mv ./html/* ./doxygen/
        mv FIMS_hexlogo.png ./doxygen/
        rm custom.css
        rm doxygen-awesome.css
        rm FIMS_logo3.png
        rm header.html
        rm DoxygenLayout.xml

    - name: Push doxygen html files to FIMS website repo
      if: ${{ github.ref == 'refs/heads/main' }}
      uses: dmnemec/copy_file_to_another_repo_action@main
      env:
        API_TOKEN_GITHUB: ${{ secrets.API_TOKEN_GITHUB }}
      with:
        source_file: 'doxygen'
        destination_repo: 'noaa-fims/noaa-fims.github.io'
        destination_folder: './'
        destination_branch: 'main'
        user_email: 'kelli.johnson@noaa.gov' # your email
        user_name: 'Kelli Johnson'           # your login
        commit_message: 'Docs: run Doxygen'
